<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <!-- SEO Meta Tags (Updated) -->
    <title>Green Screen Vault - Free Overlays, Memes & Clips</title>
    <meta name="description" content="Discover thousands of free green screen overlays, effects, transitions, meme templates, and video clips. Perfect for YouTube, streaming (OBS), social media (TikTok/Reels), and film projects. Download CC0 chroma key footage instantly. Upload your own!"/>
    <meta name="keywords" content="green screen, chroma key, video overlay, free download, video effects, transitions, stock footage, video clips, meme template, green screen download, video editing assets, content creator resources, premiere pro, after effects, final cut pro, davinci resolve, obs studio, streamlabs, tiktok, reels, youtube shorts, cc0 license, public domain video, free green screen memes, chroma key memes, green screen effects download, free video assets, motion graphics elements"/>
    <meta name="robots" content="index, follow">
    <!-- Add Open Graph and Twitter Card meta tags here for social sharing -->
    <meta property="og:title" content="Green Screen Vault - Free Overlays, Memes & Clips">
    <meta property="og:description" content="Download thousands of free CC0 green screen videos, effects, and meme templates.">
    <!-- <meta property="og:image" content="[URL to a preview image]"> -->
    <!-- <meta name="twitter:card" content="summary_large_image"> -->

    <!-- Google Site Verification -->
    <meta name="google-site-verification" content="KW9LITbigX2kYkD1Pt-ShwyWVkKL24BSvGMcRAR33L4" />

    <!-- Cloudinary Script -->
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5641687897051414"
         crossorigin="anonymous"></script>

    <style>
        /* --- Base & Theme Styles --- */
        body { font-family: 'Roboto', sans-serif; transition: background 0.5s ease, color 0.5s ease; line-height: 1.6; overflow-x: hidden; } /* Prevent horizontal scroll */
        html[data-theme="dark"] body { background: #0a0a0a; color: #e5e7eb; }
        html[data-theme="light"] body { background: #f8f9fa; color: #212529; }

        /* --- Header --- */
        .header {
            background: linear-gradient(90deg, #00ff88, #00ccff); color: black;
            padding: 1rem 1rem; text-align: center; font-size: 1.8rem; font-weight: bold;
            position: relative; box-shadow: 0 4px 10px rgba(0, 255, 136, 0.3);
            z-index: 40; display: flex; align-items: center; justify-content: center;
        }
        .header h1 { animation: fadeInDown 1s ease-in-out; font-family: 'Orbitron', sans-serif; letter-spacing: 1px; margin: 0; flex-grow: 1; text-align: center; }
        /* Container to position buttons relative to header edges */
        .header-buttons-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; pointer-events: none; }
        .header-buttons { display: flex; gap: 0.5rem; pointer-events: auto; } /* Allow clicking buttons */
        .header-btn { background: rgba(0, 0, 0, 0.5); color: white; border: 1px solid rgba(255, 255, 255, 0.5); padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s, transform 0.2s; display: flex; align-items: center; gap: 0.3rem; position: relative; z-index: 41; /* Ensure buttons are clickable */ overflow: hidden; /* Needed for theme icon animation */ }
        .header-btn:hover { background: rgba(0, 0, 0, 0.7); transform: scale(1.05); }
        html[data-theme="light"] .header-btn { background: rgba(255, 255, 255, 0.7); color: black; border-color: rgba(0, 0, 0, 0.2); }
        html[data-theme="light"] .header-btn:hover { background: rgba(255, 255, 255, 0.9); }
        /* Header Icon Animation */
        .header-btn i { transition: transform 0.2s ease-in-out; display: inline-block; /* Needed for transform */}
        .header-btn:hover i { transform: scale(1.15) rotate(-5deg); }

        /* Responsive Header Adjustments */
        @media (min-width: 640px) {
            .header { font-size: 2.5rem; padding: 1.5rem 1rem; }
            .header-buttons-container { padding: 0 1.5rem; }
        }
        @media (max-width: 639px) {
            /* Hide text span on small screens */
            .header-btn span.button-text { display: none; }
            /* Adjust padding for icon-only button */
            .header-btn { padding: 0.5rem; }
            .header h1 { font-size: 1.5rem; }
            .header { padding: 1rem 0.5rem; }
            .header-buttons-container { padding: 0 0.5rem; }
        }

        /* --- Sun/Moon Theme Toggle Animation --- */
        .theme-icon { position: absolute; top: -25px; /* Start above button */ left: 50%; transform: translateX(-50%); font-size: 1.5rem; transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.6s ease; opacity: 0; pointer-events: none; z-index: 40; /* Ensure below button content */ }
        #sunIcon { color: #ffcc00; }
        #moonIcon { color: #f0e68c; }
        /* Position icons inside the button context - adjust Y offset */
        /* Moon appears from top when switching TO dark */
        html:not([data-theme="light"]) #moonIcon { transform: translate(-50%, 40px); opacity: 1; } /* Moves down into view */
        html:not([data-theme="light"]) #sunIcon { transform: translate(-50%, 80px); opacity: 0; } /* Moves further down out of view */
        /* Sun appears from top when switching TO light */
        html[data-theme="light"] #sunIcon { transform: translate(-50%, 40px); opacity: 1; } /* Moves down into view */
        html[data-theme="light"] #moonIcon { transform: translate(-50%, 80px); opacity: 0; } /* Moves further down out of view */


        /* --- Gallery & Cards --- */
        .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; padding: 1.5rem; }
        .card { background: #1f1f1f; border-radius: 1rem; overflow: hidden; border: 1px solid #333; box-shadow: 0 4px 15px rgba(0, 255, 136, 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease, opacity 0.4s ease, height 0.4s ease, margin 0.4s ease, padding 0.4s ease, border-width 0.4s ease; animation: fadeInUp 0.5s ease-in-out both; position: relative; display: flex; flex-direction: column; }
        html[data-theme="light"] .card { background: #ffffff; color: black; border-color: #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-6px) scale(1.03); box-shadow: 0 10px 30px rgba(0, 255, 136, 0.28); border-color: #00ff88; }
        html[data-theme="light"] .card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.12); border-color: #10b981; }
        .video-container { cursor: pointer; position: relative; background-color: #050505; overflow: hidden; border-radius: 1rem 1rem 0 0; }
        .video-container video { width: 100%; height: auto; aspect-ratio: 16 / 9; object-fit: cover; display: block; }
        .video-container::after { content: '\f04b'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; color: rgba(255, 255, 255, 0.8); opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .video-container:hover::after { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        /* Hide play icon when video IS playing (container has 'playing' class) */
        .video-container.playing::after { opacity: 0 !important; }
        .card-content { padding: 1rem; flex-grow: 1; }
        .card-title { font-weight: bold; margin-bottom: 0.25rem; line-height: 1.3; height: 2.6em; overflow: hidden; font-size: 1rem; word-break: break-all; /* Prevent long titles breaking layout */ }
        /* Container for uploader name and download count */
        .meta-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.8rem; gap: 0.5rem; }
        .uploader-name { opacity: 0.8; color: #bbb; text-align: right; flex-grow: 1; /* Allow uploader name to take space */ } /* Keep alignment */
        html[data-theme="light"] .uploader-name { opacity: 0.9; color: #555; }
        /* Download Count Style */
        .download-count { font-size: 0.75rem; color: #888; display: flex; align-items: center; gap: 0.2rem; flex-shrink: 0; /* Prevent shrinking */ }
        html[data-theme="light"] .download-count { color: #666; }
        .download-count i { font-size: 0.7rem; animation: icon-pulse 2.5s infinite ease-in-out; display: inline-block; }
        .card-footer { padding: 0 1rem 1rem; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; border-top: 1px solid #333; margin-top: auto; }
        html[data-theme="light"] .card-footer { border-top-color: #e2e8f0; }

        .download-btn { background: #00ff88; color: black; padding: 0.5rem 1rem; text-align: center; font-weight: bold; display: inline-flex; align-items: center; gap: 0.4rem; border-radius: 0.5rem; font-size: 0.85rem; line-height: 1; transition: background-color 0.2s ease, transform 0.2s ease; }
        .download-btn:hover { background-color: #00e67a; transform: scale(1.05); }
        .download-btn i { transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55); display: inline-block; }
        .download-btn:hover i { transform: translateY(-2px) scale(1.1); } /* Bounce effect */
        html[data-theme="light"] .download-btn { background: #10b981; color: white; }
        html[data-theme="light"] .download-btn:hover { background: #0f9e73; }
        .menu-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid #555; border-radius: 50%; width: 32px; height: 32px; font-weight: bold; cursor: pointer; line-height: 1; color: #aaa; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s, color 0.2s, border-color 0.2s, transform 0.3s ease; } /* Longer transform transition */
        html[data-theme="light"] .menu-btn { background: rgba(0, 0, 0, 0.05); border-color: #ccc; color: #555; }
        .menu-btn i { transition: transform 0.3s ease; display: inline-block; }
        .menu-btn:hover { background: rgba(0, 255, 136, 0.3); color: white; border-color: #00ff88; transform: scale(1.1); } /* Keep scale, remove rotate from button */
        .menu-btn:hover i { transform: rotate(90deg); } /* Rotate icon only */
        html[data-theme="light"] .menu-btn:hover { background: rgba(16, 185, 129, 0.2); color: #10b981; border-color: #10b981; }

        /* --- Action Popup --- */
        .action-popup { display: none; position: absolute; bottom: 45px; right: 5px; background-color: #2a2a2a; border: 1px solid #444; border-radius: 8px; padding: 0.5rem; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4); z-index: 50; animation: popUpFadeIn 0.2s ease-out; min-width: 130px; }
        html[data-theme="light"] .action-popup { background-color: #ffffff; border-color: #ccc; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); }
        .action-popup button { display: flex; align-items: center; gap: 0.5rem; width: 100%; background: none; border: none; color: #00ccff; padding: 0.6rem 0.8rem; text-align: left; cursor: pointer; border-radius: 4px; font-size: 0.9rem; transition: background-color 0.15s, color 0.15s; }
        .action-popup button i { transition: transform 0.2s ease-out; display: inline-block; width: 1rem; /* Ensure consistent icon alignment */ text-align: center; }
        .action-popup button:hover i { transform: scale(1.1) rotate(-3deg); } /* Icon wiggle */
        html[data-theme="light"] .action-popup button { color: #0c4a6e; }
        .action-popup button:hover { background-color: #3a3a3a; }
        html[data-theme="light"] .action-popup button:hover { background-color: #e5e7eb; }
        .action-popup button.delete-action { color: #ff5555; }
        html[data-theme="light"] .action-popup button.delete-action { color: #dc2626; }
        .action-popup button.delete-action:hover { background-color: rgba(255, 85, 85, 0.1); }
        html[data-theme="light"] .action-popup button.delete-action:hover { background-color: #fee2e2; }

        /* --- Modal Styles --- */
        .modal-backdrop { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 50; animation: fadeIn 0.4s ease-out; backdrop-filter: blur(5px); }
        /* New Modal Animation */
        @keyframes weirdModalPopIn {
          0% { opacity: 0; transform: translateY(50px) scale(0.8) skewX(-10deg); }
          60% { opacity: 1; transform: translateY(-10px) scale(1.05) skewX(5deg); }
          80% { transform: translateY(5px) scale(0.98) skewX(-2deg); }
          100% { opacity: 1; transform: translateY(0) scale(1) skewX(0deg); }
        }
        /* Fade out animation for modal close */
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .modal-backdrop.modal-fade-out { animation: fadeOut 0.3s ease-out forwards; /* Apply fade out to backdrop */}
        .modal-backdrop.modal-fade-out .modal-box {
            animation: fadeOut 0.3s ease-out forwards; /* Apply simple fade out to box on close */
        }

        .modal-box {
            background-color: #1f1f1f; color: white; padding: 1.5rem; border-radius: 1rem;
            border: 1px solid #444; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            width: 90%; max-width: 500px;
            animation: weirdModalPopIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            position: relative; max-height: 85vh; overflow-y: auto;
        }
        html[data-theme="light"] .modal-box { background-color: #ffffff; color: black; border-color: #ccc; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15); }
        @media (min-width: 640px) { .modal-box { padding: 2rem; } }
        .modal-box h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #00ff88; text-align: center; }
        .modal-box h2 i { animation: icon-pulse 2s infinite ease-in-out; margin-right: 0.5rem; display: inline-block; } /* Animate icon in modal title */
        html[data-theme="light"] .modal-box h2 { color: #10b981; }
        .modal-box label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: bold; color: #ccc; }
        html[data-theme="light"] .modal-box label { color: #555; }
        .modal-box input[type="text"], .modal-box input[type="password"], .modal-box textarea { width: 100%; padding: 0.8rem; border-radius: 0.5rem; background-color: #333; border: 1px solid #555; color: white; margin-bottom: 1rem; transition: border-color 0.2s, box-shadow 0.2s; font-size: 0.95rem; }
        .modal-box input:focus, .modal-box textarea:focus { outline: none; border-color: #00ff88; box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.4); }
        html[data-theme="light"] .modal-box input[type="text"], html[data-theme="light"] .modal-box input[type="password"], html[data-theme="light"] .modal-box textarea { background-color: #e5e7eb; border-color: #ccc; color: black; }
        html[data-theme="light"] .modal-box input:focus, html[data-theme="light"] .modal-box textarea:focus { border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3); }
        .modal-buttons { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; }
        .modal-buttons button { font-size: 0.9rem; padding: 0.7rem 1.2rem; border-radius: 0.5rem; border: none; cursor: pointer; font-weight: bold; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .modal-buttons button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .modal-buttons button i { transition: transform 0.2s ease; display: inline-block; }
        .modal-buttons button:hover i { transform: scale(1.1); }
        .modal-button-confirm { background-color: #00ff88; color: black; }
        .modal-button-confirm:hover { background-color: #00dd77; }
        html[data-theme="light"] .modal-button-confirm { background-color: #10b981; color: white; }
        html[data-theme="light"] .modal-button-confirm:hover { background-color: #0f9e73; }
        .modal-button-cancel { background-color: #555; color: white; }
        .modal-button-cancel:hover { background-color: #666; }
        html[data-theme="light"] .modal-button-cancel { background-color: #a1a1aa; color: black; }
        html[data-theme="light"] .modal-button-cancel:hover { background-color: #71717a; }
        .modal-button-delete { background-color: #ff4444; color: white; }
        .modal-button-delete:hover { background-color: #dd2222; }
        html[data-theme="light"] .modal-button-delete { background-color: #dc2626; color: white; }
        html[data-theme="light"] .modal-button-delete:hover { background-color: #b91c1c; }
        .modal-error { color: #ff5555; font-size: 0.85rem; margin-top: -0.5rem; margin-bottom: 1rem; min-height: 1.2em; text-align: center; display: block; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: rgba(255,255,255,0.1); border: none; font-size: 1.5rem; color: #aaa; cursor: pointer; line-height: 1; z-index: 51; padding: 0.1rem 0.5rem; border-radius: 50%; transition: background-color 0.2s, color 0.2s, transform 0.2s; }
        html[data-theme="light"] .modal-close-btn { background: rgba(0,0,0,0.05); color: #777; }
        .modal-close-btn:hover { background: rgba(255,255,255,0.2); color: #fff; transform: scale(1.1) rotate(90deg); }
        html[data-theme="light"] .modal-close-btn:hover { background: rgba(0,0,0,0.1); color: #000; }

        /* --- Terms Modal Specific Styles --- */
        #termsModal .modal-box { max-width: 700px; }
        .terms-content { font-size: 0.9rem; line-height: 1.6; max-height: 60vh; overflow-y: auto; border: 1px solid #444; padding: 1rem 1.5rem; border-radius: 0.5rem; margin-bottom: 1rem; background-color: rgba(0,0,0,0.15); }
        html[data-theme="light"] .terms-content { border-color: #ccc; background-color: rgba(0,0,0,0.03); }
        .terms-content h3 { font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; color: #00ccff; }
        html[data-theme="light"] .terms-content h3 { color: #0ea5e9; }
        .terms-accept-label { display: flex; align-items: center; margin-top: 1rem; cursor: pointer; font-size: 0.9rem; }
        html[data-theme="dark"] .terms-accept-label { color: #ccc; }
        html[data-theme="light"] .terms-accept-label { color: #333; }
        .terms-accept-label input { margin-right: 0.75rem; width: 1rem; height: 1rem; accent-color: #00ff88; transform: scale(1.1); cursor: pointer;} /* Slightly larger checkbox */
        html[data-theme="light"] .terms-accept-label input { accent-color: #10b981; }

        /* --- Filters & Search --- */
        .filter-search-area { padding: 1.5rem; background-color: rgba(0,0,0,0.15); border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 30; backdrop-filter: blur(3px); } /* Lowered z-index */
        html[data-theme="light"] .filter-search-area { background-color: rgba(255,255,255,0.7); border-bottom-color: #e2e8f0; backdrop-filter: blur(5px); }
        .filter-options { display: flex; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        /* Filter Button styles managed dynamically in JS by setActiveFilterButton() */
        .filter-btn { padding: 0.5rem 1rem; margin: 0; text-align: center; font-weight: bold; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; font-size: 0.85rem; }
        .filter-btn:hover:not(.active-filter) { transform: translateY(-2px); /* Hover only if not active */ }
        .filter-btn.active-filter { transform: translateY(-1px); }
        .search-container { display: flex; justify-content: center; align-items: center; max-width: 400px; margin: 0 auto; position: relative; }
        .search-container label { display: none; }
        .search-container input { flex-grow: 1; padding: 0.7rem 1rem 0.7rem 2.5rem; border-radius: 1rem; background-color: #333; border: 1px solid #555; color: white; transition: border-color 0.2s, box-shadow 0.2s; }
        .search-container::before { content: '\f002'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #888; font-size: 0.9rem; transition: color 0.2s, transform 0.2s; pointer-events: none;} /* Added pointer-events */
        html[data-theme="light"] .search-container::before { color: #777; }
        /* Icon glow on input focus - using adjacent sibling or focus-within if needed */
        .search-container input:focus + label + ::before, /* If label exists */
        .search-container:focus-within::before /* More reliable */ {
             color: #00ccff; transform: translateY(-50%) scale(1.1);
        }
        html[data-theme="light"] .search-container:focus-within::before { color: #38bdf8; }
        .search-container input:focus { outline: none; border-color: #00ccff; box-shadow: 0 0 0 3px rgba(0, 204, 255, 0.3); }
        html[data-theme="light"] .search-container input:focus { border-color: #38bdf8; box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.3); }
        html[data-theme="light"] .search-container input { background-color: #e5e7eb; border-color: #ccc; color: black; }


        /* --- Intro Screen --- */
        @keyframes animated-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        #introScreen { position: fixed; inset: 0; background: linear-gradient(135deg, #001a11, #002030, #001a11); background-size: 300% 300%; animation: animated-gradient 15s ease infinite; display: flex; align-items: center; justify-content: center; z-index: 100; color: white; font-family: 'Orbitron', sans-serif; opacity: 1; transition: opacity 1.2s ease-out 0.5s, visibility 0s linear 1.7s; pointer-events: auto; visibility: visible; overflow: hidden; }
        #introScreen.fade-out { opacity: 0; pointer-events: none; visibility: hidden; }
        @keyframes textPopInGlowRefined { 0% { opacity: 0; transform: scale(0.5) translateY(50px); text-shadow: 0 0 5px rgba(0, 255, 136, 0.5); filter: blur(3px); } 60% { opacity: 1; transform: scale(1.1) translateY(0); text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88, 0 0 30px #00ccff, 0 0 40px #00ccff; filter: blur(0); } 100% { opacity: 1; transform: scale(1) translateY(0); text-shadow: 0 0 8px #00ff88, 0 0 15px #00ccff; filter: blur(0); } }
        #introText { font-size: 2.5rem; font-weight: bold; letter-spacing: 2px; opacity: 0; animation: textPopInGlowRefined 2.2s cubic-bezier(0.25, 0.46, 0.45, 0.94) 0.2s forwards; }
        @media (min-width: 640px) { #introText { font-size: 3.8rem; } }
        @media (max-width: 480px) { #introText { font-size: 1.8rem; } }

        /* --- Load More Button --- */
        #loadMoreBtn { display: block; margin: 2.5rem auto; padding: 0.8rem 2.5rem; font-weight: bold; cursor: pointer; border-radius: 0.5rem; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s, opacity 0.2s; font-size: 0.9rem; background: #00ccff; color: black; border: none; text-transform: uppercase; letter-spacing: 0.5px; }
        html[data-theme="light"] #loadMoreBtn { background: #38bdf8; color: white; }
        #loadMoreBtn:hover:not(:disabled) { transform: translateY(-3px) scale(1.03); box-shadow: 0 5px 10px rgba(0, 204, 255, 0.3); }
        html[data-theme="dark"] #loadMoreBtn:hover:not(:disabled) { background-color: #00ddff; }
        html[data-theme="light"] #loadMoreBtn:hover:not(:disabled) { background-color: #0ea5e9; box-shadow: 0 5px 10px rgba(56, 189, 248, 0.3); }
        #loadMoreBtn:disabled { background: #555; cursor: not-allowed; transform: none; opacity: 0.6; box-shadow: none; }
        html[data-theme="light"] #loadMoreBtn:disabled { background: #a1a1aa; }
        #loadMoreBtn .fa-spinner { animation: spin 1s linear infinite; display: inline-block; margin-right: 0.5rem; } /* Ensure spinner spins and has space */

        /* --- Info Section --- */
        .info-section { padding: 3rem 1.5rem; text-align: center; border-top: 1px solid #222; margin-top: 2rem; }
        html[data-theme="light"] .info-section { border-top-color: #eee; }
        .info-section h2 { font-size: 2rem; font-weight: bold; margin-bottom: 1rem; color: #00ff88; font-family: 'Orbitron', sans-serif; }
        html[data-theme="light"] .info-section h2 { color: #10b981; }
        .info-section h3 { font-size: 1.4rem; font-weight: bold; margin-top: 2.5rem; margin-bottom: 1rem; color: #00ccff; }
        html[data-theme="light"] .info-section h3 { color: #0ea5e9; }
        .info-section h3 i { display: inline-block; transition: transform 0.3s ease; } /* Enable icon animation */
        .info-section h3:hover i { transform: scale(1.15) rotate(-5deg); }
        .info-section p, .info-section ol { max-w-3xl mx-auto mb-4 text-base leading-relaxed; }
        html[data-theme="dark"] .info-section p, html[data-theme="dark"] .info-section ol { color: #bbb; }
        html[data-theme="light"] .info-section p, html[data-theme="light"] .info-section ol { color: #4b5563; }
        .info-section ol { text-align: left; padding-left: 1.5rem; list-style-position: inside; list-style-type: decimal; }
        .info-section ol li { margin-bottom: 0.5rem; }
        /* Info Section Icon Animation */
        .info-section i.fa-eye-dropper { animation: icon-bounce 1.5s infinite; display: inline-block; }
        .info-section i.fa-lightbulb { animation: icon-pulse 2s infinite ease-in-out; display: inline-block; }
        .info-section .info-cta i { transition: transform 0.2s ease; display: inline-block;}
        .info-section .info-cta:hover i { transform: scale(1.1) translateX(3px); } /* Slight move right */
        .info-section code { background-color: rgba(255,255,255,0.15); padding: 0.2em 0.5em; border-radius: 4px; font-size: 0.9em; color: #00ff88; }
        html[data-theme="light"] .info-section code { background-color: rgba(0,0,0,0.07); color: #10b981; }
        .video-wrapper { max-width: 700px; margin: 2rem auto; box-shadow: 0 8px 25px rgba(0,0,0,0.3); border-radius: 1rem; overflow: hidden; position: relative; padding-bottom: 56.25%; height: 0; background: #000;}
        html[data-theme="light"] .video-wrapper { box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .info-cta { margin-top: 2rem; display: inline-block; background: linear-gradient(90deg, #00ff88, #00ccff); color: black; padding: 0.8rem 1.8rem; border-radius: 50px; font-weight: bold; text-decoration: none; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .info-cta:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(0, 255, 136, 0.4); }
        .info-section .fa-info-circle { animation: icon-pulse 2s infinite ease-in-out; display: inline-block; }

        /* --- Tooltip Styles --- */
        .tooltip { position: relative; display: inline-block; cursor: help; border-bottom: 1px dotted #00ccff; }
        html[data-theme="light"] .tooltip { border-bottom-color: #0ea5e9; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #2a2a2a; color: #fff; text-align: center; border-radius: 6px; padding: 10px; position: absolute; z-index: 60; bottom: 130%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s ease, transform 0.3s ease; font-size: 0.85rem; line-height: 1.4; border: 1px solid #444; box-shadow: 0 3px 8px rgba(0,0,0,0.4); transform: translateY(10px); }
        html[data-theme="light"] .tooltip .tooltiptext { background-color: #f0f0f0; color: #333; border-color: #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; transform: translateY(0); }

        /* --- Footer --- */
        .site-footer { text-align: center; padding: 2rem 1rem; margin-top: 3rem; font-size: 0.9rem; border-top: 1px solid #333; background-color: rgba(0,0,0,0.2); }
        html[data-theme="light"] .site-footer { border-top-color: #ddd; background-color: rgba(0,0,0,0.03); }
        .footer-links { margin-top: 0.5rem; display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        .footer-link { color: #00ccff; text-decoration: none; cursor: pointer; transition: color 0.2s, transform 0.2s; display: inline-block; /* For transform */ }
        html[data-theme="light"] .footer-link { color: #0ea5e9; }
        .footer-link:hover { color: #00ff88; text-decoration: underline; transform: translateY(-1px); }
        html[data-theme="light"] .footer-link:hover { color: #10b981; }

        /* --- Ad Placeholder Styles (Optional) --- */
        .ad-placeholder {
             background-color: rgba(128, 128, 128, 0.1); border: 1px dashed #555;
             min-height: 90px; display: flex; align-items: center; justify-content: center;
             text-align: center; color: #888; font-size: 0.9rem; margin: 1.5rem auto; max-width: 728px;
        }
        html[data-theme="light"] .ad-placeholder { background-color: #eee; border-color: #ccc; color: #777; }


        /* --- Animations --- */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes glow { from { filter: drop-shadow(0 0 5px #00ff88); } to { filter: drop-shadow(0 0 15px #00ccff); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(25px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-25px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* weirdModalPopIn defined above */
        @keyframes popUpFadeIn { from { opacity: 0; transform: translateY(10px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        /* textPopInGlowRefined defined above */

        /* Icon Animations */
        @keyframes icon-bounce {
          0%, 100% { transform: translateY(0) scale(1); }
          50% { transform: translateY(-3px) scale(1.1); }
        }
        @keyframes icon-pulse {
           0%, 100% { transform: scale(1); opacity: 0.8; }
           50% { transform: scale(1.15); opacity: 1; }
        }
        @keyframes icon-wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-8deg) scale(1.1); }
            75% { transform: rotate(8deg) scale(1.1); }
        }


        /* --- Utility Classes --- */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }
        button, a[onclick], [role="button"], label[for], .tooltip, .footer-link, input[type="checkbox"] { cursor: pointer; } /* Ensure cursors */

        /* --- Progress Bar Styles --- */
        .progress-container { width: 100%; background: #333; border-radius: 10px; overflow: hidden; height: 12px; margin-top: 1rem; }
        html[data-theme="light"] .progress-container { background: #e5e7eb; }
        .progress-bar { height: 100%; background: linear-gradient(270deg, #00ff88, #00ccff); animation: glow 1.5s infinite alternate; width: 0%; transition: width 0.4s ease; border-radius: 10px; }
        #uploadStatus { margin-top: 0.8rem; font-size: 0.9rem; min-height: 1.4em; text-align: center;}

        /* --- Gallery Messages --- */
        .gallery-message {
             text-align: center;
             width: 100%;
             grid-column: 1 / -1; /* Span all columns */
             font-size: 1.1rem; /* Slightly larger */
             padding: 2rem;
             margin-top: 1rem;
             border-radius: 0.5rem;
        }
        .gallery-message.info { color: #9ca3af; /* Gray */ } /* Dark theme */
        html[data-theme="light"] .gallery-message.info { color: #4b5563; } /* Light theme */
        .gallery-message.error { color: #f87171; background-color: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); } /* Red */
        html[data-theme="light"] .gallery-message.error { color: #dc2626; background-color: #fee2e2; border: 1px solid #fecaca;}
        .gallery-message.empty { color: #60a5fa; /* Blue */ }
        html[data-theme="light"] .gallery-message.empty { color: #3b82f6; }
        .gallery-message.end-of-list { animation: fadeInUp 0.5s ease-out; } /* Add animation to end message */

        /* --- Deleting Card Transition --- */
        .card.deleting {
            opacity: 0 !important; /* Use important to override other styles */
            transform: scale(0.9) !important;
            height: 0 !important;
            margin: 0 !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            border-width: 0 !important;
            overflow: hidden !important;
            /* Transition uses existing .card transition settings */
            transition: transform 0.3s ease, opacity 0.4s ease, height 0.4s ease, margin 0.4s ease, padding 0.4s ease, border-width 0.4s ease;
        }

    </style>
</head>
<body>

    <!-- Intro Screen -->
    <div id="introScreen">
        <span id="introText">Green Screen Vault</span>
    </div>

    <!-- Header -->
    <header class="header">
        <h1>ðŸŽ¬ Green Screen Vault</h1>
         <div class="header-buttons-container">
             <div class="header-buttons left">
                 <!-- Theme Toggle Button & Sun/Moon -->
                 <button type="button" id="themeToggleBtn" class="header-btn" title="Toggle Theme" aria-label="Toggle color theme">
                     <i class="fas fa-adjust"></i>
                     <span class="button-text sr-only sm:not-sr-only">Theme</span>
                     <!-- Sun and Moon Icons for Animation - Positioned inside button -->
                     <div id="sunIcon" class="theme-icon" aria-hidden="true"><i class="fas fa-sun"></i></div>
                     <div id="moonIcon" class="theme-icon" aria-hidden="true"><i class="fas fa-moon"></i></div>
                 </button>
             </div>
             <div class="header-buttons right">
                 <!-- Upload Button -->
                 <button type="button" id="showUploadBtn" class="header-btn" title="Upload Video" aria-label="Open video upload popup">
                     <i class="fas fa-upload"></i>
                     <span class="button-text sr-only sm:not-sr-only">Upload</span>
                 </button>
             </div>
         </div>
    </header>

    <!-- Potential Ad Slot -->
    <!--
    <div class="ad-placeholder">Ad Placeholder (e.g., 728x90 Leaderboard)</div>
    -->

    <!-- Filter and Search Area -->
    <div class="filter-search-area">
        <div class="filter-options" role="tablist" aria-label="Video Filters">
             <button type="button" class="filter-btn" data-filter="recent" id="filter-recent" role="tab" aria-selected="true">Most Recent</button>
             <button type="button" class="filter-btn" data-filter="popular" id="filter-popular" role="tab" aria-selected="false">Popular</button>
             <!-- 'Relevant' filter requires backend search. Commented out for now. -->
             <!-- <button type="button" class="filter-btn" data-filter="relevant" id="filter-relevant" role="tab" aria-selected="false" title="Requires search query">Relevant</button> -->
        </div>
        <div class="search-container">
            <label for="search" class="sr-only">Search Videos:</label>
            <input type="search" id="search" placeholder="Search clips by title or uploader..." aria-label="Search green screen clips">
            <!-- Search icon added via CSS ::before -->
        </div>
    </div>

    <!-- Main Content Area -->
    <main>
        <!-- Gallery -->
        <div class="gallery" id="gallery" aria-live="polite">
            <!-- Initial loading message -->
             <p class="gallery-message info" id="gallery-loading-msg">ðŸ”„ Loading Videos...</p>
             <!-- Messages like 'no results' or errors will be dynamically added here -->
        </div>

        <!-- Load More Button -->
        <button type="button" id="loadMoreBtn" style="display: none;">Load More Videos</button>

        <!-- Info / How-to Section -->
        <section class="info-section landing-page">
             <h2><i class="fas fa-lightbulb mr-2"></i>Unlock Your Creativity</h2>
             <p>
                 Welcome to the Green Screen Vault! Your ultimate destination for free <span class="tooltip">chroma key<span class="tooltiptext">Chroma key compositing, or chroma keying, is a visual effects technique for compositing two images or video streams together based on color hues (chroma range).</span></span> footage and video clips. Find dynamic effects, transitions, elements, and <strong class="text-green-400 dark:text-green-300">even popular meme templates</strong> to elevate your video projects â€“ all free to download and use! Find the perfect clip for your next video.
             </p>
             <div class="video-wrapper">
               <iframe
                   src="https://www.youtube.com/embed/-UFG_jU3bXA"
                   title="YouTube video player - Green Screen Tutorial (Adobe Premiere Pro Ultra Key)"
                   frameborder="0"
                   loading="lazy"
                   allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                   allowfullscreen>
               </iframe>
             </div>
             <h3><i class="fas fa-question-circle mr-1"></i>Quick Guide: Using Overlays (Premiere Pro Example)</h3>
             <ol>
                 <li><strong>Import:</strong> Add your main footage and the downloaded green screen clip (.mp4, .mov) to your project.</li>
                 <li><strong>Layer:</strong> Place the overlay clip on the timeline track <strong>above</strong> your main footage.</li>
                 <li><strong>Effect:</strong> Search for <code>Ultra Key</code> in the Effects panel and drag it onto the overlay clip.</li>
                 <li><strong>Key Color:</strong> In Effect Controls > Ultra Key, use the eyedropper <i class="fas fa-eye-dropper" aria-hidden="true"></i> to select the green (or blue) screen color in the Program Monitor.</li>
                 <li><strong>Refine:</strong> Adjust Matte Generation/Cleanup/Spill Suppression settings for a clean key. Experiment with <span class="tooltip">Choke<span class="tooltiptext">Reduces the size of the matte slightly to hide faint edges.</span></span> and <span class="tooltip">Soften<span class="tooltiptext">Blurs the edges of the matte for smoother blending.</span></span> for best results.</li>
                 <li><strong>Composite:</strong> Position, scale, or animate the keyed overlay layer as needed to blend it into your scene!</li>
             </ol>
              <h3><i class="fas fa-rocket mr-1"></i> Pro Tips & Benefits for Content Creators</h3>
              <p>
                  Using pre-made green screen clips saves significant time compared to creating complex effects from scratch. They add professional polish to YouTube videos, live streams (OBS/Streamlabs), social media content (TikTok/Instagram Reels), and indie films. This vault thrives on community contributions â€“ consider uploading your own creations! Share your awesome green screen effects, transitions, video elements, or even those hilarious <strong class="text-green-400 dark:text-green-300">meme templates</strong> everyone is looking for! Help fellow creators find the perfect video clips.
              </p>
              <p>
                  <strong>Shooting Tip:</strong> Ensure your green screen is evenly lit and wrinkle-free for the easiest keying. Avoid green clothing or highly reflective objects on your subject. Consistent lighting is key!
              </p>
              <div class="mt-8">
                   <div class="inline-block bg-teal-100 text-teal-800 p-3 rounded-lg text-sm shadow-md dark:bg-teal-900 dark:text-teal-200">
                       <i class="fas fa-info-circle mr-1" aria-hidden="true"></i> This site uses <span class="tooltip">Cloudinary<span class="tooltiptext">A cloud-based service for managing and delivering images and videos efficiently.</span></span> for video hosting and optimized delivery. All uploaded content is licensed under <span class="tooltip">CC0 (Public Domain)<span class="tooltiptext">Creative Commons Zero - Content can be copied, modified, distributed, and performed, even for commercial purposes, all without asking permission.</span></span>. Download counts are estimations based on clicks.
                   </div>
              </div>
              <div class="mt-8">
                    <a href="#" id="scrollToUpload" class="info-cta"><i class="fas fa-share-alt mr-2" aria-hidden="true"></i>Contribute Your Overlay!</a>
              </div>
        </section>
    </main>

    <!-- MODALS SECTION -->

    <!-- Upload Popup -->
    <div class="modal-backdrop" id="uploadPopup">
        <div class="modal-box w-full max-w-md">
            <button type="button" class="modal-close-btn" data-action="close-modal" aria-label="Close Upload Popup">Ã—</button>
            <h2><i class="fas fa-cloud-upload-alt mr-2" aria-hidden="true"></i>Upload Overlays</h2>
            <p class="text-sm text-gray-400 mb-4 text-center">Help the community grow! Share effects, transitions, or meme templates.</p>
            <div>
                <label for="uploaderNameInput">Your Name/Alias (Optional):</label>
                <input type="text" id="uploaderNameInput" placeholder="Shown publicly with your video(s)" class="mb-4" aria-describedby="uploaderHelp">
                <p id="uploaderHelp" class="sr-only">Enter the name you want displayed as the uploader</p>
            </div>
            <div>
                <label for="deletePassword">Deletion Password (Required):</label>
                <input type="password" id="deletePassword" placeholder="Save this password securely!" class="mb-4" aria-describedby="passwordHelp" required>
                 <p id="passwordHelp" class="text-xs text-gray-500 mb-4 -mt-2">6+ characters. Needed if you ever want to delete your upload(s).</p>
            </div>
            <button type="button" id="selectUploadBtn" class="modal-button-confirm w-full justify-center text-base py-3">
                <i class="fas fa-file-video mr-2" aria-hidden="true"></i> Select & Upload Video(s)
            </button>
            <div class="progress-container mt-4" id="progressContainer" style="display: none;" aria-label="Upload progress"><div class="progress-bar" id="progressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div>
            <p id="uploadStatus" class="mt-2 text-sm h-5 text-center" aria-live="polite"></p>
            <button type="button" class="modal-button-cancel w-full justify-center mt-2" data-action="close-modal">Cancel</button>
        </div>
    </div>

    <!-- Post-Upload Details Modal (REMOVED - No longer shown automatically) -->

    <!-- Generic Prompt/Confirmation Modal -->
    <div class="modal-backdrop" id="promptModal">
        <div class="modal-box">
             <button type="button" class="modal-close-btn" data-action="close-prompt" aria-label="Close Prompt">Ã—</button>
            <h2 id="promptTitle">Prompt</h2>
            <div id="promptContent" class="mt-4 mb-4">
                 <!-- Dynamic content goes here (input field or confirmation text) -->
                 <p class="modal-error" id="promptError" aria-live="assertive" style="display: none;"></p> <!-- Error message container, hidden initially -->
            </div>
             <div id="promptSpinner" style="display: none; text-align: center; margin-top: 1rem;">
                 <i class="fas fa-spinner fa-spin text-2xl text-blue-400"></i>
                 <p class="text-sm text-gray-400 mt-1">Processing...</p>
             </div>
            <div class="modal-buttons">
                 <button type="button" class="modal-button-cancel" id="promptCancelBtn" data-action="close-prompt">Cancel</button>
                 <button type="button" class="modal-button-confirm" id="promptConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Upload Success Modal (Adapted for Multiple) -->
    <div class="modal-backdrop" id="uploadSuccessPopup">
        <div class="modal-box text-center">
             <button type="button" class="modal-close-btn" data-action="close-modal" aria-label="Close Success Popup">Ã—</button> <!-- Use close-modal generic action -->
            <h2 class="text-2xl"><i class="fas fa-rocket text-blue-400 mr-2" aria-hidden="true"></i>Upload Complete!</h2>
            <div id="uploadSuccessContent" class="my-5"> <!-- Increased margin -->
                 <p>Thank you, <strong id="successUploaderName" class="text-green-400">Uploader</strong>!</p>
                 <p id="successSummaryText">Your overlay(s) are now live.</p> <!-- Dynamic text -->
                 <p class="mt-3 text-sm text-gray-400">Sharing helps the creative community grow!</p>
            </div>
            <div class="modal-buttons justify-center">
                 <button type="button" class="modal-button-confirm" data-action="close-modal">Awesome!</button> <!-- Use close-modal generic action -->
            </div>
        </div>
    </div>

    <!-- Terms and Conditions Modal -->
    <div class="modal-backdrop" id="termsModal">
        <div class="modal-box">
              <button type="button" class="modal-close-btn" data-action="close-modal" aria-label="Close Terms Popup">Ã—</button>
              <h2><i class="fas fa-file-contract mr-1"></i>Terms & Privacy</h2>
              <div class="terms-content" tabindex="0"> <!-- Make content scrollable and focusable -->
                  <!-- Full T&C Text Here (Keep existing text) -->
                   <h3>Terms and Conditions</h3><p><em>Last updated: 2024-05-16</em></p><p>Welcome to the Green Screen Vault! These terms and conditions outline the rules and regulations for the use of our website and services, located at [Your Website URL - Replace This]. By accessing this website, we assume you accept these terms and conditions. Do not continue to use Green Screen Vault if you do not agree to take all of the terms and conditions stated on this page.</p>
                    <h4>License (CC0)</h4>
                    <p>Unless otherwise stated, Green Screen Vault and/or its licensors own the intellectual property rights for original site design and functionality. <strong>User-uploaded content (videos) is licensed under Creative Commons Zero (CC0) - Public Domain Dedication upon successful upload.</strong> This means:</p>
                    <ul>
                        <li>You grant a worldwide, royalty-free, non-exclusive, perpetual, irrevocable license for others to download, copy, modify, distribute, perform, and use the content for any purpose, including commercial purposes, without asking permission from or providing attribution to the uploader or Green Screen Vault.</li>
                        <li>You warrant that you own the necessary rights to grant this license or that the content is already in the public domain and suitable for CC0 dedication. You affirm the content does not infringe on any third-party rights (copyright, trademark, privacy, etc.).</li>
                    </ul>
                    <h4>User Content and Conduct</h4>
                    <p>You are solely responsible for the content you upload. You agree not to upload content that:</p>
                    <ul>
                        <li>Is illegal, harmful, obscene, hateful, defamatory, threatening, infringing of intellectual property rights, invasive of privacy, or otherwise injurious or objectionable.</li>
                        <li>Contains software viruses, malware, political campaigning, commercial solicitation unrelated to the content itself, chain letters, mass mailings, or any form of "spam."</li>
                         <li>Depicts non-consensual sexual content, promotes illegal acts or extreme violence, or constitutes harassment.</li>
                    </ul>
                    <p>We reserve the right (but not the obligation) to remove or edit content that violates these terms or is otherwise deemed inappropriate, at our sole discretion, without notice.</p>
                    <h4>Deletion Password</h4>
                    <p>You must provide a deletion password upon upload. This password allows you (the uploader, from the same browser where the password was stored) to initiate the deletion process for your uploaded content. Keep this password secure and confidential. <strong>We are not responsible for lost passwords and cannot delete content without the correct password being provided through the site's interface. Passwords are stored only in your browser's local storage and are not recoverable by us.</strong></p>
                    <h4>Disclaimer</h4>
                    <p>The materials on Green Screen Vault's website are provided on an 'as is' basis. Green Screen Vault makes no warranties, expressed or implied, and hereby disclaims and negates all other warranties including, without limitation, implied warranties or conditions of merchantability, fitness for a particular purpose, or non-infringement of intellectual property or other violation of rights. Further, Green Screen Vault does not warrant or make any representations concerning the accuracy, likely results, or reliability of the use of the materials on its website or otherwise relating to such materials or on any sites linked to this site.</p>
                     <h4>Limitation of Liability</h4>
                     <p>In no event shall Green Screen Vault or its suppliers be liable for any damages (including, without limitation, damages for loss of data or profit, or due to business interruption) arising out of the use or inability to use the materials on Green Screen Vault's website, even if Green Screen Vault or a Green Screen Vault authorized representative has been notified orally or in writing of the possibility of such damage.</p>
                     <h4>Governing Law</h4>
                     <p>These terms and conditions are governed by and construed in accordance with the laws of [Your Jurisdiction, e.g., California, USA - Replace This] and you irrevocably submit to the exclusive jurisdiction of the courts in that State or location.</p>
                     <h4>Changes to Terms</h4>
                     <p>We reserve the right to revise these terms at any time. By using this website you are expected to review these terms on a regular basis.</p>

                   <hr class="my-6 border-gray-600 dark:border-gray-700">
                   <h3>Privacy Policy</h3><p><em>Effective Date: 2024-05-16</em></p>
                   <p>We value your privacy. This Privacy Policy explains how Green Screen Vault ("we", "us", "our") handles information when you use our website and services.</p>
                   <h4>Information We Collect</h4>
                   <ul>
                        <li><strong>Uploaded Content:</strong> Videos you choose to upload are processed and stored via Cloudinary and become publicly accessible under the CC0 license.</li>
                        <li><strong>Metadata:</strong> We may store metadata associated with uploads, such as the public ID provided by Cloudinary, the optional uploader name you provide, and any title you assign (if renaming is implemented server-side). **Download counts will be stored server-side if implemented.**</li>
                        <li><strong>Deletion Password Reference (Local Storage):</strong> The deletion password you provide during upload is stored <strong>only</strong> in your web browser's local storage. It is never sent to or stored on our servers. It is linked to the upload's public ID within your browser.</li>
                        <li><strong>User Preferences (Local Storage):</strong> We use local storage to remember your theme preference (dark/light) and whether you have accepted the terms.</li>
                        <li><strong>Locally Stored Data (Local Storage):</strong> Renamed titles and uploader names associated with videos are also stored in your browser's local storage to persist your customizations across sessions on that specific browser.</li>
                        <li><strong>Analytics Data (Non-Personal):</strong> We may collect anonymous usage data (e.g., page views, features used, general geographic location based on IP address) through standard web server logs or third-party analytics services (like Google Analytics, if implemented) to understand how the site is used and to improve it. This data is aggregated and does not personally identify you.</li>
                        <li><strong>Download Interaction Data:</strong> When a download is initiated, non-personally identifiable interaction data (e.g., the video's public ID, timestamp) is sent to our server to increment the download counter associated with that video. We do not link this directly to a specific user or session.</li>
                   </ul>
                   <h4>How We Use Information</h4>
                    <ul>
                        <li>To operate and display the website, including the video gallery and associated metadata (title, uploader, download count).</li>
                        <li>To enable the content deletion functionality using the password stored in *your* browser's local storage.</li>
                        <li>To remember your site preferences.</li>
                        <li>To analyze usage patterns and improve the website's functionality, content, and user experience.</li>
                        <li>To monitor for and prevent violations of our Terms and Conditions.</li>
                        <li>To track aggregated content popularity (download counts).</li>
                    </ul>
                   <h4>Data Storage & Security</h4>
                   <ul>
                        <li>Videos are hosted and delivered by Cloudinary. Please refer to Cloudinary's Privacy Policy for their data practices.</li>
                        <li>Metadata required for listing (including download counts) is stored on our server infrastructure. We take reasonable measures to protect this data, but no system is 100% secure.</li>
                        <li><strong>Deletion passwords, user preferences, renamed titles, and associated uploader names are stored only in your browser's local storage. Clearing your browser's data will permanently remove this information, including any stored deletion passwords, making deletion impossible via the website interface.</strong></li>
                   </ul>
                    <h4>Third-Party Services</h4>
                    <ul>
                        <li><strong>Cloudinary:</strong> Used for video hosting, processing, and delivery.</li>
                         <li><strong>Analytics Providers (Optional):</strong> If used (e.g., Google Analytics), they collect data according to their own privacy policies.</li>
                         <li><strong>Advertising Partners (Optional):</strong> If ads are implemented (e.g., Google AdSense), these partners may use cookies and web beacons to collect information for ad personalization and measurement. Refer to their respective privacy policies.</li>
                    </ul>
                    <h4>Cookies and Local Storage</h4>
                    <p>We use local storage as described above. We may use essential cookies for site functionality. If third-party services (analytics, ads) are used, they may set their own cookies. You can manage cookies and local storage through your browser settings.</p>
                    <h4>Your Rights and Choices</h4>
                    <p>You can delete your uploaded content using the deletion password via the site interface, provided the password exists in your current browser's local storage. You can clear your browser's local storage at any time to remove stored preferences, titles, names, and passwords. You can manage cookie preferences through your browser.</p>
                    <h4>Children's Privacy</h4>
                    <p>Our service is not directed to individuals under the age of 13 (or a higher age threshold depending on jurisdiction). We do not knowingly collect personal information from children. If we become aware that a child has provided us with information without parental consent, we take steps to remove such information.</p>
                    <h4>Policy Changes</h4>
                    <p>We may update this Privacy Policy from time to time. We will notify you of significant changes by posting the new policy on this page and updating the "Effective Date." We encourage you to review this policy periodically.</p>
                    <h4>Contact Us</h4>
                    <p>If you have any questions about this Privacy Policy, please contact us via the method provided in the "Contact Us" link in the footer.</p>
              </div>
              <label class="terms-accept-label mt-4" id="termsAcceptWrapper" style="display: none;">
                  <input type="checkbox" id="termsAcceptCheckbox" class="mr-2">
                  <span>I have read and agree to the Terms and Conditions and Privacy Policy.</span>
              </label>
              <p class="modal-error" id="termsError" aria-live="assertive"></p>
              <div class="modal-buttons">
                  <button type="button" class="modal-button-confirm" id="termsAcceptBtn" style="display: none;">Agree & Continue</button>
                  <button type="button" class="modal-button-cancel" id="termsCloseBtn" data-action="close-modal">Close</button>
              </div>
        </div>
    </div>

    <!-- About Us Modal -->
    <div class="modal-backdrop" id="aboutModal">
        <div class="modal-box">
             <button type="button" class="modal-close-btn" data-action="close-modal" aria-label="Close About Us Popup">Ã—</button>
            <h2><i class="fas fa-users text-blue-400 mr-2" aria-hidden="true"></i>About Us</h2>
            <div class="my-5 px-2 text-left leading-relaxed">
                <p class="mb-4">Hey there! We're the team behind the <strong>Green Screen Vault</strong>.</p>
                <p class="mb-4">We're a passionate group of video editors and creators who noticed a need for a simple, free, and community-driven resource for high-quality green screen assets. That's why we built this Vault â€“ a place to easily find, download, and share awesome chroma key clips for all kinds of projects.</p>
                <p class="mb-4">Beyond running this site, we're also <strong>professional video editors</strong>! We love bringing stories to life and crafting visually stunning content. If you need help with your next video project, whether it's a complex edit, motion graphics, or just polishing up your footage, we're here to help.</p>
                <p>Get in touch for editing inquiries: <a href="mailto:coolestvideoeditor@gmail.com" class="text-blue-400 hover:text-blue-300 underline transition-colors">coolestvideoeditor@gmail.com</a></p>
                <p class="mt-4 text-sm text-gray-400">For general site questions or feedback, please use the Contact Us link.</p>
            </div>
            <div class="modal-buttons justify-center">
                 <button type="button" class="modal-button-cancel" data-action="close-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Contact Us Modal -->
    <div class="modal-backdrop" id="contactModal">
        <div class="modal-box">
             <button type="button" class="modal-close-btn" data-action="close-modal" aria-label="Close Contact Us Popup">Ã—</button>
            <h2><i class="fas fa-envelope text-purple-400 mr-2" aria-hidden="true"></i>Contact Us</h2>
            <div class="my-5 px-2 text-center">
                <p class="mb-4">Got questions, feedback, suggestions, or found a bug? We'd love to hear from you!</p>
                <p class="mb-2">Maybe you have a brilliant idea for a new feature, or perhaps you just want to say hi (we like those too!).</p>
                <p class="mt-5">Reach out directly via email:</p>
                <p class="mt-2 text-lg font-semibold">
                    <a href="mailto:ganeshvb003@gmail.com" class="text-purple-400 hover:text-purple-300 underline transition-colors inline-block hover:scale-105">
                        <i class="fas fa-paper-plane mr-2 inline-block transition-transform hover:rotate-12"></i>ganeshvb003@gmail.com
                    </a>
                </p>
                 <p class="mt-5 text-sm text-gray-400">We'll do our best to get back to you soon!</p>
                 <p class="mt-1 text-sm text-gray-400">(For video editing service inquiries, please see the 'About Us' section.)</p>
            </div>
            <div class="modal-buttons justify-center">
                 <button type="button" class="modal-button-cancel" data-action="close-modal">Close</button>
            </div>
        </div>
    </div>


    <!-- Footer -->
    <footer class="site-footer">
       <p>Â© <span id="currentYear"></span> Green Screen Vault. Community driven & CC0 Licensed Content.</p>
       <div class="footer-links">
            <!-- Links now trigger modals -->
            <span id="showAboutLink" class="footer-link" title="Learn more about this project">About Us</span>
            <span class="text-gray-500 dark:text-gray-600" aria-hidden="true">|</span>
            <span class="footer-link" id="viewTermsLink" title="View Terms and Conditions & Privacy Policy">Terms & Privacy</span>
            <span class="text-gray-500 dark:text-gray-600" aria-hidden="true">|</span>
            <span id="showContactLink" class="footer-link" title="Get in touch">Contact Us</span>
       </div>
        <!-- Potential Ad Slot -->
        <!--
        <div class="ad-placeholder mt-4">Footer Ad Placeholder</div>
        -->
    </footer>


    <script>
        // --- Global Constants & State ---
        // =====================================================================
        // === IMPORTANT: CONFIGURE YOUR CLOUDINARY ACCOUNT DETAILS HERE ===
        // =====================================================================
        const CLOUD_NAME = 'dogxcu1sj'; // *** REPLACE WITH YOUR Cloudinary Cloud Name ***
        const UPLOAD_PRESET = 'gs_overlay'; // *** REPLACE WITH The EXACT name of your UNSIGNED Upload Preset ***
        // =====================================================================
        // === IMPORTANT: BACKEND ENDPOINT CONFIGURATION ===
        // =====================================================================
        // Replace these with your actual backend API endpoints.
        // You MUST implement these for core features like persistent deletion and download counts.
        const VIDEO_FETCH_ENDPOINT = '/videos'; // Endpoint to GET list of videos (EXPECTS `download_count` property in response objects)
        const VIDEO_DELETE_ENDPOINT_BASE = '/delete'; // Base endpoint for DELETE request (e.g., /delete/:public_id)
        const DOWNLOAD_INCREMENT_ENDPOINT_BASE = '/increment_download'; // Base endpoint for POST request to increment download count (e.g., /increment_download/:public_id)
        // =====================================================================

        const VIDEOS_PER_LOAD = 12; // How many videos to load per batch
        let allVideos = []; // Holds all fetched video data (from backend)
        let displayedVideos = []; // Holds the currently sorted/filtered videos for display
        let currentVideoIndex = 0; // Index for pagination within displayedVideos
        let renamedTitles = {}; // Key: public_id, Value: user-set title (localStorage)
        let uploaderNames = {}; // Key: public_id, Value: user-set name (localStorage)
        let currentFilter = 'recent'; // Default filter state
        let currentSearchQuery = ''; // Default search state
        let currentPromptCallback = null; // Callback for the generic prompt modal
        let isFetching = false; // Flag to prevent multiple fetches
        let successfulUploads = []; // Array to hold results for multiple uploads

        // --- Utility Functions ---
        const $ = (selector) => document.querySelector(selector);
        const $$ = (selector) => document.querySelectorAll(selector);
        const log = (...args) => console.log('[GSV]', ...args);
        const err = (...args) => console.error('[GSV ERROR]', ...args);

        function safeGetElementById(id) {
            const el = document.getElementById(id);
            return el;
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func(...args); };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Modal Management ---
        function showModal(modalId) {
            log(`Showing modal: ${modalId}`);
            const modal = safeGetElementById(modalId);
            if (modal && modal.classList.contains('modal-backdrop')) {
                modal.style.display = 'flex';
                const focusableElement = modal.querySelector('button:not([disabled]), input:not([disabled]), [tabindex="0"], a[href]');
                const modalBox = modal.querySelector('.modal-box');
                if (focusableElement) {
                    setTimeout(() => focusableElement.focus(), 50);
                } else if (modalBox) {
                    modalBox.setAttribute('tabindex', '-1');
                    setTimeout(() => modalBox.focus(), 50);
                }
            } else {
                 err(`Cannot show modal - Element ${modalId} not found or not a modal backdrop.`);
            }
        }

        function hideModal(modalId) {
            log(`Hiding modal: ${modalId}`);
            const modal = safeGetElementById(modalId);
            if (modal && modal.classList.contains('modal-backdrop') && modal.style.display !== 'none') {
                 modal.classList.add('modal-fade-out');
                setTimeout(() => {
                    if (modal) {
                        modal.style.display = 'none';
                        modal.classList.remove('modal-fade-out');
                        const errorEl = modal.querySelector('.modal-error');
                        if (errorEl) { errorEl.textContent = ''; errorEl.style.display = 'none'; }
                        const modalBox = modal.querySelector('.modal-box[tabindex="-1"]');
                        if(modalBox) modalBox.removeAttribute('tabindex');
                        // Also hide spinner if present in prompt modal
                        const spinnerEl = modal.querySelector('#promptSpinner');
                        if (spinnerEl) spinnerEl.style.display = 'none';
                    }
                }, 350);
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            log("DOM Ready. Initializing...");
            try {
                initializeTheme();
                loadLocalData();
                setupStaticEventListeners();
                handleIntro();
            } catch (error) {
                err("Initialization failed:", error);
                const gallery = safeGetElementById('gallery');
                if (gallery) displayGalleryMessage('âŒ Error loading page. Please refresh.', 'error');
            }
        });

        function loadLocalData() {
            log("Loading data from localStorage...");
            try {
                renamedTitles = JSON.parse(localStorage.getItem('renamedTitles') || '{}');
                uploaderNames = JSON.parse(localStorage.getItem('uploaderNames') || '{}');
                log(`Loaded ${Object.keys(renamedTitles).length} renamed titles, ${Object.keys(uploaderNames).length} uploader names.`);
            } catch (e) {
                err("Failed to parse localStorage data:", e);
                renamedTitles = {};
                uploaderNames = {};
                // Optionally clear corrupted data:
                // localStorage.removeItem('renamedTitles');
                // localStorage.removeItem('uploaderNames');
            }
        }

        function setupStaticEventListeners() {
            log("Setting up static event listeners...");
            const galleryElement = safeGetElementById('gallery');
            const themeToggleBtn = safeGetElementById('themeToggleBtn');
            const showUploadBtn = safeGetElementById('showUploadBtn');
            const scrollToUploadLink = safeGetElementById('scrollToUpload');
            const searchInput = safeGetElementById('search');
            const loadMoreBtn = safeGetElementById('loadMoreBtn');
            const viewTermsLink = safeGetElementById('viewTermsLink');
            const showAboutLink = safeGetElementById('showAboutLink');
            const showContactLink = safeGetElementById('showContactLink');
            const selectUploadBtn = safeGetElementById('selectUploadBtn');
            const termsAcceptBtn = safeGetElementById('termsAcceptBtn');

            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (showUploadBtn) showUploadBtn.addEventListener('click', () => {
                successfulUploads = [];
                const uploaderInput = safeGetElementById('uploaderNameInput');
                const passInput = safeGetElementById('deletePassword');
                const status = safeGetElementById('uploadStatus');
                const progressContainer = safeGetElementById('progressContainer');
                const uploadButton = safeGetElementById('selectUploadBtn');
                if(uploaderInput) uploaderInput.value = '';
                if(passInput) passInput.value = '';
                if(status) status.textContent = '';
                if(progressContainer) {
                    progressContainer.style.display = 'none';
                    const progressBar = safeGetElementById('progressBar');
                    if(progressBar) progressBar.style.width = '0%';
                }
                if (uploadButton) uploadButton.disabled = false;
                showModal('uploadPopup');
            });

            if (scrollToUploadLink && showUploadBtn) {
                scrollToUploadLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    showUploadBtn.click();
                    safeGetElementById('uploadPopup')?.querySelector('input, button')?.focus();
                });
            }

            if (searchInput) {
                searchInput.addEventListener('input', debounce(() => {
                    const query = searchInput.value.toLowerCase().trim();
                    if (query !== currentSearchQuery) {
                        log(`Search updated to: "${query}"`);
                        currentSearchQuery = query;
                        applyFiltersAndRender(true);
                    }
                }, 400));
            }

            $$('.filter-options .filter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const filterType = e.target.dataset.filter;
                    if (filterType && filterType !== currentFilter) {
                        currentFilter = filterType;
                        setActiveFilterButton(e.target);
                        applyFiltersAndRender(true);
                    } else if (!filterType) {
                        err("Filter button missing data-filter attribute:", e.target);
                    }
                });
            });

            if (loadMoreBtn) loadMoreBtn.addEventListener('click', () => renderVideoBatch(false));

            if (viewTermsLink) viewTermsLink.addEventListener('click', () => showTermsModal(true));
            if (showAboutLink) showAboutLink.addEventListener('click', () => showModal('aboutModal'));
            if (showContactLink) showContactLink.addEventListener('click', () => showModal('contactModal'));

            document.addEventListener('click', (event) => {
                const target = event.target;
                 const modalBackdrop = target.closest('.modal-backdrop');
                 const closeAction = target.closest('[data-action="close-modal"]');
                 if (target.classList.contains('modal-backdrop') || closeAction) {
                    if(modalBackdrop) hideModal(modalBackdrop.id);
                 }
                 const closePromptAction = target.closest('[data-action="close-prompt"]');
                 if (closePromptAction) {
                    hideModal('promptModal');
                    // If cancelling, ensure any associated callback is cleared
                    currentPromptCallback = null;
                 }
                const openPopup = document.querySelector('.action-popup[style*="display: block"]');
                if (openPopup && !openPopup.contains(target) && !target.closest('.menu-btn')) {
                    log("Clicked outside, closing action menu:", openPopup.id);
                    openPopup.style.display = 'none';
                     const menuButton = $(`button[aria-controls="${openPopup.id}"]`);
                     if(menuButton) menuButton.setAttribute('aria-expanded', 'false');
                }
            });

             if (selectUploadBtn) selectUploadBtn.addEventListener('click', openCloudinaryUpload);
             if (termsAcceptBtn) termsAcceptBtn.addEventListener('click', acceptTerms);

             if (galleryElement) {
                 galleryElement.addEventListener('click', handleGalleryClick);
             }

            log("Static event listeners set up.");
        }

        function handleGalleryClick(event) {
             const target = event.target;
             const card = target.closest('.card');
             const publicId = card?.dataset.publicId;

             // Video Play/Pause
             const videoContainer = target.closest('.video-container');
             if (videoContainer && publicId) {
                 const video = videoContainer.querySelector('video');
                 if(video) togglePlay(video);
                 event.stopPropagation();
                 return;
             }

             // Menu Button Click
             const menuButton = target.closest('.menu-btn');
             if (menuButton && publicId) {
                 toggleActionMenu(publicId, menuButton);
                 event.stopPropagation();
                 return;
             }

             // Action Popup Button Click (Rename/Delete)
             const actionButton = target.closest('.action-popup button');
             if (actionButton && publicId) {
                 const popup = actionButton.closest('.action-popup');
                 if (popup) popup.style.display = 'none';
                 const parentMenuButton = $(`button[aria-controls="${popup?.id}"]`);
                 if(parentMenuButton) parentMenuButton.setAttribute('aria-expanded', 'false');

                 if (actionButton.textContent.includes('Rename')) {
                    triggerRename(publicId);
                 } else if (actionButton.classList.contains('delete-action')) {
                    triggerDelete(publicId);
                 }
                 event.stopPropagation();
                 return;
             }

             // Download Button Click (Trigger count increment)
             const downloadBtn = target.closest('.download-btn');
             if (downloadBtn && publicId) {
                log(`Download button clicked for ${publicId}.`);

                // --- DOWNLOAD COUNT INCREMENT (Requires Backend) ---
                if (DOWNLOAD_INCREMENT_ENDPOINT_BASE && DOWNLOAD_INCREMENT_ENDPOINT_BASE !== '/increment_download') { // Basic check if configured
                    const incrementUrl = `${DOWNLOAD_INCREMENT_ENDPOINT_BASE}/${encodeURIComponent(publicId)}`;
                    log(`Sending download increment request to: ${incrementUrl}`);

                    // Optimistic UI Update (do this immediately)
                    try {
                         const countEl = card?.querySelector('.download-count');
                         const videoDataIndex = allVideos.findIndex(v => v?.public_id === publicId);
                         let currentCount = 0;

                         // Get current count from data object if possible, fallback to UI text
                         if (videoDataIndex > -1 && typeof allVideos[videoDataIndex]?.download_count === 'number') {
                             currentCount = allVideos[videoDataIndex].download_count;
                         } else if (countEl) {
                            const currentCountText = countEl.textContent || '0';
                            currentCount = parseInt(currentCountText.replace(/[^0-9]/g, ''), 10) || 0;
                         }

                         const newCount = currentCount + 1;

                         // Update UI
                         if (countEl) {
                            countEl.innerHTML = `<i class="fas fa-download" aria-hidden="true"></i> ${newCount.toLocaleString()}`;
                            countEl.title = `${newCount.toLocaleString()} downloads`;
                         } else if (card) { // If count element didn't exist before (was 0 maybe)
                            const metaInfo = card.querySelector('.meta-info');
                            if (metaInfo) {
                                // Create and prepend the count element
                                const newCountEl = document.createElement('span');
                                newCountEl.className = 'download-count';
                                newCountEl.innerHTML = `<i class="fas fa-download" aria-hidden="true"></i> ${newCount.toLocaleString()}`;
                                newCountEl.title = `${newCount.toLocaleString()} downloads`;
                                metaInfo.insertBefore(newCountEl, metaInfo.firstChild); // Add to the start of meta-info
                            }
                         }

                         // Update data array
                         if (videoDataIndex > -1) {
                             allVideos[videoDataIndex].download_count = newCount;
                             // Also update displayedVideos if it's a separate reference (it is)
                             const displayedIndex = displayedVideos.findIndex(v => v?.public_id === publicId);
                             if (displayedIndex > -1) {
                                 displayedVideos[displayedIndex].download_count = newCount;
                             }
                             log(`Optimistically updated download count for ${publicId} to ${newCount} in memory and UI.`);
                         }
                    } catch (uiError) {
                         err("Error during optimistic UI update for download count:", uiError);
                    }


                    // Send request to backend
                    if (navigator.sendBeacon) {
                         navigator.sendBeacon(incrementUrl, new Blob()); // sendBeacon requires body, even if empty POST
                         log(`Sent beacon for download increment: ${publicId}`);
                    } else {
                        fetch(incrementUrl, { method: 'POST', cache: 'no-store', keepalive: true })
                            .then(response => {
                                if (!response.ok) {
                                    log(`Failed to increment download count for ${publicId} on server (status: ${response.status}). UI was already updated optimistically.`);
                                    // Optionally revert optimistic update here if needed, but usually not worth it
                                } else {
                                    log(`Server successfully incremented download count for ${publicId}.`);
                                }
                            })
                            .catch(fetchErr => err(`Error sending download increment for ${publicId}:`, fetchErr));
                    }
                } else {
                     log("Download increment endpoint not configured or default placeholder used, skipping backend count update.");
                }
                // Do NOT stop propagation or prevent default here.
                // Let the browser handle the actual file download via the <a> tag's href.
             }
        }


        // --- Intro & Terms Flow ---
        function handleIntro() {
            log("Starting intro...");
            const introScreen = safeGetElementById('introScreen');
            if (!introScreen || introScreen.classList.contains('fade-out')) {
                log("Intro screen skipped or already faded.");
                checkTerms(); return;
            }
            setTimeout(() => {
                log("Fading intro out.");
                if (introScreen) {
                    introScreen.classList.add('fade-out');
                    introScreen.addEventListener('transitionend', (e) => {
                        if (e.propertyName === 'opacity' && introScreen.classList.contains('fade-out')) {
                             checkTerms();
                         }
                    }, { once: true });
                 } else { checkTerms(); }
            }, 2800);
        }

        function checkTerms() {
            log("Checking terms acceptance...");
            if (localStorage.getItem('termsAccepted') !== 'true') {
                log("Terms not accepted, showing modal.");
                showTermsModal(false);
            } else {
                log("Terms accepted, initializing page.");
                initializePage();
            }
        }

        function showTermsModal(isViewingOnly = false) {
             log(`Show terms modal (view only: ${isViewingOnly})`);
             const modal = safeGetElementById('termsModal');
             const acceptWrapper = safeGetElementById('termsAcceptWrapper');
             const acceptBtn = safeGetElementById('termsAcceptBtn');
             const closeBtn = safeGetElementById('termsCloseBtn');
             const errorMsg = safeGetElementById('termsError');
             if (!modal || !acceptWrapper || !acceptBtn || !closeBtn || !errorMsg) {
                 err("One or more terms modal elements not found.");
                 return;
             }

             errorMsg.textContent = '';
             const checkbox = safeGetElementById('termsAcceptCheckbox');
             if (checkbox) checkbox.checked = false;

             acceptWrapper.style.display = isViewingOnly ? 'none' : 'flex';
             acceptBtn.style.display = isViewingOnly ? 'none' : 'inline-flex';
             closeBtn.textContent = isViewingOnly ? 'Close' : 'Disagree';
             acceptBtn.disabled = false;

             showModal('termsModal');
             safeGetElementById('termsModal')?.querySelector('.terms-content')?.focus();
        }

        function acceptTerms() {
            log("Accept terms clicked.");
            const checkbox = safeGetElementById('termsAcceptCheckbox');
            const errorMsg = safeGetElementById('termsError');
            const acceptBtn = safeGetElementById('termsAcceptBtn');
            if (!checkbox || !errorMsg || !acceptBtn) return;

            acceptBtn.disabled = true;

            if (checkbox.checked) {
                log("Terms accepted by user.");
                localStorage.setItem('termsAccepted', 'true');
                hideModal('termsModal');
                initializePage();
            } else {
                errorMsg.textContent = 'Please check the box to accept the terms and conditions.';
                 acceptBtn.disabled = false;
            }
        }

        // --- Main Page Initialization ---
        function initializePage() {
            log("Initializing main page.");
            setActiveFilterButton();
            updateFooterYear();
            fetchAndRenderVideos();
            log("Main page initialized.");
        }

        function updateFooterYear() {
            const yearSpan = safeGetElementById('currentYear');
            if (yearSpan) yearSpan.textContent = new Date().getFullYear();
        }

        // --- Modal Helpers (Generic Prompt) ---
        function showPromptModal({ title, contentHTML = '', inputLabel = '', inputType = 'text', placeholder = '', confirmText = 'Confirm', cancelText = 'Cancel', callback, initialValue = '', isConfirmation = false, confirmClass = '', showSpinner = false }) {
            log(`Showing prompt modal: "${title}" (isConfirmation: ${isConfirmation}, showSpinner: ${showSpinner})`);
            const modalId = 'promptModal';
            const titleEl = safeGetElementById('promptTitle');
            const contentDiv = safeGetElementById('promptContent');
            const confirmBtn = safeGetElementById('promptConfirmBtn');
            const cancelBtn = safeGetElementById('promptCancelBtn');
            const errorEl = safeGetElementById('promptError');
            const spinnerEl = safeGetElementById('promptSpinner');

            if (!titleEl || !contentDiv || !confirmBtn || !cancelBtn || !errorEl || !spinnerEl) {
                err("Prompt modal elements missing.");
                return;
            }

            // Reset elements
            titleEl.innerHTML = title;
            contentDiv.innerHTML = ''; // Clear previous dynamic content
            errorEl.innerText = '';
            errorEl.style.display = 'none';
            spinnerEl.style.display = showSpinner ? 'block' : 'none'; // Show/hide spinner
            contentDiv.appendChild(errorEl); // Ensure error element is part of the content div

             // Disable buttons if spinner is shown initially
             confirmBtn.disabled = showSpinner;
             cancelBtn.disabled = showSpinner;

            // Set button classes and text
            confirmBtn.className = 'modal-button-confirm'; // Reset to base confirm class
             if (confirmClass) {
                 confirmBtn.classList.add(...confirmClass.split(' '));
             }
            confirmBtn.textContent = confirmText;
            cancelBtn.textContent = cancelText;

            let inputEl = null;

            if (isConfirmation) {
                log("Setting up prompt as confirmation.");
                const p = document.createElement('p');
                p.innerHTML = contentHTML;
                contentDiv.insertBefore(p, errorEl);
            } else {
                 log("Setting up prompt with input.");
                 if(contentHTML) {
                    const staticContent = document.createElement('div');
                    staticContent.innerHTML = contentHTML;
                    contentDiv.insertBefore(staticContent, errorEl);
                 }
                 const labelEl = document.createElement('label');
                 labelEl.htmlFor = 'promptInput';
                 labelEl.innerText = inputLabel;
                 labelEl.className = 'block mb-2 font-semibold text-sm';

                 inputEl = document.createElement('input');
                 inputEl.type = inputType;
                 inputEl.id = 'promptInput';
                 inputEl.placeholder = placeholder;
                 inputEl.value = initialValue;
                 const theme = document.documentElement.getAttribute('data-theme') || 'dark';
                 const baseInputClasses = "w-full p-3 rounded-lg border transition-colors duration-200 focus:outline-none focus:ring-2 mb-1";
                 const themeInputClasses = theme === 'light'
                    ? "bg-gray-100 border-gray-300 text-gray-900 focus:border-blue-400 focus:ring-blue-200"
                    : "bg-gray-700 border-gray-600 text-white focus:border-blue-500 focus:ring-blue-400 focus:ring-opacity-50";
                 inputEl.className = `${baseInputClasses} ${themeInputClasses}`;
                 inputEl.setAttribute('aria-label', inputLabel);

                 contentDiv.insertBefore(labelEl, errorEl);
                 contentDiv.insertBefore(inputEl, errorEl);
            }

            currentPromptCallback = callback;

            // Re-attach event listener using cloning
            const newConfirmBtn = confirmBtn.cloneNode(true);
            newConfirmBtn.disabled = showSpinner; // Ensure button state matches spinner
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            safeGetElementById('promptConfirmBtn').addEventListener('click', handlePromptConfirm);

            const newCancelBtn = cancelBtn.cloneNode(true);
            newCancelBtn.disabled = showSpinner; // Ensure button state matches spinner
            newCancelBtn.setAttribute('data-action', 'close-prompt');
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);

            showModal(modalId);

            // Focus logic (don't focus if spinner is shown)
            if (!showSpinner) {
                 if (inputEl) {
                     log("Focusing prompt input.");
                     setTimeout(() => inputEl.focus(), 100);
                 } else if (isConfirmation) {
                     log("Focusing prompt confirm button.");
                     setTimeout(() => safeGetElementById('promptConfirmBtn')?.focus(), 100);
                 }
            }
        }


        function handlePromptConfirm() {
            log("Prompt confirm button clicked.");
             const confirmBtn = safeGetElementById('promptConfirmBtn');
             const cancelBtn = safeGetElementById('promptCancelBtn');
             const spinnerEl = safeGetElementById('promptSpinner');

            if (currentPromptCallback) {
                const input = safeGetElementById('promptInput');
                const value = input ? input.value : true;
                log("Executing prompt callback with value:", input ? '(input value)' : value);

                 // Optionally show spinner and disable buttons before executing callback if it's async
                 if (spinnerEl && confirmBtn && cancelBtn) {
                     spinnerEl.style.display = 'block';
                     confirmBtn.disabled = true;
                     cancelBtn.disabled = true;
                     log("Spinner shown, buttons disabled.");
                 }

                 // Execute the callback (which might be async)
                Promise.resolve(currentPromptCallback(value))
                    .catch(err => {
                        // Handle potential errors within the callback itself
                        showPromptError(`Error during action: ${err.message || err}`);
                        err("Error executing prompt callback:", err);
                    })
                    .finally(() => {
                        log("Callback execution finished (or caught error).");
                        // Hide spinner and re-enable buttons IF the modal wasn't hidden by the callback
                         const modalStillVisible = safeGetElementById('promptModal')?.style.display === 'flex';
                         if (modalStillVisible && spinnerEl && confirmBtn && cancelBtn) {
                            spinnerEl.style.display = 'none';
                            confirmBtn.disabled = false;
                            cancelBtn.disabled = false;
                            log("Spinner hidden, buttons re-enabled.");
                         }
                    });

                // NOTE: The callback itself is now responsible for calling hidePromptModal()
                // or showPromptError() as needed. This function only handles showing the spinner
                // and re-enabling buttons if the modal stays open.

            } else {
                err("No callback registered for prompt confirmation.");
                hidePromptModal(); // Close anyway if no callback found
            }
        }

        function hidePromptModal() {
            hideModal('promptModal');
            currentPromptCallback = null; // Clear callback when closing
        }

         function showPromptError(message) {
            log("Showing prompt error:", message);
            const errorElement = safeGetElementById('promptError');
            if (errorElement) {
                errorElement.innerText = message;
                errorElement.style.display = message ? 'block' : 'none'; // Show only if message exists
            } else {
                err("Cannot show prompt error, element #promptError not found.");
            }
        }

         function showUploadSuccessPopup(uploaderName, count) {
            log(`Showing success popup for ${count} uploads by ${uploaderName}`);
            const uploaderSpan = safeGetElementById('successUploaderName');
            const summaryText = safeGetElementById('successSummaryText');

            if (uploaderSpan) uploaderSpan.innerText = uploaderName || 'Anonymous';
            if (summaryText) {
                summaryText.innerText = count === 1
                    ? 'Your overlay is now live.'
                    : `Your ${count} overlays are now live.`;
            }
            showModal('uploadSuccessPopup');
        }


        // --- Theme Toggle ---
         function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            log(`Initializing theme: ${savedTheme}`);
            document.documentElement.setAttribute('data-theme', savedTheme);
             setActiveFilterButton();
        }

        function toggleTheme() {
             const html = document.documentElement;
             const currentTheme = html.getAttribute('data-theme') || 'dark';
             const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
             log(`Toggling theme from ${currentTheme} to ${newTheme}`);
             html.setAttribute('data-theme', newTheme);
             localStorage.setItem('theme', newTheme);
             setActiveFilterButton();
             const promptInput = safeGetElementById('promptInput');
             if (promptInput && safeGetElementById('promptModal')?.style.display === 'flex') {
                  const baseInputClasses = "w-full p-3 rounded-lg border transition-colors duration-200 focus:outline-none focus:ring-2 mb-1";
                  const themeInputClasses = newTheme === 'light'
                    ? "bg-gray-100 border-gray-300 text-gray-900 focus:border-blue-400 focus:ring-blue-200"
                    : "bg-gray-700 border-gray-600 text-white focus:border-blue-500 focus:ring-blue-400 focus:ring-opacity-50";
                 promptInput.className = `${baseInputClasses} ${themeInputClasses}`;
             }
        }

        // --- Upload Logic (Modified for Multiple Files) ---
        function openCloudinaryUpload() {
            log("Initiating Cloudinary upload process (multiple enabled)...");
            const uploaderNameInput = safeGetElementById('uploaderNameInput');
            const delPassInput = safeGetElementById('deletePassword');
            const progressBar = safeGetElementById('progressBar');
            const progressContainer = safeGetElementById('progressContainer');
            const status = safeGetElementById('uploadStatus');
            const uploadButton = safeGetElementById('selectUploadBtn');

            if (!uploaderNameInput || !delPassInput || !progressBar || !progressContainer || !status || !uploadButton) {
                err("Upload modal elements missing.");
                if(status) status.innerText = 'âŒ Internal error: Missing form elements.';
                return;
            }
             if (!CLOUD_NAME || !UPLOAD_PRESET) {
                 err("Cloudinary CLOUD_NAME or UPLOAD_PRESET is not configured in the script.");
                 status.innerText = 'âŒ Configuration Error: Cloudinary details missing.';
                 return;
             }

            const uploaderName = uploaderNameInput.value.trim() || 'Anonymous';
            const delPass = delPassInput.value.trim();

            if (!delPass) {
                status.innerText = "âŒ Deletion password is required.";
                delPassInput.focus(); return;
            }
             if (delPass.length < 6) {
                 status.innerText = "âŒ Password must be at least 6 characters.";
                 delPassInput.focus(); return;
             }

            status.innerText = 'Initializing widget...';
            progressBar.style.width = '0%';
            progressContainer.style.display = 'block';
            uploadButton.disabled = true;
            successfulUploads = [];

            try {
                 if (typeof cloudinary === 'undefined' || typeof cloudinary.openUploadWidget !== 'function') {
                     throw new Error("Cloudinary script not loaded or invalid.");
                 }

                 const widget = cloudinary.openUploadWidget({
                    cloudName: CLOUD_NAME, uploadPreset: UPLOAD_PRESET,
                    sources: ['local', 'url', 'camera', 'dropbox', 'google_drive'],
                    resourceType: 'video',
                    multiple: true,
                    clientAllowedFormats: ['mp4', 'webm', 'mov'],
                    folder: 'gs_overlay',
                    theme: document.documentElement.getAttribute("data-theme") || "dark"
                }, (error, result) => {
                    const currentUploadButton = safeGetElementById('selectUploadBtn');
                    const currentStatus = safeGetElementById('uploadStatus');
                    const currentProgressBar = safeGetElementById('progressBar');
                    const currentProgressContainer = safeGetElementById('progressContainer');

                    if (error) {
                        err("Cloudinary Widget Error:", error);
                        if(currentStatus) currentStatus.innerText = `âŒ Error: ${error.statusText || error.message || 'Upload failed'}`;
                        if(currentProgressContainer) currentProgressContainer.style.display = 'none';
                        if(currentUploadButton) currentUploadButton.disabled = false;
                        successfulUploads = [];
                    } else if (result && result.event) {
                        log("Cloudinary Event:", result.event, result.info || '');
                        switch (result.event) {
                            case "upload-added":
                                if(currentStatus) currentStatus.innerText = `Adding file(s)...`;
                                if (currentProgressBar) currentProgressBar.style.width = `0%`;
                                if(currentProgressContainer) currentProgressContainer.style.display = 'block';
                                break;
                            case "uploadprogress":
                                if (result.info && typeof result.info.bytes_uploaded === 'number' && result.info.total_bytes) {
                                    const percent = Math.round((result.info.bytes_uploaded / result.info.total_bytes) * 100);
                                    if (currentProgressBar) {
                                        currentProgressBar.style.width = `${percent}%`;
                                        currentProgressBar.setAttribute('aria-valuenow', percent);
                                    }
                                    const filename = result.info.original_filename || 'current file';
                                    if(currentStatus) currentStatus.innerText = `Uploading ${filename}... ${percent}%`;
                                } else {
                                    if(currentStatus) currentStatus.innerText = `Uploading...`;
                                }
                                break;
                            case "success":
                                log("Cloudinary Success (single file):", result.info);
                                if (!result.info?.public_id || !result.info?.secure_url) {
                                     err("Cloudinary success event missing critical data:", result.info);
                                     if(currentStatus) currentStatus.innerText = `âŒ Error: Upload data incomplete for one file.`;
                                     return;
                                }
                                successfulUploads.push(result.info);
                                if(currentStatus) currentStatus.innerText = `âœ… ${successfulUploads.length} file(s) uploaded successfully. Finishing...`;
                                if (currentProgressBar) {
                                    currentProgressBar.style.width = '100%';
                                    currentProgressBar.setAttribute('aria-valuenow', 100);
                                }
                                break;
                             case "close":
                                log("Cloudinary Widget Closed.");
                                handleMultipleUploadSuccess(uploaderName, delPass);
                                if (currentUploadButton) currentUploadButton.disabled = false;
                                break;
                            case "abort":
                            case "queue-too-large":
                            case "bytes-total-exceeded":
                            case "max-files-exceeded":
                                const eventText = result.event.replace(/-/g, ' ');
                                err(`Cloudinary Upload Error: ${eventText}`, result.info || '');
                                if(currentStatus) currentStatus.innerText = `âŒ Upload Error: ${eventText}`;
                                if(currentProgressContainer) currentProgressContainer.style.display = 'none';
                                if(currentUploadButton) currentUploadButton.disabled = false;
                                successfulUploads = [];
                                break;
                            default:
                                break;
                        }
                    }
                });
            } catch (widgetError) {
                err("Error opening Cloudinary Widget:", widgetError);
                if(status) status.innerText = "âŒ Failed to open upload widget. Script might be missing or misconfigured.";
                if(progressContainer) progressContainer.style.display = 'none';
                if (uploadButton) uploadButton.disabled = false;
                successfulUploads = [];
            }
        }

        function handleMultipleUploadSuccess(uploaderName, delPass) {
            log(`Processing ${successfulUploads.length} successful uploads.`);
            const currentStatus = safeGetElementById('uploadStatus');
            const currentProgressContainer = safeGetElementById('progressContainer');

            if (successfulUploads.length === 0) {
                log("No successful uploads to process.");
                if (currentStatus && !currentStatus.innerText.includes('Error')) {
                     currentStatus.innerText = 'Widget closed or cancelled.';
                }
                 if(currentProgressContainer) currentProgressContainer.style.display = 'none';
                return;
            }

            const newVideoEntries = [];
            let localSaveError = false;

            try {
                successfulUploads.forEach(uploadInfo => {
                    const publicId = uploadInfo.public_id;
                    const originalFilename = uploadInfo.original_filename;
                    const secureUrl = uploadInfo.secure_url;

                    if (!publicId || !secureUrl) {
                        err("Skipping an upload due to missing data:", uploadInfo);
                        return;
                    }

                    localStorage.setItem(`pass_${publicId}`, delPass);
                    uploaderNames[publicId] = uploaderName;
                     if (originalFilename) {
                         localStorage.setItem(`filename_${publicId}`, originalFilename);
                     }

                    const newVideoData = {
                        public_id: publicId,
                        created_at: new Date().toISOString(),
                        secure_url: secureUrl,
                        original_filename: originalFilename || null,
                        download_count: 0 // Initialize download count to 0 for new uploads
                    };
                    newVideoEntries.push(newVideoData);
                });

                localStorage.setItem('uploaderNames', JSON.stringify(uploaderNames));
                log(`Passwords, uploader names, and filenames saved locally for ${newVideoEntries.length} uploads.`);

            } catch(e) {
                err("Error saving passwords/uploader names/filenames to localStorage:", e);
                 if(currentStatus) currentStatus.innerText = 'âœ… Uploaded, but failed to save some data locally!';
                localSaveError = true;
            }

            allVideos.unshift(...newVideoEntries);
            log(`Added ${newVideoEntries.length} new videos to the main list.`);

            applyFiltersAndRender(true);

            hideModal('uploadPopup');
            showUploadSuccessPopup(uploaderName, newVideoEntries.length);

            successfulUploads = [];
        }


        // --- Filtering & Sorting ---
        function setActiveFilterButton(buttonElement = null) {
             const theme = document.documentElement.getAttribute("data-theme") || "dark";
             const baseClasses = {
                inactive: ['border-transparent', 'opacity-80', 'hover:opacity-100'],
                active: ['border-2', 'shadow-md', 'opacity-100', 'active-filter']
             };
             const themeClasses = {
                 dark: {
                     inactive: ['bg-gray-600', 'text-gray-100', 'hover:bg-gray-500'],
                     active: ['bg-green-500', 'text-black', 'border-green-600', 'shadow-lg', 'shadow-green-500/30']
                 },
                 light: {
                     inactive: ['bg-gray-300', 'text-gray-700', 'hover:bg-gray-400'],
                     active: ['bg-indigo-600', 'text-white', 'border-indigo-700', 'shadow-lg', 'shadow-indigo-500/30']
                 }
             };
             const currentThemeClasses = theme === 'light' ? themeClasses.light : themeClasses.dark;
             const allPossibleClasses = [
                 ...baseClasses.inactive, ...baseClasses.active,
                 ...themeClasses.dark.inactive, ...themeClasses.dark.active,
                 ...themeClasses.light.inactive, ...themeClasses.light.active,
                 'active-filter'
             ].filter(Boolean);

             if (!buttonElement) {
                 buttonElement = $(`.filter-options .filter-btn[data-filter="${currentFilter}"]`);
             }

             $$('.filter-options .filter-btn').forEach(btn => {
                 btn.classList.remove(...allPossibleClasses);
                 btn.setAttribute('aria-selected', 'false');
                 if (btn === buttonElement) {
                     btn.classList.add(...baseClasses.active, ...currentThemeClasses.active);
                     btn.setAttribute('aria-selected', 'true');
                 } else {
                     btn.classList.add(...baseClasses.inactive, ...currentThemeClasses.inactive);
                 }
             });

             if(buttonElement) {
                 log(`Active filter button style set for ${currentFilter} on theme ${theme}`);
             } else {
                 log(`setActiveFilterButton called but could not find button for filter ${currentFilter}`);
                 const defaultBtn = safeGetElementById('filter-recent');
                 if (defaultBtn && currentFilter === 'recent') {
                     defaultBtn.classList.remove(...allPossibleClasses);
                     defaultBtn.classList.add(...baseClasses.active, ...currentThemeClasses.active);
                     defaultBtn.setAttribute('aria-selected', 'true');
                      log(`Applied active style to default 'recent' button.`);
                 }
             }
        }

        // --- Video Loading, Filtering, Sorting & Rendering ---
        async function fetchAndRenderVideos() {
            if (isFetching) {
                log("Fetch already in progress, skipping.");
                return;
            }
            isFetching = true;
            log("Fetching initial video list...");
            const gallery = safeGetElementById("gallery");
            const loadMoreBtn = safeGetElementById('loadMoreBtn');

            if (!gallery || !loadMoreBtn) {
                err("Gallery or Load More button not found during fetch.");
                isFetching = false;
                return;
            }

             displayGalleryMessage('ðŸ”„ Fetching video list...', 'info');
             loadMoreBtn.style.display = 'none';
             loadMoreBtn.disabled = true;

            // --- BACKEND REQUIRED ---
            // Fetch video data from your backend endpoint.
            // Expected JSON format: Array of objects, each with at least:
            // {
            //   "public_id": "string",
            //   "secure_url": "string_url",
            //   "created_at": "string_iso_date",
            //   "original_filename": "string_optional",
            //   "download_count": number // *** EXPECTED for download count & popular sort ***
            // }
            try {
                log(`Fetching from endpoint: ${VIDEO_FETCH_ENDPOINT}`);
                const response = await fetch(VIDEO_FETCH_ENDPOINT, { cache: 'no-store' });

                if (!response.ok) {
                    // --- FRONTEND ONLY FALLBACK (Example - For testing without backend) ---
                    if (response.status === 404 && (VIDEO_FETCH_ENDPOINT === '/videos' || !VIDEO_FETCH_ENDPOINT)) { // Check if using default or empty endpoint
                         log("Backend endpoint '/videos' not found (404) or not configured. Using localStorage videos only (limited data, no download counts).");
                         allVideos = Object.keys(localStorage)
                             .filter(key => key.startsWith('pass_'))
                             .map(key => {
                                 const publicId = key.substring(5);
                                 const storedFilename = localStorage.getItem(`filename_${publicId}`);
                                 return {
                                     public_id: publicId,
                                     secure_url: `https://res.cloudinary.com/${CLOUD_NAME}/video/upload/${publicId}.mp4`, // Guess URL
                                     created_at: new Date(0).toISOString(), // Placeholder date
                                     original_filename: storedFilename || null,
                                     download_count: 0 // Set to 0 in fallback
                                 };
                             });
                        if (allVideos.length === 0) {
                             displayGalleryMessage('ðŸ“ª No videos found locally! Be the first to upload.', 'empty');
                             isFetching = false;
                             return;
                         }
                         log(`Loaded ${allVideos.length} videos from localStorage (fallback mode).`);
                         clearGalleryMessages();
                         applyFiltersAndRender(true);
                         isFetching = false;
                         return;
                    }
                    // --- End Frontend Only Fallback ---

                    let errorMsg = `Server Error: ${response.status} ${response.statusText}`;
                    try { const errorData = await response.json(); errorMsg = errorData.message || errorData.error || errorMsg; }
                    catch (e) { try { const text = await response.text(); if(text) errorMsg += ` - ${text.substring(0,100)}`; } catch(e2){} }
                    throw new Error(errorMsg);
                }

                allVideos = await response.json();

                if (!Array.isArray(allVideos)) {
                    err("Invalid data format received from server (expected an array).", allVideos);
                    throw new Error("Invalid data format received from server.");
                }
                log(`Fetched ${allVideos.length} total videos from backend.`);

                if (allVideos.length === 0) {
                     displayGalleryMessage('ðŸ“ª No videos found yet! Be the first to upload.', 'empty');
                     isFetching = false;
                     return;
                 }

                 clearGalleryMessages();
                 applyFiltersAndRender(true);

            } catch (error) {
                err("Failed to fetch videos:", error);
                const displayMessage = error instanceof Error ? error.message : String(error);
                 const backendNeededMsg = (VIDEO_FETCH_ENDPOINT === '/videos' && displayMessage.includes('404'))
                    ? " (Backend endpoint seems missing or not configured. Using local fallback if possible.)"
                    : "";
                displayGalleryMessage(`âŒ Error loading videos: ${displayMessage}.${backendNeededMsg}`, 'error');
                loadMoreBtn.style.display = 'none';
            } finally {
                isFetching = false;
            }
        }

         // --- Gallery Message Helpers ---
         function displayGalleryMessage(message, type = 'info') {
             const gallery = safeGetElementById("gallery");
             if (!gallery) return;
             clearGalleryMessages();
             const msgElement = document.createElement('p');
             msgElement.className = `gallery-message ${type}`;
             msgElement.textContent = message;
             gallery.appendChild(msgElement);
         }

         function clearGalleryMessages() {
            const gallery = safeGetElementById("gallery");
            if (!gallery) return;
            const messages = gallery.querySelectorAll('.gallery-message');
            messages.forEach(msg => msg.remove());
            const initialLoadingMsg = safeGetElementById('gallery-loading-msg');
            if(initialLoadingMsg) initialLoadingMsg.remove();
         }

        function applyFiltersAndRender(resetRendering = false) {
            log(`Applying filters. Filter: ${currentFilter}, Search: "${currentSearchQuery}", Reset: ${resetRendering}`);
            const gallery = safeGetElementById("gallery");
            if (!gallery) return;

            clearGalleryMessages();

            // Filtering by Search Query
            let filtered = allVideos;
            if (currentSearchQuery) {
                const query = currentSearchQuery.toLowerCase();
                filtered = allVideos.filter(video => {
                    if (!video || !video.public_id) return false;
                    const originalFilename = video.original_filename || localStorage.getItem(`filename_${video.public_id}`);
                    const title = (renamedTitles[video.public_id] || formatTitle(video.public_id, originalFilename)).toLowerCase();
                    const uploader = (uploaderNames[video.public_id] || 'Anonymous').toLowerCase();
                    return title.includes(query) || uploader.includes(query);
                });
                log(`Filtered by search "${query}", ${filtered.length} results.`);
            } else {
                 filtered = [...allVideos];
            }

            // Sorting
             log(`Sorting ${filtered.length} videos by ${currentFilter}`);
             try {
                switch (currentFilter) {
                    case 'popular':
                        // Sort by download_count descending (requires backend data)
                        filtered.sort((a, b) => (b?.download_count ?? -1) - (a?.download_count ?? -1)); // Put items without count last
                        log("Sorted by 'popular' (using download_count).");
                        break;
                    case 'recent': default:
                         filtered.sort((a, b) => {
                             const dateA = a?.created_at ? new Date(a.created_at).getTime() : 0;
                             const dateB = b?.created_at ? new Date(b.created_at).getTime() : 0;
                             if (isNaN(dateA) && isNaN(dateB)) return 0;
                             if (isNaN(dateA)) return 1;
                             if (isNaN(dateB)) return -1;
                             return dateB - dateA; // Descending
                         });
                         log("Sorted by 'recent'.");
                         break;
                }
            } catch (e) {
                err("Error during sorting:", e);
            }

            displayedVideos = filtered;

            // Rendering
            if (resetRendering) {
                currentVideoIndex = 0;
                gallery.innerHTML = '';
                if (displayedVideos.length > 0) {
                    displayGalleryMessage('ðŸ”„ Applying Filters & Loading...', 'info');
                    setTimeout(() => renderVideoBatch(true), 100);
                } else {
                    renderVideoBatch(true); // Show "no results" immediately
                }
            } else {
                 renderVideoBatch(false);
            }
        }

        // Refactored card creation logic
        function createVideoCardHTML(file) {
             if (!file || !file.public_id || !file.secure_url) {
                 err(`Skipping invalid video data in createVideoCardHTML:`, file);
                 return ''; // Return empty string if data is invalid
             }
             const publicId = file.public_id;
             const safeId = publicId.replace(/[^a-zA-Z0-9_-]/g, '_');
             const originalFilename = file.original_filename || localStorage.getItem(`filename_${publicId}`);
             const title = renamedTitles[publicId] || formatTitle(publicId, originalFilename);
             const uploader = uploaderNames[publicId] || 'Anonymous';
             const videoUrl = file.secure_url;
             // Use nullish coalescing for default 0, handle potential non-number values gracefully
             const downloadCount = typeof file.download_count === 'number' && !isNaN(file.download_count) ? file.download_count : null;

             // Cloudinary thumbnail URL (frame at 1 second)
             const thumbnailUrl = `https://res.cloudinary.com/${CLOUD_NAME}/video/upload/w_300,h_169,c_fill,q_auto,f_auto,so_1/${publicId}.jpg`;
             const safeDownloadFilename = `${title.replace(/[^a-z0-9_\-.]/gi, '_')}.mp4`;

             // Conditionally create download count HTML
             const downloadCountHTML = (downloadCount !== null && downloadCount >= 0)
                 ? `<span class="download-count" title="${downloadCount.toLocaleString()} downloads"><i class="fas fa-download" aria-hidden="true"></i> ${downloadCount.toLocaleString()}</span>`
                 : '<div class="download-count-placeholder" style="min-width: 40px;"></div>'; // Placeholder for alignment

             return `
                <div class="card" data-public-id="${publicId}" ${file.original_filename ? `data-original-filename="${file.original_filename}"` : ''} style="animation-delay: inherit;"> <!-- Inherit delay from JS -->
                    <div class="video-container">
                        <video muted playsinline loop preload="metadata" poster="${thumbnailUrl}" title="Click to play/pause: ${title}" data-public-id="${publicId}">
                            <source src="${videoUrl}" type="video/mp4">
                            <source src="${videoUrl.replace(/\.mp4$/, '.webm')}" type="video/webm">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                    <div class="card-content">
                        <div class="card-title" title="${title}">${title}</div>
                         <div class="meta-info"> <!-- Flex container for uploader and download count -->
                             ${downloadCountHTML}
                             <div class="uploader-name" title="Uploaded by ${uploader}">by ${uploader}</div>
                         </div>
                    </div>
                    <div class="card-footer">
                        <a href="${videoUrl}" download="${safeDownloadFilename}" class="download-btn" title="Download ${title}">
                             <i class="fas fa-download" aria-hidden="true"></i><span class="ml-1">Download</span>
                        </a>
                        <button type="button" class="menu-btn" title="Video Options" aria-haspopup="true" aria-expanded="false" aria-controls="actionPopup_${safeId}">
                            <i class="fas fa-ellipsis-h" aria-hidden="true"></i>
                            <span class="sr-only">Options for ${title}</span>
                        </button>
                    </div>
                    <div class="action-popup" id="actionPopup_${safeId}" role="menu">
                        <button type="button" role="menuitem"><i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>Rename</button>
                        <button type="button" role="menuitem" class="delete-action"><i class="fas fa-trash-alt fa-fw" aria-hidden="true"></i>Delete</button>
                    </div>
                </div>
            `;
        }


        function renderVideoBatch(isInitialRender = false) {
            const gallery = safeGetElementById("gallery");
            const loadMoreBtn = safeGetElementById('loadMoreBtn');
            if (!gallery || !loadMoreBtn) return;

             const loadingMsg = gallery.querySelector('.gallery-message.info');
             if (loadingMsg && loadingMsg.textContent.includes('Loading')) {
                loadingMsg.remove();
             }

            const fragment = document.createDocumentFragment();
            const startIndex = currentVideoIndex;
            const endIndex = Math.min(startIndex + VIDEOS_PER_LOAD, displayedVideos.length);

            log(`Rendering batch from index ${startIndex} to ${endIndex - 1} (Total filtered/sorted: ${displayedVideos.length})`);

             if (isInitialRender && displayedVideos.length === 0) {
                 const message = currentSearchQuery
                               ? `ðŸ“ª No results found for "${currentSearchQuery}". Try a different search?`
                               : (allVideos.length === 0 ? 'ðŸ“ª No videos found yet! Be the first to upload.' : 'ðŸ“ª No videos match the current filter.');
                 displayGalleryMessage(message, 'empty');
                 loadMoreBtn.style.display = 'none';
                 return;
             }

            if (startIndex >= endIndex && !isInitialRender) {
                 log("No more videos to render in this batch call.");
            } else if (startIndex < endIndex) {
                 loadMoreBtn.disabled = true;
                 loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>Loading...';
            }

            for (let i = startIndex; i < endIndex; i++) {
                const file = displayedVideos[i];
                const cardHTML = createVideoCardHTML(file); // Use the new function
                if (cardHTML) {
                     // Create a temporary container to parse the HTML string
                     const tempContainer = document.createElement('div');
                     tempContainer.innerHTML = cardHTML;
                     const cardElement = tempContainer.firstChild;
                     // Apply animation delay directly here
                     cardElement.style.animationDelay = `${(i - startIndex) * 0.05}s`;
                     fragment.appendChild(cardElement);
                }
            }

            gallery.appendChild(fragment);
            currentVideoIndex = endIndex;

            updateLoadMoreButtonState();
        }

        function formatTitle(publicId, originalFilename = null) {
             let nameSource = originalFilename || publicId || '';
             if (!nameSource) return "Untitled Video";
            try {
                let name = nameSource.includes('/') ? nameSource.substring(nameSource.lastIndexOf('/') + 1) : nameSource;
                name = name.replace(/\.(mp4|webm|mov|avi|mkv|wmv|flv)$/i, "");
                name = name.replace(/[_\-\.]+/g, ' ');
                name = name.replace(/([a-z])([A-Z])/g, '$1 $2');
                name = name.split(' ')
                           .map(word => word && word.length > 0 ? word.charAt(0).toUpperCase() + word.slice(1).toLowerCase() : '')
                           .join(' ').trim();
                name = name.replace(/\s{2,}/g, ' ');
                 const cleanedName = name.replace(/[^a-zA-Z0-9\s]/g, '');
                return cleanedName && cleanedName.length > 2 ? name : `Video Clip (${publicId.slice(-6)})`;
            } catch (e) {
                err("Error formatting title from:", nameSource, e);
                const idParts = publicId.split('/');
                return idParts[idParts.length - 1] || "Untitled Video";
            }
        }


        // --- Video Card Actions ---
        function togglePlay(videoElement) {
            if (!videoElement) { err("togglePlay: videoElement is null"); return; }
            const container = videoElement.closest('.video-container');
            const publicId = videoElement.dataset.publicId;
            if (!publicId) { err("togglePlay: Cannot find publicId on video element."); return; }

            try {
                if (videoElement.paused) {
                    $$('.gallery video.playing').forEach(otherVideo => {
                         if (otherVideo !== videoElement) {
                             otherVideo.pause();
                             otherVideo.classList.remove('playing');
                             otherVideo.closest('.video-container')?.classList.remove('playing');
                         }
                     });
                    const playPromise = videoElement.play();
                    if (playPromise !== undefined) {
                        playPromise.then(() => {
                            log(`Playing video: ${publicId}`);
                            videoElement.classList.add('playing');
                            container?.classList.add('playing');
                        }).catch(e => {
                             if (e.name !== 'AbortError') {
                                err(`Play error for ${publicId}:`, e);
                             } else {
                                 log(`Play interrupted for ${publicId}`);
                                 videoElement.classList.remove('playing');
                                 container?.classList.remove('playing');
                             }
                        });
                    } else {
                        log(`Playing video (no promise): ${publicId}`);
                        videoElement.classList.add('playing');
                        container?.classList.add('playing');
                    }
                } else {
                    videoElement.pause();
                    log(`Paused video: ${publicId}`);
                    videoElement.classList.remove('playing');
                    container?.classList.remove('playing');
                }
            } catch (e) {
                err("Error in togglePlay:", e);
            }
        }

        function toggleActionMenu(publicId, buttonElement) {
             log(`Toggling action menu for ${publicId}`);
             const safeId = publicId.replace(/[^a-zA-Z0-9_-]/g, '_');
             const popup = safeGetElementById(`actionPopup_${safeId}`);
             const menuButton = buttonElement || $(`button[aria-controls="actionPopup_${safeId}"]`);

             if (!popup || !menuButton) { err(`Action popup or button not found for ${safeId}.`); return; }

             const isOpening = popup.style.display !== 'block';

             $$('.action-popup').forEach(p => {
                 if (p !== popup && p.style.display === 'block') {
                     p.style.display = 'none';
                     const otherButton = $(`button[aria-controls="${p.id}"]`);
                     if (otherButton) otherButton.setAttribute('aria-expanded', 'false');
                     log(`Closed other popup: ${p.id}`);
                 }
             });

             popup.style.display = isOpening ? 'block' : 'none';
             menuButton.setAttribute('aria-expanded', isOpening ? 'true' : 'false');

             if (isOpening) {
                 log(`Action popup ${popup.id} opened`);
                 popup.querySelector('button')?.focus();
            } else {
                 log(`Action popup ${popup.id} closed`);
                 menuButton.focus();
             }
        }

        // --- Password Protected Actions (Rename/Delete) ---
        function getPasswordAndExecute(publicId, actionCallback, actionName = "perform action") {
             log(`Getting password for ${actionName} on ${publicId}`);
             const storedPass = localStorage.getItem(`pass_${publicId}`);

             if (!storedPass) {
                 err(`No password found locally for ${publicId}`);
                 showPromptModal({
                     title: "<i class='fas fa-exclamation-triangle text-yellow-400 mr-2'></i> Password Missing",
                     isConfirmation: true,
                     contentHTML: `<p>The deletion/rename password for this video is not stored in this browser's local storage.</p><p>You might have uploaded it from a different browser, cleared your storage, or the password failed to save.</p><p class="mt-2 text-sm text-gray-400">The action cannot proceed without the correct password.</p>`,
                     confirmText: "OK",
                     confirmClass: 'modal-button-cancel',
                     callback: () => hidePromptModal()
                 });
                 return;
             }

             showPromptModal({
                 title: "<i class='fas fa-lock text-yellow-400 mr-2'></i> Password Required",
                 inputLabel: `Enter password to ${actionName}:`,
                 inputType: 'password',
                 placeholder: 'Enter your saved password',
                 confirmText: 'Verify & Proceed',
                 callback: (enteredPassword) => {
                     // This callback returns a Promise or value
                     return new Promise((resolve, reject) => {
                        log("Password prompt callback executed.");
                        if (!enteredPassword) {
                            showPromptError('Password cannot be empty.');
                            reject(new Error("Empty password")); // Reject to prevent closing
                            return;
                        }
                        if (enteredPassword === storedPass) {
                            log(`Password verified for ${actionName} on ${publicId}. Executing action.`);
                            // Don't hide modal here, let actionCallback decide or hide it afterwards
                            try {
                                // Execute the action. If it's async, it should return a promise.
                                // If actionCallback is synchronous, wrap it.
                                Promise.resolve(actionCallback())
                                    .then(() => {
                                        log("Action callback succeeded.");
                                        hidePromptModal(); // Hide modal on success *after* action is done
                                        resolve(); // Resolve the outer promise
                                    })
                                    .catch(actionError => {
                                        err("Error during action execution:", actionError);
                                        // Show error in the *same* password modal or a new one if needed
                                        showPromptError(`Action failed: ${actionError.message || actionError}`);
                                        reject(actionError); // Reject outer promise, keep modal open with error
                                    });
                            } catch (syncError) {
                                err("Synchronous error during action execution:", syncError);
                                showPromptError(`Action failed: ${syncError.message || syncError}`);
                                reject(syncError); // Reject outer promise
                            }
                        } else {
                            log("Incorrect password entered.");
                            showPromptError('Incorrect password. Please try again.');
                            const inputField = safeGetElementById('promptInput');
                            if(inputField) inputField.focus();
                            reject(new Error("Incorrect password")); // Reject to prevent closing
                        }
                     });
                 }
             });
        }

        function triggerRename(publicId) {
            log(`Triggering rename for ${publicId}`);
            getPasswordAndExecute(publicId, () => proceedWithRename(publicId), "rename video");
        }

        function proceedWithRename(publicId) {
             log(`Showing rename prompt for ${publicId}`);
             const card = $(`div.card[data-public-id="${publicId}"]`);
             const originalFilename = card?.dataset.originalFilename || localStorage.getItem(`filename_${publicId}`);
             const currentTitle = renamedTitles[publicId] || formatTitle(publicId, originalFilename);

             // Return a promise here so getPasswordAndExecute can handle success/failure
             return new Promise((resolve, reject) => {
                 showPromptModal({
                     title: "<i class='fas fa-pencil-alt mr-2'></i> Rename Video",
                     inputLabel: `Enter new title for this overlay:`,
                     inputType: 'text',
                     initialValue: currentTitle,
                     placeholder: 'Enter a descriptive title',
                     confirmText: 'Save New Title',
                     callback: (newTitleInput) => {
                         // This inner callback also needs to resolve/reject for its parent prompt
                         return new Promise((innerResolve, innerReject) => {
                            const newTitle = newTitleInput?.trim();
                            if (newTitle && newTitle !== currentTitle) {
                                log(`Renaming ${publicId} locally from "${currentTitle}" to "${newTitle}"`);
                                renamedTitles[publicId] = newTitle;
                                try {
                                    localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));
                                    log("Title saved locally.");

                                    if (card) {
                                        const titleEl = card.querySelector('.card-title');
                                        const downloadLink = card.querySelector('.download-btn');
                                        const videoEl = card.querySelector('video');
                                        if (titleEl) { titleEl.textContent = newTitle; titleEl.title = newTitle; }
                                        if (downloadLink) {
                                           const safeFilename = `${newTitle.replace(/[^a-z0-9_\-.]/gi, '_')}.mp4`;
                                           downloadLink.download = safeFilename;
                                           downloadLink.title = `Download ${newTitle}`;
                                        }
                                        if (videoEl) videoEl.title = `Click to play/pause: ${newTitle}`;
                                    }
                                    log("Rename successful (locally). UI Updated.");
                                    innerResolve(); // Resolve inner prompt callback
                                    resolve();      // Resolve outer proceedWithRename promise
                                } catch (e) {
                                    err("Error saving renamed title to localStorage:", e);
                                    showPromptError("Failed to save title locally.");
                                    innerReject(e); // Reject inner prompt callback
                                    reject(e);      // Reject outer proceedWithRename promise
                                }
                            } else if (!newTitle) {
                                showPromptError("Title cannot be empty.");
                                const inputField = safeGetElementById('promptInput');
                                if(inputField) inputField.focus();
                                innerReject(new Error("Empty title")); // Reject inner to keep modal open
                                // Don't reject outer, just keep inner modal open
                            } else {
                                log("Title unchanged, closing rename prompt.");
                                innerResolve(); // Resolve inner prompt callback
                                resolve();      // Resolve outer proceedWithRename promise (no change is success)
                                hidePromptModal(); // Close manually if title unchanged
                            }
                         });
                     }
                 });
             });
        }

        function triggerDelete(publicId) {
            log(`Triggering delete for ${publicId}`);
             getPasswordAndExecute(publicId, () => proceedWithDelete(publicId), "delete video");
        }

        // This function now returns a Promise that resolves on successful completion (local removal)
        // or rejects if the user cancels the final confirmation. Backend errors are handled internally.
        async function proceedWithDelete(publicId) {
             log(`Showing final delete confirmation for ${publicId}`);
             const card = $(`div.card[data-public-id="${publicId}"]`);
             const originalFilename = card?.dataset.originalFilename || localStorage.getItem(`filename_${publicId}`);
             const title = renamedTitles[publicId] || formatTitle(publicId, originalFilename);

             return new Promise((resolve, reject) => { // Wrap in promise
                 showPromptModal({
                     isConfirmation: true,
                     title: "<i class='fas fa-trash-alt text-red-500 mr-2'></i> Confirm Deletion",
                     contentHTML: `<p>Are you absolutely sure you want to permanently delete:</p><p class="font-bold my-2 break-words">"${title}"?</p><p class="text-red-400 font-semibold">This action requires server interaction (if backend is configured) and cannot be undone.</p>`,
                     confirmText: "Yes, Delete Forever",
                     cancelText: "Cancel",
                     confirmClass: 'modal-button-delete',
                     callback: async (confirmed) => { // Inner callback for the confirmation prompt
                         log(`Delete confirmation callback. Confirmed: ${confirmed}`);
                         if (confirmed) {
                            log(`Deletion confirmed by user for ${publicId}. Initiating...`);
                            // Don't hide the prompt modal yet. Show spinner instead.
                             const confirmBtnInner = safeGetElementById('promptConfirmBtn');
                             const cancelBtnInner = safeGetElementById('promptCancelBtn');
                             const spinnerElInner = safeGetElementById('promptSpinner');
                             if (spinnerElInner && confirmBtnInner && cancelBtnInner) {
                                 spinnerElInner.style.display = 'block';
                                 confirmBtnInner.disabled = true;
                                 cancelBtnInner.disabled = true;
                             }

                             const cardToDelete = $(`div.card[data-public-id="${publicId}"]`);
                             if (cardToDelete) cardToDelete.style.opacity = '0.5'; // Dim card

                             let serverDeletionSuccess = false;
                             let backendError = null;
                             try {
                                 // --- BACKEND INTERACTION ---
                                 if (!VIDEO_DELETE_ENDPOINT_BASE || VIDEO_DELETE_ENDPOINT_BASE === '/delete') {
                                     log("Backend delete endpoint not configured. Local removal only.");
                                 } else {
                                     const deleteUrl = `${VIDEO_DELETE_ENDPOINT_BASE}/${encodeURIComponent(publicId)}`;
                                     log(`Sending DELETE request to: ${deleteUrl}`);
                                     const response = await fetch(deleteUrl, { method: 'DELETE' });
                                     if (!response.ok) {
                                         if (response.status === 404) {
                                              log("Backend delete endpoint not found (404). Local removal only.");
                                         } else {
                                              let errorMsg = `Server Error: ${response.status} ${response.statusText}`;
                                              try { const errData = await response.json(); errorMsg = errData.message || `Failed with status ${response.status}`; } catch (e) {}
                                              throw new Error(errorMsg);
                                         }
                                     } else {
                                         log(`Server deleted ${publicId} (Status: ${response.status})`);
                                         serverDeletionSuccess = true;
                                     }
                                 }
                             } catch (error) {
                                 err(`Backend deletion failed for ${publicId}:`, error);
                                 backendError = error;
                             }

                             // --- LOCAL CLEANUP (Always happens after confirmation) ---
                             log(`Proceeding with local removal of ${publicId}. Server success: ${serverDeletionSuccess}`);
                             if (cardToDelete) {
                                  cardToDelete.classList.add('deleting');
                                  cardToDelete.addEventListener('transitionend', () => {
                                     cardToDelete.remove();
                                     log(`Card removed from DOM for ${publicId}`);
                                     const gallery = safeGetElementById('gallery');
                                     if (gallery && gallery.children.length === 0 && !gallery.querySelector('.gallery-message')) {
                                         log("Gallery empty after deletion, re-rendering.");
                                         applyFiltersAndRender(true);
                                     } else {
                                         updateLoadMoreButtonState();
                                     }
                                  }, { once: true });
                             } else { log("Card not found for DOM removal."); }

                             localStorage.removeItem(`pass_${publicId}`);
                             localStorage.removeItem(`filename_${publicId}`);
                             delete renamedTitles[publicId];
                             delete uploaderNames[publicId];
                             try {
                                  localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));
                                  localStorage.setItem('uploaderNames', JSON.stringify(uploaderNames));
                                  log(`Cleaned up local storage for ${publicId}.`);
                             } catch (e) { err("Error cleaning up localStorage after delete:", e); }

                             allVideos = allVideos.filter(v => v?.public_id !== publicId);
                             displayedVideos = displayedVideos.filter(v => v?.public_id !== publicId);
                             // updateLoadMoreButtonState(); // Called by transitionend now

                             // --- FINISH ---
                             hidePromptModal(); // Now hide the confirmation/spinner modal

                             if (backendError) {
                                  // Show a *new* modal for the error message
                                  setTimeout(() => { // Delay slightly
                                    showPromptModal({
                                        title: "<i class='fas fa-exclamation-circle text-red-500 mr-2'></i> Deletion Error",
                                        isConfirmation: true,
                                        contentHTML: `<p>Failed to delete from server:</p><p class="my-2 text-red-400">${backendError.message}</p><p>Video removed from local view.</p>`,
                                        confirmText: "OK",
                                        confirmClass: 'modal-button-cancel',
                                        callback: () => hidePromptModal() // Callback for the *error* modal
                                    });
                                 }, 100);
                             }
                             log(`Local removal complete for ${publicId}.`);
                             resolve(); // Resolve the outer proceedWithDelete promise

                         } else {
                             log("Deletion cancelled by user in final confirmation.");
                             hidePromptModal(); // Hide the confirmation modal
                             reject(new Error("Deletion cancelled")); // Reject the outer promise
                         }
                     } // End of inner callback
                 }); // End of showPromptModal for confirmation
             }); // End of outer promise
        }


        // Helper to update Load More button visibility and state
        function updateLoadMoreButtonState() {
             const loadMoreBtn = safeGetElementById('loadMoreBtn');
             const gallery = safeGetElementById('gallery');
             if (!loadMoreBtn || !gallery) return;

             const existingEndMsg = gallery.querySelector('.gallery-message.end-of-list');
             if (existingEndMsg) existingEndMsg.remove();

             if (currentVideoIndex >= displayedVideos.length) {
                 loadMoreBtn.style.display = 'none';
                 if (displayedVideos.length > 0 && gallery.children.length > 0 && !gallery.querySelector('.gallery-message:not(.end-of-list)')) {
                      const endMsg = document.createElement('p');
                      endMsg.className = 'gallery-message info end-of-list';
                      endMsg.innerHTML = "âœ¨ You've reached the end! âœ¨";
                      setTimeout(() => {
                           const currentGallery = safeGetElementById('gallery');
                           if(currentGallery && !currentGallery.querySelector('.gallery-message.end-of-list')) {
                                currentGallery.appendChild(endMsg);
                           }
                      }, 150);
                 }
             } else {
                  loadMoreBtn.style.display = 'block';
                  loadMoreBtn.disabled = false;
                  loadMoreBtn.innerHTML = 'Load More Videos';
             }
        }

    </script>

</body>
</html>
