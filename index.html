--- START OF FILE index.html ---

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Green Screen Overlay Vault</title>
  <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Base Styles (Keep previous styles) */
    body { font-family: 'Segoe UI', sans-serif; transition: background 0.3s, color 0.3s; }
    html[data-theme="dark"] body { background: #0e0e0e; color: white; }
    html[data-theme="light"] body { background: #f4f4f4; color: black; }
    .header { background: #00ff88; color: black; padding: 2rem; text-align: center; font-size: 2.5rem; font-weight: bold; position: relative; }
    .header h1 { animation: fadeInDown 1s ease-in-out; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; padding: 2rem; }
    .card { background: #1a1a1a; border-radius: 1rem; overflow: hidden; box-shadow: 0 0 10px #00ff88; transition: transform 0.3s, box-shadow 0.3s; animation: fadeInUp 0.5s ease-in-out; position: relative; }
    html[data-theme="light"] .card { background: #ffffff; color: black; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    html[data-theme="light"] .card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .card:hover { transform: scale(1.05); box-shadow: 0 0 15px #00ff88; }
    .video-container { cursor: pointer; }
    .video-container video { width: 100%; height: auto; max-height: 200px; object-fit: cover; border-radius: 1rem 1rem 0 0; background-color: #050505; display: block; }
    .download-btn { background: #00ff88; color: black; padding: 0.5rem; text-align: center; font-weight: bold; margin: 0.5rem; display: block; border-radius: 0.5rem; }
    html[data-theme="light"] .download-btn { background: #10b981; color: white; }
    .progress-container { width: 100%; background: #333; border-radius: 10px; overflow: hidden; height: 10px; margin-top: 1rem; }
    .progress-bar { height: 10px; background: linear-gradient(270deg, #00ff88, #00ccff); animation: glow 1s infinite alternate; width: 0%; }
    .uploader-name { font-size: 0.75rem; opacity: 0.6; padding: 0 0.5rem 0.2rem; text-align: right; } /* Style for uploader name */

    /* --- Card Menu & Action Popup Styles --- */
    .card-footer { padding: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
    .menu-btn { background: rgba(0, 255, 136, 0.5); border: none; border-radius: 50%; padding: 0.3rem 0.5rem; font-weight: bold; cursor: pointer; line-height: 1; color: black; }
    html[data-theme="light"] .menu-btn { background: rgba(16, 185, 129, 0.6); color: white;}
    .menu-btn:hover { background: rgba(0, 255, 136, 0.8); }
    html[data-theme="light"] .menu-btn:hover { background: rgba(16, 185, 129, 0.9); }

    .action-popup { /* ... (keep existing styles) ... */ }
    /* ... (keep other existing styles for action popup) ... */

    /* --- Generic Modal Styles --- */
    .modal-backdrop {
        position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7);
        display: none; align-items: center; justify-content: center;
        z-index: 50; animation: fadeIn 0.3s ease-out;
    }
    .modal-box {
        background-color: #1f1f1f; color: white; padding: 1.5rem 2rem; border-radius: 1rem;
        border: 1px solid #00ff88; box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        width: 90%; max-width: 500px; /* Increased max-width slightly */
        animation: scaleUp 0.3s ease-out; position: relative;
        max-height: 85vh; /* Limit height and allow scroll */
        overflow-y: auto; /* Enable scroll if content overflows */
    }
    html[data-theme="light"] .modal-box { background-color: #ffffff; color: black; border-color: #10b981; box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4); }
    .modal-box h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #00ff88;}
    html[data-theme="light"] .modal-box h2 { color: #10b981; }
    .modal-box label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .modal-box input[type="text"], .modal-box input[type="password"] { /* ... (keep styles) ... */ }
    html[data-theme="light"] .modal-box input[type="text"], html[data-theme="light"] .modal-box input[type="password"] { /* ... (keep styles) ... */ }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1.5rem; /* Increased top margin */ }
    .modal-buttons button { /* ... (keep styles) ... */ }
    .modal-button-confirm { /* ... (keep styles) ... */ }
    .modal-button-confirm:hover { /* ... (keep styles) ... */ }
    html[data-theme="light"] .modal-button-confirm { /* ... (keep styles) ... */ }
    html[data-theme="light"] .modal-button-confirm:hover { /* ... (keep styles) ... */ }
    .modal-button-cancel { /* ... (keep styles) ... */ }
    .modal-button-cancel:hover { /* ... (keep styles) ... */ }
    html[data-theme="light"] .modal-button-cancel { /* ... (keep styles) ... */ }
    html[data-theme="light"] .modal-button-cancel:hover { /* ... (keep styles) ... */ }
    .modal-button-delete { background-color: #ff4444; color: white; } /* Style for delete confirmation */
    .modal-button-delete:hover { background-color: #dd2222; }
    html[data-theme="light"] .modal-button-delete { background-color: #dc2626; color: white; }
    html[data-theme="light"] .modal-button-delete:hover { background-color: #b91c1c; }
    .modal-error { color: #ff4444; font-size: 0.9rem; margin-top: 0.5rem; min-height: 1.2em; /* Reserve space */ }
    .modal-close-btn { /* ... (keep styles) ... */ }
    html[data-theme="light"] .modal-close-btn { /* ... (keep styles) ... */ }

    /* --- Upload Success Modal Styles --- */
    /* ... (keep existing styles) ... */

    /* --- Terms Modal Specific Styles --- */
    #termsModal .modal-box { max-width: 650px; } /* Wider for terms */
    .terms-content { font-size: 0.9rem; line-height: 1.6; max-height: 50vh; overflow-y: auto; border: 1px solid #444; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; }
    html[data-theme="light"] .terms-content { border-color: #ccc; }
    .terms-content h3 { font-weight: bold; margin-top: 1rem; margin-bottom: 0.5rem; color: #00ccff; }
    html[data-theme="light"] .terms-content h3 { color: #0ea5e9; }
    .terms-accept-label { display: flex; align-items: center; margin-top: 1rem; cursor: pointer; }
    .terms-accept-label input { margin-right: 0.5rem; }

    /* --- Footer --- */
    .site-footer { text-align: center; padding: 1.5rem; margin-top: 2rem; font-size: 0.9rem; border-top: 1px solid #333; }
    html[data-theme="light"] .site-footer { border-top-color: #ddd; }
    .footer-link { color: #00ccff; text-decoration: underline; cursor: pointer; }
    html[data-theme="light"] .footer-link { color: #0ea5e9; }

    /* --- Intro Screen --- */
    #introScreen {
      position: fixed; inset: 0; background-color: #000;
      display: flex; align-items: center; justify-content: center;
      z-index: 100; color: white; font-size: 3rem; font-weight: bold;
      opacity: 1; transition: opacity 0.8s ease-out;
    }
    #introScreen.fade-out { opacity: 0; pointer-events: none; }
    #introText { animation: textPopIn 1s ease-out forwards; opacity: 0; }

    /* --- Load More Button --- */
    #loadMoreBtn { display: block; margin: 2rem auto; padding: 0.8rem 2rem; font-weight: bold; cursor: pointer; border-radius: 0.5rem; transition: background-color 0.2s, transform 0.2s; }
    #loadMoreBtn { background: #00ccff; color: black; border: none; }
    html[data-theme="light"] #loadMoreBtn { background: #38bdf8; color: white; }
    #loadMoreBtn:hover { transform: translateY(-2px); }
    html[data-theme="dark"] #loadMoreBtn:hover { background-color: #00ddff; }
    html[data-theme="light"] #loadMoreBtn:hover { background-color: #0ea5e9; }
    #loadMoreBtn:disabled { background: #555; cursor: not-allowed; transform: none; }
    html[data-theme="light"] #loadMoreBtn:disabled { background: #a1a1aa; }


    /* Other Styles & Animations (Keep existing styles and animations) */
    /* ... (filter-btn, screenshot, landing-page, video-wrapper, etc.) ... */
    @keyframes glow { /* ... keep ... */ }
    @keyframes fadeInUp { /* ... keep ... */ }
    @keyframes fadeInDown { /* ... keep ... */ }
    @keyframes fadeIn { /* ... keep ... */ }
    @keyframes scaleUp { /* ... keep ... */ }
    @keyframes popUpFadeIn { /* ... keep ... */ }
    @keyframes textPopIn { /* Added for intro */
        0% { opacity: 0; transform: scale(0.8) translateY(20px); }
        100% { opacity: 1; transform: scale(1) translateY(0); }
    }

  </style>
</head>
<body>

  <!-- Intro Screen -->
  <div id="introScreen">
    <span id="introText">Green Screen Gallery</span>
  </div>

  <div class="header">
    <h1>🎬 Green Screen Overlay Vault</h1>
    <button onclick="showUploadPopup()" class="absolute right-4 top-4 bg-black border border-white text-white px-4 py-1 rounded hover:bg-green-500 transition-colors">Upload</button>
    <button onclick="toggleTheme()" class="absolute left-4 top-4 bg-white text-black px-4 py-1 rounded hover:bg-gray-300 transition-colors">🌗</button>
  </div>

  <div class="text-center px-4 mt-4">
    <div class="filter-options">
      <button class="filter-btn" id="filter-recent" onclick="setActiveFilter(this, 'recent')">Most Recent</button>
      <button class="filter-btn" id="filter-popular" onclick="setActiveFilter(this, 'popular')">Most Popular</button>
      <button class="filter-btn" id="filter-relevant" onclick="setActiveFilter(this, 'relevant')">Relevant</button>
    </div>
    <label for="search" class="mr-2">Search Videos:</label>
    <input type="text" id="search" oninput="searchVideos()" class="bg-gray-800 text-white p-2 rounded border border-gray-600" placeholder="Search by title...">
  </div>

  <div class="gallery" id="gallery">Loading videos...</div>

  <!-- Load More Button -->
  <button id="loadMoreBtn" onclick="loadMoreVideos()">Load More Videos</button>

  <!-- How to Use & Info Section -->
  <div class="text-center landing-page px-4 py-8">
      <h2 class="text-2xl font-bold mb-4">Unlock Your Creativity</h2>
       <p class="max-w-3xl mx-auto mb-6">
           Welcome to the Green Screen Overlay Vault! This is a community-driven collection of free green screen assets. Find the perfect effect, transition, or element for your next video project. Using these overlays is simple and can dramatically elevate your production value. Check out the tutorial below!
       </p>

      <!-- Responsive YouTube Embed -->
      <div class="video-wrapper">
        <iframe
            src="https://www.youtube.com/embed/-UFG_jU3bXA"
            title="YouTube video player - Green Screen Tutorial (Adobe Premiere Pro Ultra Key)"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen>
        </iframe>
      </div>

      <h3 class="text-xl font-semibold mt-8 mb-3">Quick Guide: Using Overlays (Premiere Pro Example)</h3>
      <ol class="text-left mt-4 max-w-xl mx-auto list-decimal pl-5 space-y-2">
          <li><strong>Import:</strong> Add your main footage and the downloaded overlay to your project.</li>
          <li><strong>Layer:</strong> Place the overlay clip on the timeline track *above* your main footage.</li>
          <li><strong>Effect:</strong> Find 'Ultra Key' in the Effects panel and apply it to the overlay clip.</li>
          <li><strong>Key Color:</strong> Use the eyedropper in Effect Controls > Ultra Key to select the green color on the overlay.</li>
          <li><strong>Refine:</strong> Adjust Matte Generation/Cleanup/Spill Suppression settings for a clean key.</li>
          <li><strong>Composite:</strong> Position, scale, or animate the overlay as needed!</li>
      </ol>

       <h3 class="text-xl font-semibold mt-8 mb-3">Why Use Green Screen Overlays?</h3>
       <p class="max-w-3xl mx-auto mb-6">
           Overlays save time and add professional polish. Instead of creating complex effects from scratch, you can easily integrate pre-made animations, impacts, lower thirds, and more. They are versatile tools for filmmakers, YouTubers, streamers, and social media creators. Contribute your own creations to help the community grow!
       </p>
  </div>

  <!-- Initial Upload Popup (Modified) -->
  <div class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50" id="uploadPopup">
    <div class="upload-box bg-gray-900 text-white p-6 rounded-lg border border-green-500 w-full max-w-md mx-4">
      <h2 class="text-xl font-bold mb-4">Upload Green Screen Overlay</h2>
      <!-- REMOVED Video Title input -->
      <input type="text" id="uploaderNameInput" placeholder="Your Name/Alias (Optional, shown publicly)" class="bg-gray-800 text-white p-2 rounded mb-4 w-full border border-gray-600">
      <input type="password" id="deletePassword" placeholder="Set Deletion Password (REQUIRED)" class="bg-gray-800 text-white p-2 rounded mb-4 w-full border border-gray-600">
      <button onclick="openCloudinaryUpload()" class="bg-green-400 hover:bg-green-500 px-4 py-2 rounded text-black font-bold w-full transition-colors">Select & Upload Video</button>
      <div class="progress-container mt-4"><div class="progress-bar" id="progressBar"></div></div>
      <p id="uploadStatus" class="mt-4 text-sm h-5"></p>
      <button onclick="hideUploadPopup()" class="text-red-400 hover:text-red-500 underline mt-4 block w-full text-center">Cancel</button>
    </div>
  </div>

  <!-- Post-Upload Details Modal -->
  <div class="modal-backdrop" id="postUploadDetailsModal">
    <div class="modal-box">
      <button class="modal-close-btn" onclick="closePostUploadModal(true)">×</button> <!-- true = skip -->
      <h2>Finalize Upload Details</h2>
      <p class="text-sm mb-4">Your video is uploaded! Add a title below.</p>
      <div>
        <label for="postUploadTitleInput">Video Title:</label>
        <input type="text" id="postUploadTitleInput" name="postUploadTitleInput" class="bg-gray-800 text-white p-2 rounded w-full border border-gray-600">
        <p class="text-xs mt-1 text-gray-400">Uploader: <span id="postUploadUploaderName"></span></p>
        <p class="modal-error" id="postUploadError"></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-button-cancel" onclick="closePostUploadModal(true)">Skip Title</button> <!-- true = skip -->
        <button class="modal-button-confirm" onclick="savePostUploadDetails()">Save Details</button>
      </div>
    </div>
  </div>


  <!-- Generic Prompt/Confirmation Modal -->
  <div class="modal-backdrop" id="promptModal">
    <div class="modal-box">
      <button class="modal-close-btn" onclick="hidePromptModal()">×</button>
      <h2 id="promptTitle">Prompt</h2>
      <div id="promptContent">
        <!-- Content here will be dynamically set (label/input or just text) -->
        <p class="modal-error" id="promptError"></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-button-cancel" id="promptCancelBtn" onclick="hidePromptModal()">Cancel</button>
        <button class="modal-button-confirm" id="promptConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Upload Success Modal (Optional, can be shown after details are saved) -->
  <div class="modal-backdrop" id="uploadSuccessPopup">
      <div class="modal-box">
          <button class="modal-close-btn" onclick="closeSuccessPopupAndRefresh()">×</button>
          <h2>🚀 Upload Complete!</h2>
          <div id="uploadSuccessContent">
              <p>Thank you for your contribution! Your green screen overlay has been successfully added to the vault.</p>
              <p>Sharing helps the creative community grow. Keep up the great work!</p>
              <p><strong>Video Title:</strong> <span id="successVideoTitle" class="font-semibold"></span></p>
               <p class="text-xs mt-1">Uploader: <span id="successUploaderName"></span></p>
          </div>
          <div class="modal-buttons">
              <button class="modal-button-confirm" onclick="closeSuccessPopupAndRefresh()">Awesome!</button>
          </div>
      </div>
  </div>

  <!-- Terms and Conditions Modal -->
    <div class="modal-backdrop" id="termsModal">
        <div class="modal-box">
            <h2>Terms & Privacy</h2>
            <div class="terms-content">
                <h3>Terms and Conditions</h3>
                <p><em>Last updated: April 26, 2024</em></p> <!-- Corrected Year -->
                <p>Welcome to Green Screen Overlay Vault! By accessing or using our website, you agree to be bound by these Terms and Conditions ("Terms"). Please read them carefully.</p>

                <strong>1. Acceptance of Terms</strong>
                <p>By using this site, you signify your acceptance of these Terms and our Privacy Policy. If you do not agree, please do not use our site. Your continued use following the posting of changes will mean you accept those changes.</p>

                <strong>2. Uploading Content</strong>
                <p>You represent and warrant that you own or have the necessary rights and permissions to upload and share any video content ("Content") you submit to the site.</p>
                <p>By uploading Content, you grant Green Screen Overlay Vault a worldwide, non-exclusive, royalty-free license to use, reproduce, distribute, display, and perform the Content in connection with the service provided by the website.</p>
                <p>You are solely responsible for the Content you upload and the consequences of posting or publishing it. You must set a deletion password during the upload process if you wish to manage (rename/delete) your Content later.</p>

                <strong>3. Video Deletion and Renaming</strong>
                <p>A unique deletion password must be provided by you during the upload process for each video. This password is required to rename or delete your uploaded video.</p>
                <p>This password is stored locally in *your browser's storage* and is *not* stored on our servers. If you clear your browser data or use a different browser/device, you will lose access to this password. We cannot recover or reset lost deletion passwords. Responsibility for safeguarding the password rests entirely with you.</p>

                <strong>4. Prohibited Content</strong>
                <p>You agree not to upload Content that:</p>
                <ul>
                    <li>- Infringes any third party's copyright, patent, trademark, trade secret, or other proprietary rights or rights of publicity or privacy.</li>
                    <li>- Is illegal, defamatory, obscene, pornographic, harassing, threatening, or otherwise harmful or inappropriate.</li>
                    <li>- Contains viruses, malware, or other harmful code.</li>
                </ul>
                <p>We reserve the right, but are not obligated, to review and remove any Content that we deem, in our sole discretion, to violate these Terms or to be otherwise objectionable, without prior notice.</p>

                <strong>5. Disclaimer of Warranties</strong>
                <p>The site and its content are provided "as is" and "as available" without warranty of any kind. We disclaim all warranties, express or implied, including but not limited to implied warranties of merchantability, fitness for a particular purpose, and non-infringement.</p>
                <p>We are not responsible for any loss of data, including deletion passwords stored in your local browser storage, or for unauthorized access to or use of your uploaded content.</p>

                <strong>6. Limitation of Liability</strong>
                <p>In no event shall Green Screen Overlay Vault, its owners, or affiliates be liable for any indirect, incidental, special, consequential, or punitive damages arising out of or related to your use of the site or content.</p>

                <strong>7. Changes to Terms</strong>
                <p>We reserve the right to modify these Terms at any time. We will post the revised Terms on this page with an updated "Last updated" date. Your continued use of the site after such changes constitutes your acceptance of the new Terms.</p>

                <strong>8. Contact</strong>
                <p>For questions about these Terms, please contact us at ganeshvb003@gmail.com.</p>

                <hr class="my-4 border-gray-600">
                <h3>Privacy Policy</h3>
                <p><em>Effective Date: April 26, 2024</em></p> <!-- Corrected Year -->
                <p>We value your privacy. This Privacy Policy explains how we handle information on Green Screen Overlay Vault.</p>

                <strong>1. Information We Collect</strong>
                <ul>
                    <li><strong>Content You Provide:</strong> Videos you upload, optional titles you set after upload, and optional uploader names you provide.</li>
                    <li><strong>Deletion Passwords:</strong> Passwords you set during upload are stored *only* in your web browser's local storage. We do not collect or store these passwords on our servers.</li>
                    <li><strong>Renamed Titles & Uploader Names:</strong> If you provide a title or uploader name, this association with the video ID is also stored in your browser's local storage.</li>
                    <li><strong>Usage Data (Anonymous):</strong> We may collect anonymous, aggregated data about site usage (e.g., page views, video downloads) using server logs or privacy-respecting analytics tools to understand site traffic and improve the service. This data is not personally identifiable.</li>
                </ul>

                <strong>2. How We Use Information</strong>
                <ul>
                    <li>- To display uploaded videos publicly in the gallery.</li>
                    <li>- To allow *you* to manage your uploads (rename/delete) using the locally stored password.</li>
                    <li>- To display the uploader name you provided alongside the video.</li>
                    <li>- To analyze site usage trends anonymously to improve the platform.</li>
                    <li>- We do *not* sell, trade, rent, or share personally identifiable information with third parties for marketing purposes.</li>
                </ul>

                <strong>3. Cookies and Local Storage</strong>
                <p>We use your browser's `localStorage` to store your deletion passwords, renamed video titles, uploader names, and your acceptance of these Terms. This allows these settings to persist between visits *on the same browser*. Clearing your browser's cache or storage will remove this data.</p>
                <p>We do not typically use traditional cookies for tracking users across sites.</p>

                <strong>4. Data Security</strong>
                <p>Uploaded videos are stored via Cloudinary. While Cloudinary employs security measures, no online storage is 100% secure. The security of your deletion password relies entirely on you keeping it safe and not clearing your browser storage inadvertently.</p>

                <strong>5. Third-Party Services</strong>
                <p>Video hosting and delivery are managed by Cloudinary. Their terms of service and privacy policy govern their handling of the video files. We may embed content from services like YouTube, whose privacy policies also apply.</p>

                <strong>6. Your Rights & Choices</strong>
                <ul>
                    <li>- You can choose not to provide an uploader name.</li>
                    <li>- You can delete your uploaded videos if you have the correct password stored locally.</li>
                    <li>- You can clear your browser's local storage at any time to remove saved passwords, titles, names, and term acceptance status.</li>
                </ul>

                <strong>7. Changes to this Privacy Policy</strong>
                <p>We may update this policy. Changes will be posted on this page with an updated effective date.</p>

                <strong>8. Contact Us</strong>
                <p>If you have any questions or concerns about this Privacy Policy, please contact us at ganeshvb003@gmail.com.</p>
            </div>

            <!-- Acceptance Checkbox (only shown on first visit) -->
            <label class="terms-accept-label" id="termsAcceptWrapper">
                <input type="checkbox" id="termsAcceptCheckbox">
                <span>I have read and agree to the Terms and Conditions and Privacy Policy.</span>
            </label>
            <p class="modal-error" id="termsError"></p>

            <div class="modal-buttons">
                <button class="modal-button-confirm" id="termsAcceptBtn" onclick="acceptTerms()">Agree & Continue</button>
                <button class="modal-button-cancel" id="termsCloseBtn" onclick="closeTermsModal()" style="display: none;">Close</button> <!-- Shown when viewing later -->
            </div>
        </div>
    </div>

   <!-- Footer -->
   <footer class="site-footer">
       <p>© <span id="currentYear"></span> Green Screen Overlay Vault. All rights reserved.</p>
       <p>Share your creations, discover new ones!</p>
       <p><span class="footer-link" onclick="showTermsModal(true)">View Terms & Privacy Policy</span></p> <!-- true indicates viewing, not accepting -->
   </footer>


  <script>
    const cloudName = 'dogxcu1sj';
    const uploadPreset = 'gs_overlay';
    let allVideos = []; // Holds all fetched videos
    let displayedVideos = []; // Holds currently rendered videos
    const videosPerLoad = 12; // How many videos to load at once
    let currentVideoIndex = 0; // Index for lazy loading
    let renamedTitles = JSON.parse(localStorage.getItem('renamedTitles') || '{}');
    let uploaderNames = JSON.parse(localStorage.getItem('uploaderNames') || '{}'); // Store uploader names
    let currentFilter = 'recent';
    let currentSearchQuery = ''; // Store current search query

    // --- Temp storage for post-upload details ---
    let postUploadData = null;

    // --- Intro Screen Logic ---
    function handleIntro() {
        const introScreen = document.getElementById('introScreen');
        const introText = document.getElementById('introText');
        if (!introScreen || !introText) return;

        // Short delay before starting fade out, allows text animation to complete
        setTimeout(() => {
            introScreen.classList.add('fade-out');
             // Remove from DOM after transition for performance
            introScreen.addEventListener('transitionend', () => {
                introScreen.remove();
                 checkTerms(); // Check terms AFTER intro fades out
            }, { once: true }); // Ensure event listener only runs once
        }, 1500); // Adjust timing (e.g., 1500ms = 1.5s)
    }

    // --- Terms and Conditions Logic ---
    function checkTerms() {
      const accepted = localStorage.getItem('termsAccepted');
      if (accepted !== 'true') {
        showTermsModal(false); // Show for acceptance
      } else {
        // Terms already accepted, proceed to load content
        initializePage();
      }
    }

    function showTermsModal(isViewingOnly = false) {
      const modal = document.getElementById('termsModal');
      const acceptWrapper = document.getElementById('termsAcceptWrapper');
      const acceptBtn = document.getElementById('termsAcceptBtn');
      const closeBtn = document.getElementById('termsCloseBtn');
      const errorMsg = document.getElementById('termsError');

      errorMsg.textContent = ''; // Clear error

      if (isViewingOnly) {
        acceptWrapper.style.display = 'none';
        acceptBtn.style.display = 'none';
        closeBtn.style.display = 'inline-block'; // Show close button
      } else {
        acceptWrapper.style.display = 'flex';
        acceptBtn.style.display = 'inline-block'; // Show accept button
        closeBtn.style.display = 'none';
        document.getElementById('termsAcceptCheckbox').checked = false; // Ensure checkbox is unchecked
      }
      modal.style.display = 'flex';
    }

    function acceptTerms() {
        const checkbox = document.getElementById('termsAcceptCheckbox');
        const errorMsg = document.getElementById('termsError');
        if (checkbox.checked) {
            localStorage.setItem('termsAccepted', 'true');
            closeTermsModal();
            initializePage(); // Load content after accepting
        } else {
            errorMsg.textContent = 'You must accept the terms to continue.';
        }
    }

    function closeTermsModal() {
        document.getElementById('termsModal').style.display = 'none';
        document.getElementById('termsError').textContent = ''; // Clear error on close
    }

    // --- Page Initialization ---
    function initializePage() {
        // Set default filter button state and load initial videos
        const initialFilterButton = document.getElementById('filter-recent');
        if (initialFilterButton) {
             setActiveFilter(initialFilterButton, 'recent', true); // Pass true to prevent double loading
        }
        loadVideos(true); // Initial load, reset everything
        updateFooterYear();
    }

     function updateFooterYear() {
        const yearSpan = document.getElementById('currentYear');
        if (yearSpan) {
            yearSpan.textContent = new Date().getFullYear();
        }
    }


    // --- Modal Helper Functions ---
    let currentPromptCallback = null;
    let currentCancelCallback = null; // Add cancel callback

    function showPromptModal({ title, label, inputType = 'text', placeholder = '', confirmText = 'Confirm', cancelText = 'Cancel', callback, initialValue = '', isConfirmation = false, confirmationContent = '', confirmClass = '' }) {
        document.getElementById('promptTitle').innerText = title;
        const contentDiv = document.getElementById('promptContent');
        const input = document.getElementById('promptInput'); // Assume input exists, might hide it
        const labelElement = document.getElementById('promptLabel'); // Assume label exists
        const confirmBtn = document.getElementById('promptConfirmBtn');
        const cancelBtn = document.getElementById('promptCancelBtn');

        // Clear previous state
        contentDiv.innerHTML = ''; // Clear previous dynamic content
        document.getElementById('promptError').innerText = '';
        confirmBtn.className = 'modal-button-confirm'; // Reset class
        if (confirmClass) {
             confirmBtn.classList.add(confirmClass); // Add specific class if provided (e.g., for delete)
        }

        if (isConfirmation) {
            // Display confirmation text instead of input field
            const confirmTextElement = document.createElement('p');
            confirmTextElement.innerHTML = confirmationContent; // Use innerHTML to allow basic formatting if needed
            contentDiv.appendChild(confirmTextElement);
        } else {
             // Setup label and input
            const newLabel = document.createElement('label');
            newLabel.htmlFor = 'promptInput';
            newLabel.id = 'promptLabel';
            newLabel.innerText = label;

            const newInput = document.createElement('input');
            newInput.type = inputType;
            newInput.id = 'promptInput';
            newInput.name = 'promptInput';
            newInput.placeholder = placeholder;
            newInput.value = initialValue; // Set initial value
             newInput.className = 'bg-gray-800 text-white p-2 rounded w-full border border-gray-600'; // Re-apply basic input styles
             // Apply light theme styles if needed
             if (document.documentElement.getAttribute('data-theme') === 'light') {
                 newInput.classList.remove('bg-gray-800', 'text-white', 'border-gray-600');
                 newInput.classList.add('bg-e5e7eb', 'text-black', 'border-ccc'); // Match light theme input style
             }

            contentDiv.appendChild(newLabel);
            contentDiv.appendChild(newInput);
        }

        // Add error placeholder back
        const errorP = document.createElement('p');
        errorP.className = 'modal-error';
        errorP.id = 'promptError';
        contentDiv.appendChild(errorP);


        confirmBtn.innerText = confirmText;
        cancelBtn.innerText = cancelText;

        currentPromptCallback = callback; // Set the confirm callback

        // Assign the event listener directly HERE
        confirmBtn.onclick = () => {
            if (currentPromptCallback) {
                const value = isConfirmation ? true : document.getElementById('promptInput')?.value;
                currentPromptCallback(value); // Pass input value or true for confirmation
            }
        };
        // Assign cancel callback if provided
        cancelBtn.onclick = () => {
            hidePromptModal();
            if (currentCancelCallback) {
                currentCancelCallback();
            }
        };

        document.getElementById('promptModal').style.display = 'flex';
        if (!isConfirmation) {
            document.getElementById('promptInput')?.focus(); // Focus input if it exists
        }
    }


    function hidePromptModal() {
        document.getElementById('promptModal').style.display = 'none';
        currentPromptCallback = null;
        currentCancelCallback = null; // Clear cancel callback
    }

    function showPromptError(message) {
        const errorElement = document.getElementById('promptError');
        if(errorElement) errorElement.innerText = message;
    }

    // --- Upload Success Popup (Now triggered after details modal) ---
    function showUploadSuccessPopup(publicId, title, uploader) {
         const finalTitle = title || formatTitle(publicId);
         const finalUploader = uploader || 'Anonymous';
         document.getElementById('successVideoTitle').innerText = finalTitle;
         document.getElementById('successUploaderName').innerText = finalUploader;
         document.getElementById('uploadSuccessPopup').style.display = 'flex';
    }

     function closeSuccessPopupAndRefresh() {
        document.getElementById('uploadSuccessPopup').style.display = 'none';
        // No longer need to reload here, reload happens after post-upload modal save/skip
    }

    // --- Theme Toggle ---
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      html.setAttribute("data-theme", newTheme);
      // Re-apply active filter style based on theme
      const activeButton = document.querySelector('.filter-btn.active-filter');
      if (activeButton) {
            // Temporarily remove and re-add class to force style refresh if needed
            const filterType = activeButton.id.split('-')[1]; // e.g., 'recent'
            activeButton.classList.remove('active-filter');
            // Timeout ensures styles are flushed before re-adding
            setTimeout(() => setActiveFilter(activeButton, filterType, true), 0);
      }
       // Update dynamically added input styles in modals if they are open
        document.querySelectorAll('.modal-box input[type="text"], .modal-box input[type="password"]').forEach(input => {
             if (newTheme === 'light') {
                input.classList.remove('bg-gray-800', 'text-white', 'border-gray-600');
                input.classList.add('bg-e5e7eb', 'text-black', 'border-ccc');
             } else {
                 input.classList.remove('bg-e5e7eb', 'text-black', 'border-ccc');
                 input.classList.add('bg-gray-800', 'text-white', 'border-gray-600');
             }
        });
    }

    // --- Upload Logic (Modified) ---
    function showUploadPopup() {
        // Clear fields
        document.getElementById("uploaderNameInput").value = '';
        document.getElementById("deletePassword").value = '';
        document.getElementById("progressBar").style.width = '0%';
        document.getElementById("uploadStatus").innerText = '';
        document.getElementById("uploadPopup").style.display = "flex";
    }

    function hideUploadPopup() {
        document.getElementById("uploadPopup").style.display = "none";
    }

    function openCloudinaryUpload() {
        // REMOVED rename input reading
        const uploaderName = document.getElementById("uploaderNameInput").value.trim() || 'Anonymous'; // Default to Anonymous
        const delPass = document.getElementById("deletePassword").value.trim();
        const progressBar = document.getElementById("progressBar");
        const status = document.getElementById("uploadStatus");

        if (!delPass) {
            status.innerText = "❌ Deletion password is required.";
            // alert("Please set a deletion password. This is required to rename or delete the video later.");
            return;
        }

        status.innerText = 'Initializing upload...';
        progressBar.style.width = '0%';

        let successfulUploadsBatch = 0; // Counter for multiple uploads in one session
        let firstUploadedPublicId = null; // Store the ID of the first successful upload in a batch
        let batchUploaderName = uploaderName; // Capture uploader name for the batch

        // --- Widget Event Listener ---
        const processQueue = (error, result) => {
            if (error) {
                console.error("Upload Widget Error:", error);
                status.innerText = `❌ Upload failed: ${error.message || 'Unknown error'}`;
                progressBar.style.width = '0%';
            } else if (result && result.event === "success") {
                console.log("Upload Success (File):", result.info);
                const publicId = result.info.public_id;

                // Store password immediately
                localStorage.setItem(`pass_${publicId}`, delPass);
                // Store uploader name (use the name provided at the start of the batch)
                 uploaderNames[publicId] = batchUploaderName; // Store in memory first
                 localStorage.setItem('uploaderNames', JSON.stringify(uploaderNames)); // Update local storage

                // Store data for the post-upload modal
                postUploadData = {
                    publicId: publicId,
                    uploaderName: batchUploaderName,
                    originalFilename: result.info.original_filename
                };

                successfulUploadsBatch++;
                if (!firstUploadedPublicId) {
                    firstUploadedPublicId = publicId; // Capture the first ID for single file case
                }
                // status.innerText = `✅ File ${successfulUploadsBatch} uploaded: ${result.info.original_filename}`;
                progressBar.style.width = '100%'; // Show completion for this file


            } else if (result && result.event === "uploadprogress") {
                const percent = Math.round(result.info.bytes_uploaded / result.info.total_bytes * 100);
                progressBar.style.width = `${percent}%`;
                status.innerText = `Uploading... ${percent}%`;
            } else if (result && result.event === "close" || result.event === "queue-finished") {
                 // This might fire after 'success' or if the user closes the widget
                 if (successfulUploadsBatch > 0 && postUploadData) {
                     // Only show post-upload modal if at least one upload succeeded
                     hideUploadPopup(); // Close the initial upload popup
                     showPostUploadDetailsModal(postUploadData); // Show the new modal to set title
                 } else if (!error) {
                     // User closed without uploading or an error occurred before 'success'
                     status.innerText = 'Upload cancelled or no files selected.';
                     progressBar.style.width = '0%';
                     // Optionally hide the popup after a delay
                     // setTimeout(hideUploadPopup, 2000);
                 }
                 // Reset for next potential upload session
                 postUploadData = null;
                 successfulUploadsBatch = 0;
            }
        };

        cloudinary.openUploadWidget({
            cloudName, uploadPreset, sources: ['local'],
            resourceType: 'video', multiple: false, // Allow only single uploads for simpler title/name logic now
            clientAllowedFormats: ['mp4', 'webm', 'mov'], // Common web/overlay formats
            maxFileSize: 300000000, // 300MB limit example
            folder: 'gs_overlay_vault', // Optional: Use a different folder
        }, processQueue);
    }

    // --- Post-Upload Details Modal Logic ---
    function showPostUploadDetailsModal(data) {
        postUploadData = data; // Store data for saving later
        const modal = document.getElementById('postUploadDetailsModal');
        const titleInput = document.getElementById('postUploadTitleInput');
        const uploaderNameSpan = document.getElementById('postUploadUploaderName');
        const errorMsg = document.getElementById('postUploadError');

        // Pre-fill title suggestion based on original filename
        titleInput.value = formatTitle(data.publicId); // Use formatted public_id as default
        uploaderNameSpan.textContent = data.uploaderName || 'Anonymous';
        errorMsg.textContent = '';

        modal.style.display = 'flex';
        titleInput.focus();
    }

    function savePostUploadDetails() {
        if (!postUploadData) return; // Should not happen, but safeguard

        const titleInput = document.getElementById('postUploadTitleInput');
        const errorMsg = document.getElementById('postUploadError');
        const newTitle = titleInput.value.trim();

        if (!newTitle) {
            errorMsg.textContent = "Title cannot be empty.";
            return;
        }

        // Save the title
        renamedTitles[postUploadData.publicId] = newTitle;
        localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));

        // Uploader name already saved during upload success event
        // localStorage.setItem(`uploader_${postUploadData.publicId}`, postUploadData.uploaderName);

        closePostUploadModal(false); // false = not skipped
        showUploadSuccessPopup(postUploadData.publicId, newTitle, postUploadData.uploaderName); // Show final success
        loadVideos(true); // Refresh the gallery
    }

    function closePostUploadModal(skipped = false) {
        document.getElementById('postUploadDetailsModal').style.display = 'none';
        if (skipped && postUploadData) {
            // If skipped, still show success popup with default title/name
             showUploadSuccessPopup(postUploadData.publicId, formatTitle(postUploadData.publicId), postUploadData.uploaderName);
             loadVideos(true); // Refresh gallery even if skipped
        }
        postUploadData = null; // Clear temporary data
    }


    // --- Filtering Logic ---
    function setActiveFilter(buttonElement, filterType, preventLoad = false) { // Added preventLoad flag
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter'));
        buttonElement.classList.add('active-filter');
        currentFilter = filterType;
        // Reset search when changing filter
        document.getElementById('search').value = '';
        currentSearchQuery = '';

        if (!preventLoad) { // Only load if not prevented (e.g., during theme toggle)
             loadVideos(true); // Reset and load based on new filter
        }
    }

    // --- Video Loading & Rendering (Modified for Load More) ---
    async function loadVideos(reset = false) {
        const gallery = document.getElementById("gallery");
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        if (reset) {
            allVideos = [];
            displayedVideos = [];
            currentVideoIndex = 0;
            gallery.innerHTML = '<p class="text-center w-full col-span-full">🔄 Loading videos...</p>';
            loadMoreBtn.style.display = 'none'; // Hide button during initial load/reset
            loadMoreBtn.disabled = true;
        }

        // Show loading state only if resetting
        if(reset) gallery.innerHTML = '<p class="text-center w-full col-span-full">🔄 Loading videos...</p>';

        try {
             // Fetch only if we don't have the data or are resetting
             if (reset || allVideos.length === 0) {
                 const res = await fetch(`/videos`); // Assuming backend sorts by date desc by default
                 if (!res.ok) {
                     const errorData = await res.json().catch(() => ({ error: "Failed to parse error response" }));
                     throw new Error(errorData.details || errorData.error || `Network response was not ok: ${res.statusText}`);
                 }
                 allVideos = await res.json();

                 if (!Array.isArray(allVideos)) {
                     throw new Error("Invalid data format received from server.");
                 }
             }

            // Apply Sorting based on currentFilter (AFTER fetching all)
            sortVideos(); // Apply current sort order to allVideos

            // Apply Search Filter (if any)
            const filteredVideos = applySearchFilter(allVideos);


            // Reset display state for rendering
            if (reset) {
                 gallery.innerHTML = ''; // Clear loading message
                 displayedVideos = [];
                 currentVideoIndex = 0;
            }

            // Render the first batch or based on current index if not resetting
            renderVideoBatch(filteredVideos);


        } catch (error) {
            console.error("Error loading videos:", error);
            gallery.innerHTML = `<p class="text-center w-full col-span-full text-red-500">❌ Error loading videos: ${error.message}</p>`;
             loadMoreBtn.style.display = 'none'; // Hide button on error
        }
    }

     function sortVideos() {
        // Sort the *entire* allVideos array based on the current filter
        switch (currentFilter) {
            case 'popular':
                 console.warn("Popularity sorting not implemented, using random for demo.");
                 allVideos.sort(() => Math.random() - 0.5);
                break;
            case 'relevant':
                // Relevance usually depends on search. If no search, maybe revert to recent?
                 console.warn("Relevance sorting without search context defaults to recent.");
                 allVideos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                break;
            case 'recent':
            default:
                allVideos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                break;
        }
    }

     function applySearchFilter(videos) {
        if (!currentSearchQuery) {
            return videos; // No search query, return all (already sorted)
        }
        const query = currentSearchQuery.toLowerCase();
        return videos.filter(video => {
            const publicId = video.public_id;
            const title = renamedTitles[publicId] || formatTitle(publicId);
            const uploader = uploaderNames[publicId] || ''; // Include uploader in search
            return title.toLowerCase().includes(query) || uploader.toLowerCase().includes(query);
        });
    }


    function renderVideoBatch(sourceVideoList) {
        const gallery = document.getElementById("gallery");
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        const fragment = document.createDocumentFragment();
        const nextBatchEndIndex = Math.min(currentVideoIndex + videosPerLoad, sourceVideoList.length);
        const batch = sourceVideoList.slice(currentVideoIndex, nextBatchEndIndex);

         if (currentVideoIndex === 0 && batch.length === 0) {
             gallery.innerHTML = `<p class="text-center w-full col-span-full">📪 No videos found ${currentSearchQuery ? 'matching "' + currentSearchQuery + '"' : 'in the vault'}.</p>`;
             loadMoreBtn.style.display = 'none';
             return;
         }

        batch.forEach(file => {
            const publicId = file.public_id;
            const safeId = publicId.replace(/[/.]/g, '_');
            const title = renamedTitles[publicId] || formatTitle(publicId);
            const uploader = uploaderNames[publicId] || 'Anonymous'; // Get uploader name
            const videoUrl = `https://res.cloudinary.com/${cloudName}/video/upload/q_auto:eco/v1/${publicId}.mp4`;
            const thumbnailUrl = `https://res.cloudinary.com/${cloudName}/video/upload/w_300,h_200,c_fill,q_auto,so_1/v1/${publicId}.jpg`;

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="video-container" onclick="togglePlay(this)">
                    <video muted playsinline loop preload="metadata" poster="${thumbnailUrl}" src="${videoUrl}">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="text-center font-bold p-2 title truncate" data-id="${publicId}" title="${title}">${title}</div>
                <div class="uploader-name" title="Uploaded by ${uploader}">by - ${uploader}</div> <!-- Display uploader -->
                <div class="card-footer">
                    <a href="${videoUrl}" download="${title.replace(/[^a-z0-9_]/gi, '_')}.mp4" class="download-btn text-sm flex-grow mr-2">Download</a>
                    <button class="menu-btn" onclick="toggleActionMenu(event, '${publicId}')">...</button>
                </div>
                <div class="action-popup" id="actionPopup_${safeId}">
                    <button onclick="triggerRename('${publicId}')">Rename</button>
                    <button class="delete-action" onclick="triggerDelete('${publicId}')">Delete</button>
                </div>
            `;
            fragment.appendChild(card);
            displayedVideos.push(file); // Add to the list of displayed videos
        });

        gallery.appendChild(fragment);
        currentVideoIndex = nextBatchEndIndex; // Update index for next load

        // Update Load More button state
        if (currentVideoIndex < sourceVideoList.length) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.disabled = false;
        } else {
            loadMoreBtn.style.display = 'none';
            loadMoreBtn.disabled = true;
        }
    }

     function loadMoreVideos() {
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        loadMoreBtn.disabled = true; // Prevent double clicks
        loadMoreBtn.textContent = 'Loading...';

         // Apply search filter to the full sorted list before getting the next batch
         const filteredVideos = applySearchFilter(allVideos);

        // Simulate network delay for visual feedback (optional)
        setTimeout(() => {
            renderVideoBatch(filteredVideos);
            loadMoreBtn.textContent = 'Load More Videos';
             // Re-enable only if there are still more videos
             if (currentVideoIndex < filteredVideos.length) {
                 loadMoreBtn.disabled = false;
             } else {
                 loadMoreBtn.style.display = 'none';
             }
        }, 300); // 300ms delay
    }


    function formatTitle(publicId) {
        let name = publicId.split('/').pop(); // Get filename part
        name = name.replace(/\.[^/.]+$/, ""); // Remove extension
        name = name.replace(/[_-]/g, ' '); // Replace underscores/hyphens with spaces
        // Capitalize first letter of each word
        return name.split(' ')
                   .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                   .join(' ');
    }

    // --- Video Card Actions (togglePlay, toggleActionMenu - Keep As Is) ---
    function togglePlay(container) { /* ... keep existing ... */ }
    function toggleActionMenu(event, publicId) { /* ... keep existing ... */ }
    // Close action menus click listener (Keep As Is)
    document.addEventListener('click', function(event) { /* ... keep existing ... */ });


    // --- Password Protected Actions ---
    function getPasswordAndExecute(publicId, actionCallback) {
        const storedPass = localStorage.getItem(`pass_${publicId}`);
        if (!storedPass) {
            alert("Error: No deletion password found in local storage for this video. Cannot perform action. Please ensure you uploaded it with a password on this browser.");
            return;
        }

        showPromptModal({
            title: "Password Required",
            label: "Enter the password set during upload:",
            inputType: 'password',
            confirmText: 'Verify',
            callback: (enteredPassword) => {
                if (enteredPassword === storedPass) {
                    hidePromptModal();
                    actionCallback();
                } else {
                    showPromptError('Incorrect password. Please try again.');
                }
            }
        });
    }

    function triggerRename(publicId) {
        const safeId = publicId.replace(/[/.]/g, '_');
        const popup = document.getElementById(`actionPopup_${safeId}`);
        if (popup) popup.style.display = 'none'; // Close menu

        getPasswordAndExecute(publicId, () => {
            proceedWithRename(publicId);
        });
    }

    function proceedWithRename(publicId) {
        const currentTitle = renamedTitles[publicId] || formatTitle(publicId);
        showPromptModal({
            title: "Rename Video",
            label: `Enter new title for "${currentTitle.substring(0, 30)}${currentTitle.length > 30 ? '...' : ''}":`,
            inputType: 'text',
            placeholder: currentTitle,
            initialValue: currentTitle, // Pre-fill input
            confirmText: 'Save Name',
            callback: (newTitleInput) => {
                 const newTitle = newTitleInput.trim();
                if (newTitle && newTitle !== currentTitle) {
                    renamedTitles[publicId] = newTitle;
                    localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));

                    // Update DOM immediately
                    const titleElement = document.querySelector(`.title[data-id="${publicId}"]`);
                    if (titleElement) {
                        titleElement.textContent = newTitle;
                        titleElement.setAttribute('title', newTitle);
                        const downloadLink = titleElement.closest('.card')?.querySelector('.download-btn');
                        if (downloadLink) {
                            downloadLink.download = `${newTitle.replace(/[^a-z0-9_]/gi, '_')}.mp4`;
                        }
                    }
                    hidePromptModal();
                } else if (!newTitle) {
                    showPromptError("Title cannot be empty.");
                } else {
                     showPromptError("New title is the same as the current title.");
                }
            }
        });
    }


    function triggerDelete(publicId) {
        const safeId = publicId.replace(/[/.]/g, '_');
        const popup = document.getElementById(`actionPopup_${safeId}`);
        if (popup) popup.style.display = 'none'; // Close menu

        getPasswordAndExecute(publicId, () => {
            proceedWithDelete(publicId);
        });
    }

    // Modified to use the confirmation modal
    function proceedWithDelete(publicId) {
        const title = renamedTitles[publicId] || formatTitle(publicId);
        const cardToDelete = document.querySelector(`.title[data-id="${publicId}"]`)?.closest('.card');

        showPromptModal({
            isConfirmation: true, // Indicate it's a confirmation, not input
            title: "Confirm Deletion",
            confirmationContent: `Are you sure you want to permanently delete "<strong>${title}</strong>"?<br>This action cannot be undone.`,
            confirmText: "Delete",
            cancelText: "Cancel",
            confirmClass: 'modal-button-delete', // Apply red style to confirm button
            callback: (confirmed) => {
                if (confirmed) {
                    hidePromptModal(); // Hide confirmation modal first
                    if (cardToDelete) {
                         cardToDelete.style.opacity = '0.5'; // Dim card during request
                         cardToDelete.style.pointerEvents = 'none';
                    }
                    // Execute the actual delete network request
                    fetch(`/delete/${encodeURIComponent(publicId)}`, { method: "DELETE" })
                        .then(response => {
                            if (!response.ok) {
                                return response.json().then(err => { throw new Error(err.message || `Server error: ${response.status}`); })
                                             .catch(() => { throw new Error(`Server error: ${response.status} ${response.statusText}`); });
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Delete response:", data);
                            if (data.status === "success") {
                                if (cardToDelete) cardToDelete.remove();
                                // Clean up local storage
                                localStorage.removeItem(`pass_${publicId}`);
                                delete renamedTitles[publicId];
                                delete uploaderNames[publicId]; // Remove uploader name too
                                localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));
                                localStorage.setItem('uploaderNames', JSON.stringify(uploaderNames));

                                // Remove from allVideos array to prevent reappearance on filter/search
                                allVideos = allVideos.filter(v => v.public_id !== publicId);
                                // Also update displayedVideos if necessary
                                displayedVideos = displayedVideos.filter(v => v.public_id !== publicId);

                                alert(data.message || "Video deleted successfully.");
                            } else {
                                throw new Error(data.message || "Deletion failed on server.");
                            }
                        })
                        .catch(err => {
                            alert(`Failed to delete video: ${err.message}`);
                            console.error("Deletion error:", err);
                             if (cardToDelete) {
                                 cardToDelete.style.opacity = '1'; // Restore opacity on failure
                                 cardToDelete.style.pointerEvents = 'auto';
                             }
                        });
                } else {
                     hidePromptModal(); // User clicked cancel in the modal
                     if (cardToDelete) {
                         cardToDelete.style.opacity = '1'; // Ensure card is visible if cancelled
                     }
                }
            }
        });
    }


    // --- Search (Modified to work with Load More) ---
    function searchVideos() {
        const query = document.getElementById("search").value.toLowerCase().trim();
         // Only trigger full reload if search query actually changed
         if (query !== currentSearchQuery) {
             currentSearchQuery = query;
             loadVideos(true); // Reset and load with the new search query applied
         }
    }


    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
       handleIntro(); // Start intro animation first
       // Terms check and page init will happen after intro fades out (in handleIntro)
    });

  </script>

</body>
</html>
