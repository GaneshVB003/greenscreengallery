<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Green Screen Overlay Vault</title>
  <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Base Styles (Keep previous styles) */
    body { font-family: 'Segoe UI', sans-serif; transition: background 0.3s, color 0.3s; }
    html[data-theme="dark"] body { background: #0e0e0e; color: white; }
    html[data-theme="light"] body { background: #f4f4f4; color: black; }
    .header { background: #00ff88; color: black; padding: 2rem; text-align: center; font-size: 2.5rem; font-weight: bold; position: relative; }
    html[data-theme="light"] .header { background: #10b981; color: white;}

    .header h1 { animation: fadeInDown 1s ease-in-out; }
    .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; padding: 2rem; }
    .card { background: #1a1a1a; border-radius: 1rem; overflow: hidden; box-shadow: 0 0 10px #00ff88; transition: transform 0.3s, box-shadow 0.3s; animation: fadeInUp 0.5s ease-in-out; position: relative; display: flex; flex-direction: column; } /* Added flex */
    html[data-theme="light"] .card { background: #ffffff; color: black; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    html[data-theme="light"] .card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .card:hover { transform: scale(1.05); box-shadow: 0 0 15px #00ff88; }
    .video-container { /* Added for click-to-play */ cursor: pointer; }
    .video-container video { width: 100%; height: auto; max-height: 200px; object-fit: cover; border-radius: 1rem 1rem 0 0; background-color: #050505; display: block; /* Ensure no extra space */ }

    .card-content { padding: 0.5rem 0.8rem; flex-grow: 1; } /* Wrapper for title & publisher */
    .card-content .title { font-weight: bold; text-align: center; margin-bottom: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;} /* Ensure title wraps */
    .card-content .publisher-name { font-size: 0.75rem; text-align: center; opacity: 0.6; }
    html[data-theme="light"] .card-content .publisher-name { opacity: 0.7; }

    .download-btn { background: #00ff88; color: black; padding: 0.5rem; text-align: center; font-weight: bold; margin: 0.5rem; display: block; border-radius: 0.5rem; transition: background-color 0.2s; }
    .download-btn:hover { background: #00dd77; }
    html[data-theme="light"] .download-btn { background: #10b981; color: white; }
    html[data-theme="light"] .download-btn:hover { background: #059669; }

    .progress-container { width: 100%; background: #333; border-radius: 10px; overflow: hidden; height: 10px; margin-top: 1rem; }
    .progress-bar { height: 10px; background: linear-gradient(270deg, #00ff88, #00ccff); animation: glow 1s infinite alternate; width: 0%; }

    /* --- Card Menu & Action Popup Styles --- */
    .card-footer { padding: 0.5rem 0.8rem; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #2a2a2a; margin-top: auto; /* Push footer down */ }
    html[data-theme="light"] .card-footer { border-top-color: #eee; }
    .menu-btn { background: rgba(0, 255, 136, 0.5); border: none; border-radius: 50%; padding: 0.3rem 0.5rem; font-weight: bold; cursor: pointer; line-height: 1; color: black; }
    html[data-theme="light"] .menu-btn { background: rgba(16, 185, 129, 0.6); color: white;}
    .menu-btn:hover { background: rgba(0, 255, 136, 0.8); }
    html[data-theme="light"] .menu-btn:hover { background: rgba(16, 185, 129, 0.9); }

    .action-popup {
        display: none; /* Hidden by default */
        position: absolute;
        bottom: 45px; /* Position above the footer */
        right: 10px;
        background-color: #2a2a2a;
        border: 1px solid #00ff88;
        border-radius: 8px;
        padding: 0.5rem;
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
        z-index: 10;
        animation: popUpFadeIn 0.3s ease-out;
        min-width: 100px; /* Ensure minimum width */
    }
    html[data-theme="light"] .action-popup { background-color: #f0f0f0; border-color: #10b981; color: black; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }

    .action-popup button {
        display: block;
        width: 100%;
        background: none;
        border: none;
        color: #00ccff;
        padding: 0.4rem 0.6rem;
        text-align: left;
        cursor: pointer;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    html[data-theme="light"] .action-popup button { color: #0c4a6e; }
    .action-popup button:hover { background-color: #3a3a3a; }
    html[data-theme="light"] .action-popup button:hover { background-color: #e5e7eb; }
    .action-popup button.delete-action { color: #ff4444; }
    html[data-theme="light"] .action-popup button.delete-action { color: #dc2626; }
    .action-popup button.delete-action:hover { background-color: #4a2a2a; }
    html[data-theme="light"] .action-popup button.delete-action:hover { background-color: #fee2e2; }

    /* --- Generic Modal Styles --- */
    .modal-backdrop {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.7);
        display: none; /* Hidden by default */
        align-items: center;
        justify-content: center;
        z-index: 50;
        animation: fadeIn 0.3s ease-out;
    }
    .modal-box {
        background-color: #1f1f1f;
        color: white;
        padding: 1.5rem 2rem;
        border-radius: 1rem;
        border: 1px solid #00ff88;
        box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        width: 90%;
        max-width: 500px; /* Slightly wider default */
        animation: scaleUp 0.3s ease-out;
        position: relative; /* For close button */
        max-height: 85vh; /* Prevent modal overflow */
        display: flex; /* Use flex for better control */
        flex-direction: column;
    }
    html[data-theme="light"] .modal-box { background-color: #ffffff; color: black; border-color: #10b981; box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4); }
    .modal-box h2 { font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem; color: #00ff88; flex-shrink: 0; /* Prevent title shrinking */}
    html[data-theme="light"] .modal-box h2 { color: #10b981; }

    .modal-content { overflow-y: auto; /* Scroll content */ margin-bottom: 1rem; flex-grow: 1; /* Allow content to take space */}
    .modal-content p { margin-bottom: 0.8rem; line-height: 1.6; }
    .modal-content h3 { font-size: 1.1rem; font-weight: bold; color: #00ccff; margin-top: 1rem; margin-bottom: 0.5rem; }
    html[data-theme="light"] .modal-content h3 { color: #38bdf8; }
    .modal-content ul, .modal-content ol { list-style-position: inside; margin-left: 0.5rem; margin-bottom: 1rem; }
    .modal-content li { margin-bottom: 0.4rem; }
    .modal-content code { background: #333; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.9em; }
    html[data-theme="light"] .modal-content code { background: #e5e7eb; color: #374151;}

    .modal-box label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; }
    .modal-box input[type="text"], .modal-box input[type="password"] {
        width: 100%;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #333;
        border: 1px solid #555;
        color: white;
        margin-bottom: 1rem;
    }
    html[data-theme="light"] .modal-box input[type="text"], html[data-theme="light"] .modal-box input[type="password"] { background-color: #e5e7eb; border-color: #ccc; color: black; }

    .modal-buttons { display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem; flex-shrink: 0; /* Prevent buttons shrinking */}
    .modal-buttons button {
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
    }
    .modal-button-confirm { background-color: #00ff88; color: black; }
    .modal-button-confirm:hover { background-color: #00dd77; }
    html[data-theme="light"] .modal-button-confirm { background-color: #10b981; color: white; }
    html[data-theme="light"] .modal-button-confirm:hover { background-color: #059669; }
    .modal-button-cancel { background-color: #555; color: white; }
    .modal-button-cancel:hover { background-color: #666; }
    html[data-theme="light"] .modal-button-cancel { background-color: #a1a1aa; color: black; }
    html[data-theme="light"] .modal-button-cancel:hover { background-color: #71717a; }

    .modal-error { color: #ff4444; font-size: 0.9rem; margin-top: 0.5rem; height: 1.2em; /* Reserve space */ }
    .modal-close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #888;
        cursor: pointer;
        line-height: 1;
    }
    html[data-theme="light"] .modal-close-btn { color: #555; }

    /* --- Upload Success Modal Styles --- */
    #uploadSuccessPopup .modal-box { border-color: #00ccff; box-shadow: 0 5px 20px rgba(0, 204, 255, 0.4); }
    #uploadSuccessPopup h2 { color: #00ccff; }
    html[data-theme="light"] #uploadSuccessPopup .modal-box { border-color: #38bdf8; box-shadow: 0 5px 20px rgba(56, 189, 248, 0.4); }
    html[data-theme="light"] #uploadSuccessPopup h2 { color: #38bdf8; }
    #uploadSuccessContent { margin-bottom: 1.5rem; line-height: 1.6; }

    /* --- Confirmation Modal Specific Styles --- */
    #confirmationModal .modal-box { max-width: 400px; } /* Smaller confirm modal */
    #confirmationModal .modal-content { text-align: center; font-size: 1.1rem; margin-bottom: 1.5rem;}

    /* --- Terms Modal Styles --- */
    #termsModal .modal-box { max-width: 700px; } /* Wider for T&C */
    #termsModal .modal-content { font-size: 0.9rem; }

    /* --- Info Modal Styles --- */
    #infoModal .modal-box { max-width: 600px; }
    #infoModal h3 { color: #00ff88; }
    html[data-theme="light"] #infoModal h3 { color: #10b981; }

    /* Other Styles */
    .filter-btn { background: #00ccff; color: black; padding: 0.5rem 1rem; margin: 1rem 0; text-align: center; font-weight: bold; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; border: 2px solid transparent; }
    html[data-theme="light"] .filter-btn { background: #38bdf8; color: white; }
    .filter-btn:hover { transform: translateY(-2px); }
    .filter-btn.active-filter { background-color: #00ff88; color: black; border: 2px solid #0e0e0e; box-shadow: 0 0 8px #00ff88; }
    html[data-theme="light"] .filter-btn.active-filter { background-color: #10b981; color: white; border: 2px solid #f4f4f4; box-shadow: 0 0 8px #10b981; }
    .filter-options { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .screenshot { width: 100%; max-width: 600px; border-radius: 1rem; margin: 1rem auto; display: block; }
    html[data-theme="light"] input#search,
    html[data-theme="light"] input#renameInput,
    html[data-theme="light"] input#publisherNameInput, /* Added */
    html[data-theme="light"] input#deletePassword { background: #e5e7eb; color: black; border: 1px solid #ccc; }
    html[data-theme="light"] #uploadPopup .upload-box { background: #f9fafb; color: black; border-color: #10b981; }
    html[data-theme="light"] .header button.header-btn { background: #4b5563; color: white; }
    html[data-theme="light"] .header button.header-btn:hover { background: #6b7280; }
    html[data-theme="light"] .header button.theme-toggle-btn { background: white; color: black; border: 1px solid #ccc; }
    html[data-theme="light"] .header button.theme-toggle-btn:hover { background: #f3f4f6; }
    .header-btn { background: #000; color: white; border: 1px solid #fff; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s; font-size: 0.9rem; position: absolute; top: 50%; transform: translateY(-50%); }
    .upload-btn { right: 1.5rem; }
    .info-btn { right: calc(1.5rem + 100px); } /* Position info button next to upload */
    .theme-toggle-btn { left: 1.5rem; background: white; color: black; }

    /* Animations */
    @keyframes glow { from { filter: drop-shadow(0 0 5px #00ff88); } to { filter: drop-shadow(0 0 15px #00ccff); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes popUpFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .landing-page { animation: fadeInUp 1s ease-in-out; margin-top: 2rem; }
    .content-section { max-width: 800px; margin: 2rem auto; padding: 1.5rem; background: #1a1a1a; border-radius: 1rem; box-shadow: 0 0 10px rgba(0, 255, 136, 0.2); }
    html[data-theme="light"] .content-section { background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .content-section h2 { font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; color: #00ff88; text-align: center; }
    html[data-theme="light"] .content-section h2 { color: #10b981; }
    .content-section p, .content-section ol { margin-bottom: 1rem; line-height: 1.7; }
    .content-section ol { list-style-position: inside; margin-left: 0.5rem; }
    .content-section li { margin-bottom: 0.5rem; }

    /* --- Responsive Video Wrapper --- */
    .video-wrapper {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
        height: 0;
        overflow: hidden;
        max-width: 650px;
        margin: 1.5rem auto;
        border-radius: 1rem;
        background: #000;
         box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
     html[data-theme="light"] .video-wrapper {
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }

    /* --- Footer --- */
    .site-footer { text-align: center; padding: 1.5rem; margin-top: 2rem; font-size: 0.9rem; border-top: 1px solid #333; }
    html[data-theme="light"] .site-footer { border-top-color: #ddd; }
    .footer-link { color: #00ccff; text-decoration: none; margin: 0 0.5rem; }
    html[data-theme="light"] .footer-link { color: #0c4a6e; }
    .footer-link:hover { text-decoration: underline; }

  </style>
</head>
<body>

  <div class="header">
    <h1>🎬 Green Screen Overlay Vault</h1>
    <!-- Updated Header Buttons -->
    <button onclick="showUploadPopup()" class="header-btn upload-btn">Upload</button>
    <button onclick="showInfoModal()" class="header-btn info-btn">ℹ️ Info</button>
    <button onclick="toggleTheme()" class="header-btn theme-toggle-btn">🌗</button>
  </div>

  <div class="text-center px-4 mt-4">
    <div class="filter-options">
      <button class="filter-btn" id="filter-recent" onclick="setActiveFilter(this, 'recent')">Most Recent</button>
      <button class="filter-btn" id="filter-popular" onclick="setActiveFilter(this, 'popular')">Most Popular</button>
      <button class="filter-btn" id="filter-relevant" onclick="setActiveFilter(this, 'relevant')">Relevant</button>
    </div>
    <label for="search" class="mr-2">Search Videos:</label>
    <input type="text" id="search" oninput="searchVideos()" class="bg-gray-800 text-white p-2 rounded border border-gray-600" placeholder="Search by title...">
  </div>

  <div class="gallery" id="gallery">Loading videos...</div>

  <!-- How to Use Section -->
  <div class="content-section landing-page">
      <h2>How to Use Green Screen Overlays</h2>
      <p>Green screen overlays (or chroma key footage) allow you to easily composite effects or elements into your video projects. Here's a basic guide for Adobe Premiere Pro:</p>
      <div class="video-wrapper">
        <iframe src="https://www.youtube.com/embed/-UFG_jU3bXA" title="YouTube video player - Green Screen Tutorial (Adobe Premiere Pro Ultra Key)" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>
      <ol>
          <li><strong>Import:</strong> Bring your main video footage and the green screen overlay video file into your Premiere Pro project.</li>
          <li><strong>Layer:</strong> Place the green screen overlay clip on a track *above* your main footage clip in the timeline.</li>
          <li><strong>Effect:</strong> Go to the 'Effects' panel, search for 'Ultra Key', and drag it onto the green screen overlay clip in the timeline.</li>
          <li><strong>Key Color:</strong> In the 'Effect Controls' panel, find the 'Ultra Key' settings. Use the eyedropper tool next to 'Key Color' to click on the green color in your overlay video (visible in the Program Monitor).</li>
          <li><strong>Refine:</strong> Adjust settings like 'Matte Generation' (Transparency, Shadow, Tolerance) and 'Matte Cleanup' (Choke, Soften) to fine-tune the key and remove any green edges or spill. 'Spill Suppression' can also help remove green reflections on the subject.</li>
          <li><strong>Composite:</strong> The green area should now be transparent, revealing your main footage underneath. You can resize, position, and animate the overlay layer as needed.</li>
      </ol>
      <p>Similar 'keying' or 'chroma key' effects are available in most video editing software like DaVinci Resolve (Delta Keyer, 3D Keyer), Final Cut Pro (Keyer), CapCut, and others.</p>
  </div>

  <!-- About Section -->
  <div class="content-section landing-page">
      <h2>About This Vault</h2>
      <p>Welcome to the Green Screen Overlay Vault! This is a community-driven platform for sharing and discovering free green screen video effects and overlays.</p>
      <p>Whether you're making YouTube videos, streaming, creating social media content, or working on film projects, high-quality overlays can add that extra flair. The goal here is to build a useful library contributed by creators like you.</p>
      <p>Upload your own creations (ensure you have the rights!), browse what others have shared, and easily download assets for your projects. Remember to set a password during upload if you want to manage your contributions later.</p>
  </div>

   <!-- Tips for Uploaders Section -->
   <div class="content-section landing-page">
      <h2>Tips for Uploaders</h2>
      <p>Want to contribute high-quality overlays? Here are a few tips:</p>
      <ol>
        <li><strong>Clean Green Background:</strong> Use a well-lit, evenly colored green screen. Avoid wrinkles or shadows, as these make keying harder. Bright, saturated green usually works best.</li>
        <li><strong>Good Lighting:</strong> Light your subject or effect separately from the green screen if possible. Avoid green light spilling onto your subject.</li>
        <li><strong>Clear Subject Separation:</strong> Ensure the element you want to key out is distinctly separate from the green background (e.g., avoid green clothing or props unless intentional).</li>
        <li><strong>Common Formats:</strong> MP4 (with H.264 codec) is widely compatible. MOV (especially ProRes with alpha if your effect has transparency *without* green) or WEBM can also be good choices.</li>
        <li><strong>Keep it Concise:</strong> Trim unnecessary parts before uploading.</li>
        <li><strong>Descriptive Title (Optional):</strong> While you can rename later, giving it a hint in the filename (e.g., `smoke_puff_overlay.mp4`) can be helpful.</li>
      </ol>
      <p>By following these tips, you help make the overlays easier for everyone to use!</p>
   </div>

  <!-- Upload Popup (Added Publisher Name Input) -->
  <div class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50" id="uploadPopup">
    <div class="upload-box bg-gray-900 text-white p-6 rounded-lg border border-green-500 w-full max-w-md mx-4">
      <h2 class="text-xl font-bold mb-4">Upload Green Screen Overlay</h2>
      <input type="text" id="renameInput" placeholder="Optional: Video Title (e.g., 'Explosion Effect')" class="bg-gray-800 text-white p-2 rounded mb-4 w-full border border-gray-600">
      <input type="text" id="publisherNameInput" placeholder="Optional: Your Name/Handle (e.g., 'CreativeGuy')" class="bg-gray-800 text-white p-2 rounded mb-4 w-full border border-gray-600">
      <input type="password" id="deletePassword" placeholder="Set Deletion Password (store safely!) *" required class="bg-gray-800 text-white p-2 rounded mb-4 w-full border border-gray-600">
      <p class="text-xs text-gray-400 mb-3 -mt-3">*Required to rename or delete later.</p>
      <button onclick="openCloudinaryUpload()" class="bg-green-400 hover:bg-green-500 px-4 py-2 rounded text-black font-bold w-full transition-colors">Select & Upload Video</button>
      <div class="progress-container mt-4"><div class="progress-bar" id="progressBar"></div></div>
      <p id="uploadStatus" class="mt-4 text-sm h-5"></p>
      <button onclick="hideUploadPopup()" class="text-red-400 hover:text-red-500 underline mt-4 block w-full text-center">Cancel</button>
    </div>
  </div>

  <!-- Generic Prompt Modal -->
  <div class="modal-backdrop" id="promptModal">
    <div class="modal-box">
      <button class="modal-close-btn" onclick="hidePromptModal()">×</button>
      <h2 id="promptTitle">Prompt</h2>
      <div id="promptContent" class="modal-content"> <!-- Added modal-content class -->
        <label for="promptInput" id="promptLabel">Input:</label>
        <input type="text" id="promptInput" name="promptInput">
        <p class="modal-error" id="promptError"></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-button-cancel" onclick="hidePromptModal()">Cancel</button>
        <button class="modal-button-confirm" id="promptConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

    <!-- Simple Confirmation Modal -->
    <div class="modal-backdrop" id="confirmationModal">
        <div class="modal-box">
            <button class="modal-close-btn" onclick="hideConfirmationModal()">×</button>
            <h2 id="confirmationTitle">Confirm Action</h2>
            <div class="modal-content" id="confirmationMessage">
                Are you sure?
            </div>
            <div class="modal-buttons">
                <button class="modal-button-cancel" id="confirmationCancelBtn">Cancel</button>
                <button class="modal-button-confirm" id="confirmationConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

  <!-- Upload Success Modal -->
  <div class="modal-backdrop" id="uploadSuccessPopup">
      <div class="modal-box">
          <button class="modal-close-btn" onclick="closeSuccessPopupAndRefresh()">×</button>
          <h2>🚀 Upload Complete!</h2>
          <div id="uploadSuccessContent" class="modal-content"> <!-- Added modal-content -->
              <p>Thank you for your contribution! Your green screen overlay has been successfully added to the vault.</p>
              <p>Sharing helps the creative community grow. Keep up the great work!</p>
              <p><strong>Video Title:</strong> <span id="successVideoTitle" class="font-semibold"></span></p>
              <p><strong>Uploaded By:</strong> <span id="successPublisherName" class="font-semibold"></span></p>
          </div>
          <div class="modal-buttons">
              <button class="modal-button-confirm" onclick="closeSuccessPopupAndRefresh()">Awesome!</button>
          </div>
      </div>
  </div>

  <!-- Terms & Conditions Modal -->
  <div class="modal-backdrop" id="termsModal">
    <div class="modal-box">
      <button class="modal-close-btn" onclick="hideTermsModal(false)">×</button> <!-- Close without accepting -->
      <h2>Terms & Privacy</h2>
      <div class="modal-content">
        <p><strong>Last updated:</strong> April 26, 2024</p> <!-- NOTE: Year changed to current -->

        <p>Welcome to Green Screen Overlay Vault! By accessing or using our website, you agree to be bound by these Terms and Conditions and our Privacy Policy. Please read them carefully.</p>

        <h3>Terms and Conditions</h3>
        <ol>
            <li><strong>Acceptance of Terms:</strong> By using this site, you agree to comply with and be legally bound by these Terms, our Privacy Policy, and any applicable laws and regulations.</li>
            <li><strong>Uploading Content:</strong> When you upload videos ("Content"), you confirm that you own or have obtained the necessary rights and permissions to share them publicly. You grant Green Screen Overlay Vault a non-exclusive, worldwide, royalty-free license to host, display, distribute, and allow users to download your Content via the website.</li>
            <li><strong>Deletion Password:</strong> You are solely responsible for setting and securely storing a deletion password during upload. This password is required to rename or delete your uploaded Content later. We cannot recover or reset lost passwords.</li>
            <li><strong>Prohibited Content:</strong> You must not upload Content that: (a) Infringes copyright, trademark, patent, trade secret, privacy, publicity, or other intellectual property rights; (b) Is unlawful, harmful, threatening, abusive, harassing, defamatory, vulgar, obscene, invasive of another's privacy, hateful, or racially, ethnically, or otherwise objectionable; (c) Contains software viruses or any other computer code designed to interrupt, destroy, or limit the functionality of any computer software or hardware. We reserve the right to remove any Content and/or terminate user access for uploading prohibited Content without prior notice and at our sole discretion.</li>
            <li><strong>Disclaimer of Warranties:</strong> The site and its content are provided "as is" and "as available" without warranties of any kind, either express or implied, including, but not limited to, implied warranties of merchantability, fitness for a particular purpose, or non-infringement. We do not warrant that the site will be uninterrupted, error-free, or secure.</li>
            <li><strong>Limitation of Liability:</strong> Green Screen Overlay Vault and its operators will not be liable for any direct, indirect, incidental, special, consequential, or punitive damages resulting from your access to or use of, or inability to access or use, the website or Content, including data loss, misuse, or unauthorized access.</li>
            <li><strong>Changes to Terms:</strong> We reserve the right to modify these Terms at any time. We will post the revised Terms on this page with an updated "Last updated" date. Your continued use of the site after changes constitutes your acceptance of the new Terms.</li>
            <li><strong>Governing Law:</strong> These Terms shall be governed by the laws of [Your Jurisdiction - IMPORTANT: Specify e.g., "the State of California, USA" or relevant country], without regard to its conflict of law provisions.</li>
            <li><strong>Contact:</strong> For questions about these Terms, please contact us at ganeshvb003@gmail.com.</li>
        </ol>

        <h3>Privacy Policy</h3>
        <p><strong>Effective Date:</strong> April 26, 2024</p> <!-- NOTE: Year changed to current -->
        <p>We value your privacy. This Privacy Policy explains how we handle information.</p>
        <ol>
            <li><strong>Information We Collect:</strong>
                <ul>
                    <li><strong>Upload Information:</strong> Video files, optional titles you provide, optional publisher names, and the deletion password you set during upload.</li>
                    <li><strong>Locally Stored Data:</strong> Deletion passwords, renamed titles, and publisher names associated with your uploads are stored *only* in your web browser's local storage. They are *not* sent to or stored on our servers.</li>
                    <li><strong>Usage Data (Potentially):</strong> We may collect anonymous, aggregated usage statistics (e.g., page views, download counts) using privacy-respecting analytics tools to improve the service. No personally identifiable information is tracked this way.</li>
                </ul>
            </li>
            <li><strong>Use of Information:</strong>
                <ul>
                    <li>Uploaded videos, titles, and publisher names are displayed publicly in the gallery.</li>
                    <li>Deletion passwords stored locally are used *only* by your browser to authenticate rename/delete requests initiated by you.</li>
                    <li>We do not sell, trade, rent, or share your uploaded content data (other than public display) or local storage data with third parties, except as required by law or for the core functionality (like Cloudinary hosting).</li>
                </ul>
            </li>
            <li><strong>Cookies and Local Storage:</strong> We use browser local storage to remember your deletion passwords, renamed titles, publisher names, and whether you've accepted these terms. This data persists only in your browser. You can clear your browser's local storage at any time, but this will remove your saved passwords and re-trigger the T&C prompt. We do not use tracking cookies for advertising.</li>
            <li><strong>Data Security:</strong> Uploaded videos are stored with Cloudinary. We rely on their security measures. The passwords you set are stored *only* in your browser's local storage – their security depends on your device and browser security. We cannot access or recover these passwords. Do not reuse important passwords.</li>
            <li><strong>Third-Party Services:</strong> We use Cloudinary (cloudinary.com) for video hosting, storage, and delivery. Their terms and privacy policy govern their handling of the video files.</li>
            <li><strong>Your Rights & Responsibilities:</strong> You have the right to delete your uploaded videos using the password you set. You are responsible for managing the data stored locally in your browser (passwords, titles, etc.) and for the content you upload.</li>
            <li><strong>Children's Privacy:</strong> This service is not intended for children under the age of 13 (or applicable age in your jurisdiction). We do not knowingly collect information from children.</li>
            <li><strong>Changes to this Privacy Policy:</strong> We may update this policy. Changes will be posted on this page with an updated effective date.</li>
            <li><strong>Contact:</strong> For privacy concerns, contact ganeshvb003@gmail.com.</li>
        </ol>
      </div>
      <div class="modal-buttons">
        <button class="modal-button-confirm" onclick="hideTermsModal(true)">I Understand and Agree</button>
      </div>
    </div>
  </div>

    <!-- Info Modal -->
    <div class="modal-backdrop" id="infoModal">
        <div class="modal-box">
          <button class="modal-close-btn" onclick="hideInfoModal()">×</button>
          <h2>ℹ️ Site Information</h2>
          <div class="modal-content">
            <h3>What is this?</h3>
            <p>The Green Screen Overlay Vault is a free resource for video creators. Find and share reusable video clips with green backgrounds (chroma key footage) to easily add effects like explosions, lower thirds, social media icons, transitions, and more to your projects.</p>

            <h3>How does it work?</h3>
            <p>Users can upload their own green screen overlay videos. These are hosted using Cloudinary. Other users can then browse the gallery, preview the videos, and download them for free.</p>

            <h3>Uploading & Managing</h3>
            <p>When uploading, you can optionally provide a title and your name/handle (Publisher). You *must* set a password if you ever want to rename or delete your upload later. <strong>Keep this password safe – it cannot be recovered!</strong></p>

            <h3>Content Policy</h3>
            <p>Please only upload content you own or have the rights to share. Do not upload copyrighted material, offensive content, or anything illegal. We reserve the right to remove content that violates our <a href="#" class="footer-link" onclick="hideInfoModal(); showTermsModal(); return false;">Terms and Conditions</a>.</p>

            <h3>Usage</h3>
            <p>Content downloaded from this site is generally intended for use in your own video projects (personal or commercial, unless the uploader specifies otherwise - though currently there's no mechanism for specific licenses). Please respect the implicit sharing nature of the platform.</p>

            <h3>Technology</h3>
            <p>This site uses HTML, Tailwind CSS, Vanilla JavaScript, Cloudinary for video hosting/delivery, and potentially a simple backend (Node.js/Express mentioned in previous context, though not visible here) for fetching video lists and handling delete requests.</p>
           </div>
          <div class="modal-buttons">
            <button class="modal-button-confirm" onclick="hideInfoModal()">Got it!</button>
          </div>
        </div>
      </div>

    <!-- Footer -->
    <footer class="site-footer">
        <span>© 2024 Green Screen Overlay Vault</span> |
        <a href="#" class="footer-link" onclick="showTermsModal()">Terms & Privacy</a> |
        <a href="#" class="footer-link" onclick="showInfoModal()">About</a>
    </footer>


  <script>
    const cloudName = 'dogxcu1sj';
    const uploadPreset = 'gs_overlay';
    let allVideos = [];
    let renamedTitles = JSON.parse(localStorage.getItem('renamedTitles') || '{}');
    let publisherNames = JSON.parse(localStorage.getItem('publisherNames') || '{}'); // Added for publisher names
    let currentFilter = 'recent';

    // --- Modal Helper Functions ---
    let currentPromptCallback = null;
    let currentConfirmationCallback = null; // For the simple confirmation modal

    function showPromptModal({ title, label, inputType = 'text', placeholder = '', confirmText = 'Confirm', cancelText = 'Cancel', callback, initialValue = '' }) {
        document.getElementById('promptTitle').innerText = title;
        document.getElementById('promptLabel').innerText = label;
        const input = document.getElementById('promptInput');
        input.type = inputType;
        input.placeholder = placeholder;
        input.value = initialValue; // Set initial value
        document.getElementById('promptError').innerText = '';
        document.getElementById('promptConfirmBtn').innerText = confirmText;
        document.getElementById('promptModal').querySelector('.modal-button-cancel').innerText = cancelText; // Update cancel button text too if needed

        currentPromptCallback = callback;

        // Ensure correct callback is attached
        document.getElementById('promptConfirmBtn').onclick = () => {
            if (currentPromptCallback) {
                currentPromptCallback(input.value);
            }
        };

        document.getElementById('promptModal').style.display = 'flex';
        input.focus();
        input.select(); // Select the text if initial value is provided
    }

    function hidePromptModal() {
        document.getElementById('promptModal').style.display = 'none';
        currentPromptCallback = null;
    }

    function showPromptError(message) {
        document.getElementById('promptError').innerText = message;
    }

    // --- Simple Confirmation Modal ---
    function showConfirmationModal({ title = 'Confirm', message = 'Are you sure?', confirmText = 'Confirm', cancelText = 'Cancel', onConfirm, onCancel }) {
        document.getElementById('confirmationTitle').innerText = title;
        document.getElementById('confirmationMessage').innerHTML = message; // Use innerHTML to allow basic formatting if needed
        document.getElementById('confirmationConfirmBtn').innerText = confirmText;
        document.getElementById('confirmationCancelBtn').innerText = cancelText;

        document.getElementById('confirmationConfirmBtn').onclick = () => {
            hideConfirmationModal();
            if (onConfirm) onConfirm();
        };

        document.getElementById('confirmationCancelBtn').onclick = () => {
            hideConfirmationModal();
            if (onCancel) onCancel();
        };

        document.getElementById('confirmationModal').style.display = 'flex';
    }

    function hideConfirmationModal() {
        document.getElementById('confirmationModal').style.display = 'none';
    }


    // --- Upload Success Modal ---
    function showUploadSuccessPopup(publicId) {
         const title = renamedTitles[publicId] || formatTitle(publicId);
         const publisher = publisherNames[publicId] || 'Anonymous';
         document.getElementById('successVideoTitle').innerText = title;
         document.getElementById('successPublisherName').innerText = publisher;
         document.getElementById('uploadSuccessPopup').style.display = 'flex';
    }

    function closeSuccessPopupAndRefresh() {
        document.getElementById('uploadSuccessPopup').style.display = 'none';
        loadVideos(true); // Reload the video list
    }

    // --- Terms & Conditions Modal ---
    function showTermsModal() {
        document.getElementById('termsModal').style.display = 'flex';
    }

    function hideTermsModal(accepted = false) {
        document.getElementById('termsModal').style.display = 'none';
        if (accepted) {
            localStorage.setItem('hasAcceptedTerms', 'true');
            console.log("Terms accepted and stored.");
        }
    }

    function checkTerms() {
        if (localStorage.getItem('hasAcceptedTerms') !== 'true') {
            console.log("Terms not accepted yet, showing modal.");
            showTermsModal();
        } else {
            console.log("Terms already accepted.");
        }
    }

    // --- Info Modal ---
     function showInfoModal() {
        document.getElementById('infoModal').style.display = 'flex';
    }
    function hideInfoModal() {
        document.getElementById('infoModal').style.display = 'none';
    }


    // --- Theme Toggle ---
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      html.setAttribute("data-theme", newTheme);
      // Re-apply active filter style if necessary (borders might change)
      const activeButton = document.querySelector('.filter-btn.active-filter');
      if (activeButton) {
          // Force re-application of the class to update styles
          const currentFilterType = activeButton.id.split('-')[1];
          setActiveFilter(activeButton, currentFilterType);
      }
    }

    // --- Upload Logic ---
    function showUploadPopup() {
        document.getElementById("renameInput").value = '';
        document.getElementById("publisherNameInput").value = ''; // Clear publisher input
        document.getElementById("deletePassword").value = '';
        document.getElementById("progressBar").style.width = '0%';
        document.getElementById("uploadStatus").innerText = '';
        document.getElementById("uploadPopup").style.display = "flex";
    }

    function hideUploadPopup() {
        document.getElementById("uploadPopup").style.display = "none";
    }

    function openCloudinaryUpload() {
        const optionalRename = document.getElementById("renameInput").value.trim(); // Optional initial title
        const publisherName = document.getElementById("publisherNameInput").value.trim(); // Get publisher name
        const delPass = document.getElementById("deletePassword").value.trim();
        const progressBar = document.getElementById("progressBar");
        const status = document.getElementById("uploadStatus");
        const uploadBox = document.getElementById("uploadPopup").querySelector('.upload-box');

        if (!delPass) {
            status.innerText = "❌ Deletion password is required.";
            status.style.color = '#ff4444'; // Error color
            // Optional: Add shake animation or border highlight to password field
            const passInput = document.getElementById("deletePassword");
            passInput.style.border = '2px solid #ff4444';
            setTimeout(() => { passInput.style.border = ''; }, 2000); // Reset border after 2s
            return;
        }
         status.style.color = ''; // Reset color if previously error
         status.innerText = 'Initializing upload...';
         progressBar.style.width = '0%';
         uploadBox.style.pointerEvents = 'none'; // Prevent interaction during upload
         uploadBox.style.opacity = '0.7';


        // --- Cloudinary Widget ---
        const widget = cloudinary.openUploadWidget({
            cloudName, uploadPreset, sources: ['local'],
            resourceType: 'video', multiple: false, // Keep multiple false for simpler post-upload logic for now
            clientAllowedFormats: ['mp4', 'webm', 'mov', 'avi', 'mkv', 'wmv'],
            maxFileSize: 500000000, // 500MB
            folder: 'gs_overlay',
            // Potentially add context later if storing publisher name server-side:
            // context: publisherName ? { publisher: publisherName } : {},
        }, (error, result) => {
             if (error) {
                console.error("Upload Widget Error:", error);
                status.innerText = `❌ Upload failed: ${error.message || 'Unknown error'}`;
                 status.style.color = '#ff4444';
                progressBar.style.width = '0%';
                // Re-enable popup on error
                uploadBox.style.pointerEvents = 'auto';
                uploadBox.style.opacity = '1';

            } else if (result && result.event === "success") {
                console.log("Upload Success:", result.info);
                const publicId = result.info.public_id;
                const originalFilename = result.info.original_filename;

                // 1. Store Password (Critical)
                localStorage.setItem(`pass_${publicId}`, delPass);

                // 2. Store Publisher Name (if provided)
                if (publisherName) {
                    publisherNames[publicId] = publisherName;
                    localStorage.setItem('publisherNames', JSON.stringify(publisherNames));
                } else {
                    // Ensure no old publisher name persists if user clears the field
                    if (publisherNames.hasOwnProperty(publicId)) {
                         delete publisherNames[publicId];
                         localStorage.setItem('publisherNames', JSON.stringify(publisherNames));
                    }
                }

                // 3. Handle Optional Initial Rename
                if (optionalRename) {
                    renamedTitles[publicId] = optionalRename;
                    localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));
                    // No need for immediate rename prompt if they already gave a title
                    hideUploadPopup(); // Close upload popup
                    showUploadSuccessPopup(publicId); // Show success message directly
                } else {
                    // 4. Prompt for Rename *if no initial title was given*
                     hideUploadPopup(); // Close upload popup first
                     promptForRenameAfterUpload(publicId, originalFilename);
                }


                 // Re-enable popup potentially if widget allows multi-file later
                // For now, assume single file success closes/moves on
                uploadBox.style.pointerEvents = 'auto';
                uploadBox.style.opacity = '1';


            } else if (result && result.event === "uploadprogress") {
                const percent = Math.round(result.info.bytes_uploaded / result.info.total_bytes * 100);
                progressBar.style.width = `${percent}%`;
                status.innerText = `Uploading... ${percent}%`;
                 status.style.color = ''; // Ensure normal text color
            } else if (result && result.event === "close") {
                // Handle case where user closes widget without successful upload
                 if (!document.getElementById('uploadSuccessPopup').style.display || document.getElementById('uploadSuccessPopup').style.display === 'none') {
                     if (status.innerText.startsWith('Initializing') || status.innerText.startsWith('Uploading')) {
                        status.innerText = 'Upload cancelled.';
                        status.style.color = '#ffcc00'; // Warning color
                     }
                 }
                 // Re-enable popup if closed prematurely
                uploadBox.style.pointerEvents = 'auto';
                uploadBox.style.opacity = '1';
            }
        });
    }

     // New function to handle the post-upload rename decision
    function promptForRenameAfterUpload(publicId, originalFilename) {
        const defaultTitle = formatTitle(publicId); // Use formatted public_id as suggestion
        showConfirmationModal({
            title: "Rename Upload?",
            message: `Upload complete! Do you want to set a custom title for this video (currently "${defaultTitle}")?`,
            confirmText: "Yes, Rename",
            cancelText: "No, Keep Title",
            onConfirm: () => {
                // User wants to rename, trigger the rename prompt
                // Pass a callback to show success popup *after* renaming is done/cancelled
                proceedWithRename(publicId, () => showUploadSuccessPopup(publicId));
            },
            onCancel: () => {
                // User doesn't want to rename now, show success popup directly
                showUploadSuccessPopup(publicId);
            }
        });
    }


    // --- Filtering Logic ---
    function setActiveFilter(buttonElement, filterType) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter'));
        buttonElement.classList.add('active-filter');
        currentFilter = filterType;
        // Re-apply theme specific styles potentially affected by class change
        const isLight = document.documentElement.getAttribute('data-theme') === 'light';
        if (isLight) {
            buttonElement.style.borderColor = '#f4f4f4'; // Light theme border
            buttonElement.style.boxShadow = '0 0 8px #10b981';
        } else {
             buttonElement.style.borderColor = '#0e0e0e'; // Dark theme border
             buttonElement.style.boxShadow = '0 0 8px #00ff88';
        }

        switch (filterType) {
            case 'recent': loadVideos(true); break; // Already sorts by recent by default
            case 'popular': filterPopular(); break;
            case 'relevant': filterRelevant(); break;
        }
    }

    function filterPopular() {
        // Placeholder: Add actual popularity logic later (e.g., based on download count if tracked)
        // For now, just sort randomly or by size as a demo
        allVideos.sort((a, b) => b.bytes - a.bytes); // Sort by size descending as proxy
        renderVideos(allVideos);
         // Re-apply search after re-rendering
        searchVideos();
    }

    function filterRelevant() {
         const searchQuery = document.getElementById("search").value.trim();
        if (!searchQuery) {
            alert("Please enter a search term to filter by relevance.");
            // Optionally revert to 'recent' filter
            const recentButton = document.getElementById('filter-recent');
             if (recentButton && !recentButton.classList.contains('active-filter')) {
                  setActiveFilter(recentButton, 'recent');
             }
            return;
        }
         // Basic relevance: just apply the search filter (which is already done by searchVideos)
         // More advanced relevance might involve scoring based on where the query matches (title vs description etc.)
         console.log("Applying search as 'Relevance' filter.");
         // No need to re-render if searchVideos is called, it filters display
         // If you wanted to *reorder* based on relevance score, you'd do that here.
         searchVideos();
    }

    // --- Video Loading & Rendering ---
    async function loadVideos(reset = false) {
        if (reset) {
            allVideos = []; // Clear the main array
            document.getElementById("gallery").innerHTML = '<p class="text-center w-full col-span-full">🔄 Loading videos...</p>';
        }
        try {
            // Use '/videos' endpoint assumed from previous context
            const res = await fetch(`/videos`); // Ensure this endpoint exists and returns JSON array
             if (!res.ok) {
                 let errorMsg = `Failed to load videos: ${res.status} ${res.statusText}`;
                 try {
                     const errorData = await res.json();
                     errorMsg = errorData.details || errorData.error || errorMsg;
                 } catch (e) { /* Ignore parsing error */ }
                 throw new Error(errorMsg);
             }
            const data = await res.json();

            if (!Array.isArray(data)) {
                console.error("Invalid response from server, expected an array:", data);
                 document.getElementById("gallery").innerHTML = '<p class="text-center w-full col-span-full">😕 Error: Invalid data received from server.</p>';
                return;
            }

            if (data.length === 0) {
                 document.getElementById("gallery").innerHTML = '<p class="text-center w-full col-span-full">📪 No videos found in the vault yet. Try uploading one!</p>';
                 allVideos = []; // Ensure array is empty
                 return;
            }

            // Default sort by date descending ('recent')
            allVideos = data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            renderVideos(allVideos);

        } catch (error) {
            console.error("Error loading videos:", error);
            document.getElementById("gallery").innerHTML = `<p class="text-center w-full col-span-full text-red-500">❌ Error loading videos: ${error.message}</p>`;
        }
    }

    function renderVideos(videosToRender) {
        const gallery = document.getElementById("gallery");
        gallery.innerHTML = ''; // Clear previous content

        if (!videosToRender || videosToRender.length === 0) {
             // Check if a search query is active to show appropriate message
             const searchQuery = document.getElementById("search").value.trim();
             if (searchQuery) {
                gallery.innerHTML = `<p class="text-center w-full col-span-full no-results-message">😕 No videos found matching "${searchQuery}".</p>`;
             } else if (allVideos.length > 0) {
                 // This case shouldn't happen if allVideos is populated but videosToRender is empty without search
                 // but handles edge cases / filter issues
                 gallery.innerHTML = '<p class="text-center w-full col-span-full">📪 No videos match the current filter.</p>';
             } else {
                 // This means allVideos was initially empty
                 gallery.innerHTML = '<p class="text-center w-full col-span-full">📪 No videos found in the vault yet. Try uploading one!</p>';
             }
             return;
        }


        videosToRender.forEach(file => {
            if (!file || !file.public_id) {
                console.warn("Skipping invalid video data:", file);
                return; // Skip if data is malformed
            }
            const publicId = file.public_id;
            const safeId = publicId.replace(/[/.]/g, '_'); // ID safe for CSS selectors
            const title = renamedTitles[publicId] || formatTitle(publicId); // Use rename or format original
            const publisher = publisherNames[publicId]; // Get publisher name
            // Use Cloudinary transformations for video and thumbnail
            const videoUrl = `https://res.cloudinary.com/${cloudName}/video/upload/q_auto:eco/v1/${publicId}.mp4`;
            // Generate thumbnail from video (e.g., at 1 second mark)
            const thumbnailUrl = `https://res.cloudinary.com/${cloudName}/video/upload/w_300,h_200,c_fill,q_auto,so_1/v1/${publicId}.jpg`;

            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.publicId = publicId; // Store public_id on the card for easier access

            card.innerHTML = `
                <div class="video-container" onclick="togglePlay(this)">
                    <video muted playsinline loop preload="metadata" poster="${thumbnailUrl}" title="Click to play/pause: ${title}">
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="card-content"> <!-- Wrapper for title & publisher -->
                    <div class="title truncate" data-id="${publicId}" title="${title}">${title}</div>
                    ${publisher ? `<div class="publisher-name" data-publisher-id="${publicId}">by ${publisher}</div>` : ''}
                </div>
                <div class="card-footer"> <!-- Footer for download/menu -->
                    <a href="${videoUrl}" download="${title.replace(/[^a-z0-9_.-]/gi, '_')}.mp4" class="download-btn text-sm flex-grow mr-2">Download</a>
                    <button class="menu-btn" onclick="toggleActionMenu(event, '${publicId}')" title="Video Actions">...</button>
                </div>
                <!-- Action Popup Menu (Initially Hidden) -->
                <div class="action-popup" id="actionPopup_${safeId}">
                    <button onclick="triggerRename('${publicId}')">Rename</button>
                    <button class="delete-action" onclick="triggerDelete('${publicId}')">Delete</button>
                </div>
            `;
            gallery.appendChild(card);
        });

        // Re-apply search filter after rendering new batch of videos
        searchVideos();
    }

    // Helper to format title from public_id
    function formatTitle(publicId) {
        // Assumes public_id might be like 'folder/subfolder/filename_xyz'
        let name = publicId.split('/').pop(); // Get the last part
        name = name.replace(/_/g, ' '); // Replace underscores with spaces
        // Capitalize first letter of each word
        return name.split(' ')
                   .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                   .join(' ');
    }

    // --- Video Card Actions ---

    function togglePlay(container) {
        const video = container.querySelector('video');
        if (video) {
            if (video.paused) {
                video.play().catch(e => console.warn("Play interrupted:", e)); // Handle play promise rejection
            } else {
                video.pause();
            }
        }
    }

    function toggleActionMenu(event, publicId) {
        event.stopPropagation(); // Prevent card click, etc.
        const safeId = publicId.replace(/[/.]/g, '_');
        const popup = document.getElementById(`actionPopup_${safeId}`);

        // Close all other popups first
        document.querySelectorAll('.action-popup').forEach(p => {
            if (p.id !== `actionPopup_${safeId}`) {
                p.style.display = 'none';
            }
        });

        // Toggle the target popup
        if (popup) {
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        }
    }

    // Close action menus if clicking elsewhere on the document
    document.addEventListener('click', function(event) {
        // Close Action Popups
        const openPopup = document.querySelector('.action-popup[style*="display: block"]');
        if (openPopup && !openPopup.contains(event.target) && !event.target.classList.contains('menu-btn')) {
            openPopup.style.display = 'none';
        }
        // Add similar logic for other popups if needed, though modals usually cover this
    });


    // --- Password Protected Actions ---

    function getPasswordAndExecute(publicId, actionCallback) {
        const storedPass = localStorage.getItem(`pass_${publicId}`);
        if (!storedPass) {
            // More informative alert
             showConfirmationModal({
                 title: "Action Failed",
                 message: "Cannot perform this action because no deletion password was found in your browser's storage for this video. Passwords are set during upload and stored locally.",
                 confirmText: "OK",
                 onConfirm: () => {}, // Just close the modal
                 cancelText: "" // Hide cancel button
             });
            return;
        }

        showPromptModal({
            title: "Password Required",
            label: "Enter the password set during upload:",
            inputType: 'password',
            confirmText: 'Verify',
            callback: (enteredPassword) => {
                if (enteredPassword === storedPass) {
                    hidePromptModal();
                    actionCallback(); // Execute the protected action
                } else {
                    showPromptError('Incorrect password. Please try again.');
                    // Keep the modal open for another try
                }
            }
        });
    }

    function triggerRename(publicId) {
        const safeId = publicId.replace(/[/.]/g, '_');
        const popup = document.getElementById(`actionPopup_${safeId}`);
        if (popup) popup.style.display = 'none'; // Close menu

        getPasswordAndExecute(publicId, () => {
            proceedWithRename(publicId); // Proceed only if password is correct
        });
    }

    // Added optional 'onComplete' callback
    function proceedWithRename(publicId, onComplete) {
        const currentTitle = renamedTitles[publicId] || formatTitle(publicId);

        showPromptModal({
            title: "Rename Video",
            label: `Enter new title:`,
            inputType: 'text',
            initialValue: currentTitle, // Use helper function to pass current title
            confirmText: 'Save Name',
            callback: (newTitle) => {
                const finalTitle = newTitle.trim();
                if (finalTitle && finalTitle !== currentTitle) {
                    renamedTitles[publicId] = finalTitle;
                    localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));

                    // Update DOM immediately
                    const card = document.querySelector(`.card[data-public-id="${publicId}"]`);
                    if (card) {
                        const titleElement = card.querySelector('.title');
                        const downloadLink = card.querySelector('.download-btn');
                        if (titleElement) {
                            titleElement.textContent = finalTitle;
                            titleElement.setAttribute('title', finalTitle);
                        }
                         if (downloadLink) {
                            downloadLink.download = `${finalTitle.replace(/[^a-z0-9_.-]/gi, '_')}.mp4`;
                        }
                    }
                    hidePromptModal();
                    if (onComplete) onComplete(); // Call the callback if provided

                } else if (!finalTitle) {
                    showPromptError("Title cannot be empty.");
                } else { // Title is same as current
                     hidePromptModal(); // Just close if name hasn't changed
                     if (onComplete) onComplete(); // Still call callback
                }
            }
        });
    }


    function triggerDelete(publicId) {
        const safeId = publicId.replace(/[/.]/g, '_');
        const popup = document.getElementById(`actionPopup_${safeId}`);
        if (popup) popup.style.display = 'none'; // Close menu

        getPasswordAndExecute(publicId, () => {
            proceedWithDelete(publicId); // Proceed only if password is correct
        });
    }

    function proceedWithDelete(publicId) {
        const title = renamedTitles[publicId] || formatTitle(publicId);

        // Use the confirmation modal for a nicer final check
        showConfirmationModal({
            title: "Confirm Deletion",
            message: `Are you sure you want to permanently delete "<strong>${title}</strong>"?<br><br>This action cannot be undone.`,
            confirmText: "Yes, Delete",
            cancelText: "Cancel",
            onConfirm: () => {
                // Confirmed deletion - proceed with fetch call
                const cardToDelete = document.querySelector(`.card[data-public-id="${publicId}"]`);
                if (cardToDelete) {
                     cardToDelete.style.opacity = '0.5';
                     cardToDelete.style.transition = 'opacity 0.5s ease';
                     // Disable interaction?
                     cardToDelete.style.pointerEvents = 'none';
                }

                // Assume '/delete/:publicId' endpoint exists on the backend
                fetch(`/delete/${encodeURIComponent(publicId)}`, { method: "DELETE" })
                    .then(async response => { // Use async for easier error parsing
                        if (!response.ok) {
                             let errorMsg = `Server error: ${response.status}`;
                            try {
                                const err = await response.json();
                                errorMsg = err.message || `Server error: ${response.status}`;
                            } catch(e) { /* Ignore json parse error */ }
                            throw new Error(errorMsg);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("Delete response:", data);
                        if (data.status === "success" || data.result === 'ok') { // Cloudinary API might return 'ok'
                            if (cardToDelete) {
                                cardToDelete.style.opacity = '0'; // Fade out before removing
                                setTimeout(() => cardToDelete.remove(), 500); // Remove after fade
                            }
                            // Clean up local storage
                            localStorage.removeItem(`pass_${publicId}`);
                            delete renamedTitles[publicId];
                            delete publisherNames[publicId]; // Also remove publisher name
                            localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));
                            localStorage.setItem('publisherNames', JSON.stringify(publisherNames)); // Save updated publishers

                            console.log(`Removed card and local storage for ${publicId}`);
                             // Show simple success confirmation
                              showConfirmationModal({
                                 title: "Deleted",
                                 message: data.message || `"${title}" deleted successfully.`,
                                 confirmText: "OK",
                                 cancelText: "",
                                 onConfirm: () => {
                                      // Check if gallery is now empty
                                      if (document.querySelectorAll('.card').length === 0) {
                                          loadVideos(true); // Refresh to show empty message
                                      }
                                 }
                             });


                        } else {
                            throw new Error(data.message || "Deletion failed on server.");
                        }
                    })
                    .catch(err => {
                         showConfirmationModal({
                             title: "Deletion Failed",
                             message: `Could not delete video: ${err.message}`,
                             confirmText: "OK",
                             cancelText: ""
                         });
                        console.error("Deletion error:", err);
                         if (cardToDelete) {
                             cardToDelete.style.opacity = '1'; // Restore card on failure
                             cardToDelete.style.pointerEvents = 'auto';
                         }
                    });
            },
            onCancel: () => {
                console.log("Deletion cancelled by user.");
            }
        });
    }


    // --- Search ---
    function searchVideos() {
        const query = document.getElementById("search").value.toLowerCase().trim();
        const cards = document.querySelectorAll('.card');
        const gallery = document.getElementById("gallery");
        let visibleCount = 0;
        let noResultsMsg = gallery.querySelector('.no-results-message');

        cards.forEach(card => {
            const titleElement = card.querySelector('.title');
            const publisherElement = card.querySelector('.publisher-name');
            let isMatch = false;
            if (titleElement) {
                const title = titleElement.textContent.toLowerCase();
                if (title.includes(query)) {
                    isMatch = true;
                }
            }
            // Also search publisher name if present and query is not empty
            if (!isMatch && query && publisherElement) {
                 const publisher = publisherElement.textContent.toLowerCase().replace('by ', ''); // remove 'by ' prefix
                 if (publisher.includes(query)) {
                     isMatch = true;
                 }
            }

            card.style.display = isMatch ? '' : 'none';
            if (isMatch) visibleCount++;
        });

        // Handle "No Results" message
        if (visibleCount === 0 && query !== '' && allVideos.length > 0) {
           if (!noResultsMsg) {
               noResultsMsg = document.createElement('p');
               noResultsMsg.className = 'text-center w-full col-span-full no-results-message';
               gallery.insertBefore(noResultsMsg, gallery.firstChild); // Add message to the top
           }
           noResultsMsg.textContent = `😕 No videos found matching "${query}".`;
           noResultsMsg.style.display = 'block'; // Ensure it's visible
        } else if (noResultsMsg) {
            noResultsMsg.style.display = 'none'; // Hide if there are results or no query
        } else if (visibleCount === 0 && query === '' && allVideos.length === 0) {
             // Handles the initial empty state correctly (redundant with renderVideos check, but safe)
             if (!noResultsMsg) {
                gallery.innerHTML = '<p class="text-center w-full col-span-full">📪 No videos found in the vault yet. Try uploading one!</p>';
            }
        }
    }


    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        checkTerms(); // Show T&C if needed on first load

        const initialFilterButton = document.getElementById('filter-recent');
        if (initialFilterButton) {
             setActiveFilter(initialFilterButton, 'recent'); // This calls loadVideos
        } else {
            loadVideos(true); // Fallback if filter button isn't found
        }

        // Set initial theme based on preference or default to dark
         if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches && !document.documentElement.getAttribute('data-theme')) {
            // Optional: uncomment to default to light theme based on OS preference
            // toggleTheme();
         }
    });

  </script>

</body>
</html>
