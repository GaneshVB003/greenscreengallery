

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Green Screen Overlay Vault</title>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* --- KEEP ALL PREVIOUS CSS STYLES --- */
        /* Base & Theme Styles */
        body { font-family: 'Roboto', sans-serif; transition: background 0.3s, color 0.3s; line-height: 1.6; }
        html[data-theme="dark"] body { background: #0a0a0a; color: #e5e7eb; } /* Lighter text */
        html[data-theme="light"] body { background: #f8f9fa; color: #212529; }

        /* Header */
        .header { /* ... keep styles ... */ }
        .header h1 { /* ... keep styles ... */ }
        .header-buttons { /* ... keep styles ... */ z-index: 20; /* Ensure above basic content */ }
        .header-btn { /* ... keep styles ... */ }

        /* Gallery & Cards */
        .gallery { /* ... keep styles ... */ }
        .card { /* ... keep styles ... */ }
        .video-container { /* ... keep styles ... */ }
        .video-container::after { /* ... keep styles ... */ }
        .card-content { /* ... keep styles ... */ }
        .card-title { /* ... keep styles ... */ }
        .uploader-name { /* ... keep styles ... */ }
        .card-footer { /* ... keep styles ... */ }
        .download-btn { /* ... keep styles ... */ }
        .menu-btn { /* ... keep styles ... */ }

        /* Action Popup Styles */
        .action-popup { /* ... keep styles ... */ z-index: 30; /* Above cards */}

        /* Modal Styles */
        .modal-backdrop { /* ... keep styles ... */ z-index: 50; /* Highest */ }
        .modal-box { /* ... keep styles ... */ }
        .modal-box h2 { /* ... keep styles ... */ }
        .modal-box label { /* ... keep styles ... */ }
        .modal-box input[type="text"], .modal-box input[type="password"], .modal-box textarea { /* ... keep styles ... */ }
        .modal-buttons { /* ... keep styles ... */ }
        .modal-error { /* ... keep styles ... */ }
        .modal-close-btn { /* ... keep styles ... */ z-index: 51; /* Above modal content */}

        /* Terms Modal Specific Styles */
        #termsModal .modal-box { /* ... keep styles ... */ }
        .terms-content { /* ... keep styles ... */ }

        /* Filters & Search */
        .filter-search-area { /* ... keep styles ... */ position: sticky; top: 0; z-index: 10; /* Keep below header/modals */}
        .filter-options { /* ... keep styles ... */ }
        .filter-btn { /* ... keep styles ... */ }
        .search-container { /* ... keep styles ... */ }
        .search-container input { /* ... keep styles ... */ }

        /* Intro Screen */
        #introScreen { /* ... keep styles ... */ z-index: 100; /* Highest initially */}
        #introScreen.fade-out { opacity: 0; pointer-events: none; z-index: -1; /* Send to back after fade */}
        #introText { /* ... keep styles ... */ }

        /* Load More Button */
        #loadMoreBtn { /* ... keep styles ... */ }

        /* How-to Section & Info */
        .info-section { /* ... keep styles ... */ }
        .video-wrapper { /* ... keep styles ... */ }
        .tooltip { /* ... keep styles ... */ }
        .tooltip .tooltiptext { /* ... keep styles ... */ z-index: 60; /* Above most things */}

        /* Footer */
        .site-footer { /* ... keep styles ... */ }

        /* Animations */
        @keyframes glow { /* ... keep ... */ }
        @keyframes fadeInUp { /* ... keep ... */ }
        @keyframes fadeInDown { /* ... keep ... */ }
        @keyframes fadeIn { /* ... keep ... */ }
        @keyframes scaleUp { /* ... keep ... */ }
        @keyframes popUpFadeIn { /* ... keep ... */ }
        @keyframes textPopInGlow { /* ... keep ... */ }

        /* Utility for screen readers */
        .sr-only { /* ... keep ... */ }

         /* Ensure buttons are clickable */
        button, a[onclick], [role="button"] { cursor: pointer; }

    </style>
</head>
<body>

    <!-- Intro Screen -->
    <div id="introScreen">
        <span id="introText">Green Screen Vault</span>
    </div>

    <!-- Header -->
    <header class="header">
        <h1>🎬 Green Screen Vault</h1>
        <div class="header-buttons left">
            <button type="button" onclick="toggleTheme()" class="header-btn" title="Toggle Theme">
                <i class="fas fa-adjust"></i> <span class="sr-only sm:not-sr-only">Theme</span>
            </button>
        </div>
        <div class="header-buttons right">
            <!-- Ensure type="button" to prevent potential form submission issues if ever wrapped in a form -->
            <button type="button" onclick="showUploadPopup()" class="header-btn" title="Upload Video">
                 <i class="fas fa-upload"></i> <span class="sr-only sm:not-sr-only">Upload</span>
            </button>
        </div>
    </header>

    <!-- Filter and Search Area -->
    <div class="filter-search-area">
        <!-- Filter Buttons -->
        <div class="filter-options">
             <button type="button" class="filter-btn" id="filter-recent" onclick="setActiveFilter(this, 'recent')">Most Recent</button>
             <button type="button" class="filter-btn" id="filter-popular" onclick="setActiveFilter(this, 'popular')">Popular</button>
             <!-- <button class="filter-btn" id="filter-relevant" onclick="setActiveFilter(this, 'relevant')">Relevant</button> -->
        </div>
        <!-- Search Input -->
        <div class="search-container">
            <label for="search" class="sr-only">Search Videos:</label>
            <input type="search" id="search" placeholder="Search by title or uploader...">
            <!-- Removed oninput here, will attach listener in JS -->
        </div>
    </div>

    <!-- Main Content Area -->
    <main>
        <!-- Gallery -->
        <div class="gallery" id="gallery">
            <!-- Loading message added dynamically -->
        </div>

        <!-- Load More Button -->
        <button type="button" id="loadMoreBtn" onclick="loadMoreVideos()" style="display: none;">Load More Videos</button>

        <!-- Info / How-to Section -->
        <section class="info-section landing-page">
            <!-- Keep existing info content -->
            <h2>Unlock Your Creativity</h2>
            <p>...</p>
            <div class="video-wrapper">...</div>
            <h3>Quick Guide: Using Overlays (Premiere Pro)</h3>
            <ol>...</ol>
            <h3><i class="fas fa-lightbulb"></i> Pro Tips & Benefits</h3>
            <p>...</p>
            <div class="mt-6">...</div>
        </section>
    </main>

    <!-- Modals -->

    <!-- Initial Upload Popup -->
    <div class="modal-backdrop" id="uploadPopup"> <!-- Removed p-4, handled by modal-box -->
        <div class="modal-box w-full max-w-md">
            <button type="button" class="modal-close-btn" onclick="hideUploadPopup()">×</button>
            <h2 class="text-xl font-bold mb-4">Upload Overlay</h2>
            <p class="text-sm text-gray-400 mb-4">Help the community grow!</p>
            <div>
                <label for="uploaderNameInput">Your Name/Alias (Optional):</label>
                <input type="text" id="uploaderNameInput" placeholder="Shown publicly with your video" class="mb-4">
            </div>
            <div>
                <label for="deletePassword">Deletion Password (Required):</label>
                <input type="password" id="deletePassword" placeholder="Save this password securely!" class="mb-4">
            </div>
            <button type="button" onclick="openCloudinaryUpload()" class="modal-button-confirm w-full justify-center text-base py-3">
                <i class="fas fa-cloud-upload-alt mr-2"></i> Select & Upload Video
            </button>
            <div class="progress-container mt-4" id="progressContainer" style="display: none;"><div class="progress-bar" id="progressBar"></div></div>
            <p id="uploadStatus" class="mt-2 text-sm h-5 text-center"></p>
            <button type="button" onclick="hideUploadPopup()" class="modal-button-cancel w-full justify-center mt-2">Cancel</button>
        </div>
    </div>

    <!-- Post-Upload Details Modal -->
    <div class="modal-backdrop" id="postUploadDetailsModal">
        <div class="modal-box">
            <button type="button" class="modal-close-btn" onclick="closePostUploadModal(true)">×</button>
            <h2>Finalize Upload Details</h2>
            <p class="text-sm mb-4">Your video is uploaded! Please provide a title.</p>
            <div>
                <label for="postUploadTitleInput">Video Title (Required):</label>
                <input type="text" id="postUploadTitleInput" name="postUploadTitleInput">
                <p class="text-xs mt-1 text-gray-400">Uploader: <span id="postUploadUploaderName"></span></p>
                <p class="modal-error" id="postUploadError"></p>
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-button-cancel" onclick="closePostUploadModal(true)">Skip Title</button>
                <button type="button" class="modal-button-confirm" id="postUploadSaveBtn" onclick="savePostUploadDetails()">Save Details</button>
            </div>
        </div>
    </div>

    <!-- Generic Prompt/Confirmation Modal -->
    <div class="modal-backdrop" id="promptModal">
        <div class="modal-box">
            <button type="button" class="modal-close-btn" onclick="hidePromptModal()">×</button>
            <h2 id="promptTitle">Prompt</h2>
            <div id="promptContent">
                <!-- Content dynamically set -->
                <p class="modal-error" id="promptError"></p>
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-button-cancel" id="promptCancelBtn" onclick="hidePromptModal()">Cancel</button>
                <button type="button" class="modal-button-confirm" id="promptConfirmBtn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Upload Success Modal -->
    <div class="modal-backdrop" id="uploadSuccessPopup">
        <div class="modal-box text-center">
            <button type="button" class="modal-close-btn" onclick="closeSuccessPopupAndRefresh()">×</button>
            <h2 class="text-2xl"><i class="fas fa-rocket text-blue-400 mr-2"></i>Upload Complete!</h2>
            <div id="uploadSuccessContent" class="my-4">
                <p>Thank you, <strong id="successUploaderName" class="text-green-400"></strong>!</p>
                <p>Your overlay "<strong id="successVideoTitle" class="text-yellow-400"></strong>" is now live.</p>
                <p class="mt-2 text-sm text-gray-400">Sharing helps the creative community grow!</p>
            </div>
            <div class="modal-buttons justify-center">
                <button type="button" class="modal-button-confirm" onclick="closeSuccessPopupAndRefresh()">Awesome!</button>
            </div>
        </div>
    </div>

    <!-- Terms and Conditions Modal -->
    <div class="modal-backdrop" id="termsModal">
        <div class="modal-box">
             <button type="button" class="modal-close-btn" onclick="closeTermsModal()">×</button>
              <h2>Terms & Privacy</h2>
              <div class="terms-content" style="max-height: 60vh;">
                  <!-- Full T&C Text Here -->
                   <h3>Terms and Conditions</h3>
                   <p><em>Last updated: April 26, 2024</em></p>
                   <p>Welcome...</p>
                   <hr class="my-4 border-gray-600">
                   <h3>Privacy Policy</h3>
                   <p><em>Effective Date: April 26, 2024</em></p>
                   <p>We value...</p>
              </div>
              <label class="terms-accept-label mt-4" id="termsAcceptWrapper" style="display: none;">
                  <input type="checkbox" id="termsAcceptCheckbox" class="mr-2">
                  <span>I have read and agree to the Terms and Conditions and Privacy Policy.</span>
              </label>
              <p class="modal-error" id="termsError"></p>
              <div class="modal-buttons">
                  <button type="button" class="modal-button-confirm" id="termsAcceptBtn" onclick="acceptTerms()" style="display: none;">Agree & Continue</button>
                  <button type="button" class="modal-button-cancel" id="termsCloseBtn" onclick="closeTermsModal()">Close</button>
              </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
       <p>© <span id="currentYear"></span> Green Screen Vault. Community driven.</p>
       <p><span class="footer-link" onclick="showTermsModal(true)">View Terms & Privacy Policy</span></p>
    </footer>


    <script>
        // --- Global Constants & State ---
        const cloudName = 'dogxcu1sj';
        const uploadPreset = 'gs_overlay'; // ENSURE THIS PRESET EXISTS AND WORKS
        let allVideos = [];
        let displayedVideos = [];
        const videosPerLoad = 12;
        let currentVideoIndex = 0;
        let renamedTitles = {};
        let uploaderNames = {};
        let currentFilter = 'recent';
        let currentSearchQuery = '';
        let postUploadData = null; // Holds data between upload success and modal save
        let searchTimeout; // For debouncing search input

        // --- Utility Functions ---
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function safeGetElementById(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.error(`Element with ID '${id}' not found!`);
            }
            return el;
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
           console.log("DOM Content Loaded. Starting initialization.");
           try {
               loadLocalData(); // Load titles/names from localStorage
               handleIntro(); // Start intro animation
               // Terms check and main page init will happen after intro fades out
               setupEventListeners(); // Attach listeners not using inline onclick
           } catch (error) {
                console.error("Error during DOMContentLoaded initialization:", error);
                // Display a user-friendly error message?
                const gallery = safeGetElementById('gallery');
                if (gallery) gallery.innerHTML = '<p class="text-red-500 p-4">An error occurred while loading the page. Please try refreshing.</p>';
           }
        });

        function loadLocalData() {
             try {
                renamedTitles = JSON.parse(localStorage.getItem('renamedTitles') || '{}');
                uploaderNames = JSON.parse(localStorage.getItem('uploaderNames') || '{}');
                console.log("Loaded local data:", { titles: Object.keys(renamedTitles).length, uploaders: Object.keys(uploaderNames).length });
            } catch (e) {
                console.error("Error parsing local storage data:", e);
                renamedTitles = {};
                uploaderNames = {};
                // Optionally clear potentially corrupted data
                // localStorage.removeItem('renamedTitles');
                // localStorage.removeItem('uploaderNames');
            }
        }

        function setupEventListeners() {
             console.log("Setting up event listeners...");
             const searchInput = safeGetElementById('search');
             if (searchInput) {
                 // Added debounced listener for search
                 searchInput.addEventListener('input', debounce(() => {
                     const query = searchInput.value.toLowerCase().trim();
                     console.log(`Debounced search triggered: "${query}"`);
                     if (query !== currentSearchQuery) {
                         currentSearchQuery = query;
                         loadVideos(true); // Reset and load with new query
                     }
                 }, 400));
             } else {
                 console.warn("Search input element not found during setup.");
             }
             console.log("Event listeners setup complete.");
        }

        // --- Intro Screen Logic ---
        function handleIntro() {
            console.log("Handling Intro Sequence...");
            const introScreen = safeGetElementById('introScreen');
            if (!introScreen || introScreen.classList.contains('fade-out')) {
                 console.log("Intro screen not found or already fading, checking terms.");
                 checkTerms();
                 return;
            }

            setTimeout(() => {
                console.log("Fading out intro screen.");
                introScreen.classList.add('fade-out');
                introScreen.addEventListener('transitionend', () => {
                    console.log("Intro fade out complete.");
                    // No need to remove, z-index and pointer-events handle it
                    checkTerms(); // Check terms AFTER intro fades out
                }, { once: true });
            }, 2500); // Duration for animation + buffer
        }

        // --- Terms and Conditions Logic ---
        function checkTerms() {
            console.log("Checking terms acceptance status.");
            const accepted = localStorage.getItem('termsAccepted');
            if (accepted !== 'true') {
                console.log("Terms not accepted. Showing modal.");
                showTermsModal(false); // Show for acceptance
            } else {
                console.log("Terms previously accepted. Initializing main page.");
                initializePage();
            }
        }

        function showTermsModal(isViewingOnly = false) {
            console.log(`Showing terms modal. View only: ${isViewingOnly}`);
            const modal = safeGetElementById('termsModal');
            const acceptWrapper = safeGetElementById('termsAcceptWrapper');
            const acceptBtn = safeGetElementById('termsAcceptBtn');
            const closeBtn = safeGetElementById('termsCloseBtn');
            const errorMsg = safeGetElementById('termsError');

            if (!modal || !acceptWrapper || !acceptBtn || !closeBtn || !errorMsg) return; // Exit if elements missing

            errorMsg.textContent = '';
            const checkbox = safeGetElementById('termsAcceptCheckbox');
            if (checkbox) checkbox.checked = false;

            if (isViewingOnly) {
                acceptWrapper.style.display = 'none';
                acceptBtn.style.display = 'none';
                closeBtn.style.display = 'inline-flex'; // Match button display type
            } else {
                acceptWrapper.style.display = 'flex';
                acceptBtn.style.display = 'inline-flex';
                closeBtn.style.display = 'none';
            }
            modal.style.display = 'flex';
        }

        function acceptTerms() {
            console.log("Attempting to accept terms...");
            const checkbox = safeGetElementById('termsAcceptCheckbox');
            const errorMsg = safeGetElementById('termsError');
            if (!checkbox || !errorMsg) return;

            if (checkbox.checked) {
                console.log("Terms checkbox checked. Saving acceptance.");
                localStorage.setItem('termsAccepted', 'true');
                closeTermsModal();
                initializePage(); // Load content
            } else {
                 console.log("Terms checkbox not checked.");
                errorMsg.textContent = 'You must accept the terms to continue.';
            }
        }

        function closeTermsModal() {
            console.log("Closing terms modal.");
            const modal = safeGetElementById('termsModal');
            if(modal) modal.style.display = 'none';
        }

        // --- Page Initialization (After Terms) ---
        function initializePage() {
            console.log("Initializing main page content...");
            const initialFilterButton = safeGetElementById('filter-recent');
            if (initialFilterButton && !initialFilterButton.classList.contains('active-filter')) {
                 setActiveFilter(initialFilterButton, 'recent', true); // Prevent double load
            }
            loadVideos(true); // Initial load
            updateFooterYear();
            console.log("Main page initialized.");
        }

        function updateFooterYear() {
            const yearSpan = safeGetElementById('currentYear');
            if (yearSpan) yearSpan.textContent = new Date().getFullYear();
        }


        // --- Modal Helper Functions ---
        let currentPromptCallback = null;
        let currentCancelCallback = null; // Keep this if needed for specific cancel actions

        function showPromptModal({ title, label, inputType = 'text', placeholder = '', confirmText = 'Confirm', cancelText = 'Cancel', callback, initialValue = '', isConfirmation = false, confirmationContent = '', confirmClass = '' }) {
             console.log(`Showing prompt modal: "${title}"`);
             const modal = safeGetElementById('promptModal');
             const titleEl = safeGetElementById('promptTitle');
             const contentDiv = safeGetElementById('promptContent');
             const confirmBtn = safeGetElementById('promptConfirmBtn');
             const cancelBtn = safeGetElementById('promptCancelBtn');

             if (!modal || !titleEl || !contentDiv || !confirmBtn || !cancelBtn) return; // Exit if elements missing

             const errorEl = safeGetElementById('promptError'); // Get or create error element dynamically if needed

             // Reset state
             titleEl.innerText = title;
             contentDiv.innerHTML = ''; // Clear previous dynamic content
             if (errorEl) {
                 errorEl.innerText = '';
                 contentDiv.appendChild(errorEl); // Ensure error placeholder is inside
             } else {
                 console.warn("Prompt error element not found/created.");
             }
             confirmBtn.className = 'modal-button-confirm'; // Reset class
             if (confirmClass) confirmBtn.classList.add(...confirmClass.split(' ')); // Allow multiple classes

             if (isConfirmation) {
                 const confirmTextElement = document.createElement('p');
                 confirmTextElement.innerHTML = confirmationContent; // Allows basic HTML
                 contentDiv.insertBefore(confirmTextElement, errorEl);
             } else {
                 // Create label and input dynamically
                 const newLabel = document.createElement('label');
                 newLabel.htmlFor = 'promptInput'; // Use consistent ID
                 newLabel.innerText = label;
                 newLabel.className = 'block mb-2 font-semibold'; // Basic styling

                 const newInput = document.createElement('input');
                 newInput.type = inputType;
                 newInput.id = 'promptInput'; // Use consistent ID
                 newInput.name = 'promptInput';
                 newInput.placeholder = placeholder;
                 newInput.value = initialValue;

                 // Apply theme-aware styling (ensure CSS supports these variables or classes)
                 const theme = document.documentElement.getAttribute('data-theme') || 'dark';
                 const baseInputClasses = "w-full p-3 rounded-lg border transition-colors duration-200 focus:outline-none focus:ring-2 mb-4";
                 const themeInputClasses = theme === 'light'
                    ? "bg-gray-100 border-gray-300 text-gray-900 focus:border-blue-400 focus:ring-blue-200"
                    : "bg-gray-700 border-gray-600 text-white focus:border-blue-500 focus:ring-blue-400 focus:ring-opacity-50";
                 newInput.className = `${baseInputClasses} ${themeInputClasses}`;

                 contentDiv.insertBefore(newLabel, errorEl);
                 contentDiv.insertBefore(newInput, errorEl);
             }

             confirmBtn.innerText = confirmText;
             cancelBtn.innerText = cancelText;

             currentPromptCallback = callback;
             currentCancelCallback = null; // Reset cancel

             confirmBtn.onclick = () => {
                 console.log(`Prompt modal "${title}" Confirm clicked.`);
                 if (currentPromptCallback) {
                     const value = isConfirmation ? true : safeGetElementById('promptInput')?.value;
                     currentPromptCallback(value);
                 } else {
                      console.warn("No callback defined for prompt confirm.");
                 }
             };
             cancelBtn.onclick = () => {
                  console.log(`Prompt modal "${title}" Cancel clicked.`);
                 hidePromptModal(); // Always hide on cancel
                 if (currentCancelCallback) {
                     currentCancelCallback();
                 }
             };

             modal.style.display = 'flex';
             if (!isConfirmation) {
                 safeGetElementById('promptInput')?.focus();
             }
        }

        function hidePromptModal() {
            console.log("Hiding prompt modal.");
            const modal = safeGetElementById('promptModal');
            if(modal) modal.style.display = 'none';
            currentPromptCallback = null;
            currentCancelCallback = null;
        }

        function showPromptError(message) {
             console.log("Showing prompt error:", message);
            const errorElement = safeGetElementById('promptError'); // Target specific error element
            if(errorElement) errorElement.innerText = message;
            else console.error("Prompt error element not found!");
        }

        // --- Upload Success Popup ---
        function showUploadSuccessPopup(publicId, title, uploader) {
             console.log(`Showing success popup for ${publicId}`);
             const modal = safeGetElementById('uploadSuccessPopup');
             const titleSpan = safeGetElementById('successVideoTitle');
             const uploaderSpan = safeGetElementById('successUploaderName');
             if (!modal || !titleSpan || !uploaderSpan) return;

             titleSpan.innerText = title || formatTitle(publicId);
             uploaderSpan.innerText = uploader || 'Anonymous';
             modal.style.display = 'flex';
        }

         function closeSuccessPopupAndRefresh() {
            console.log("Closing success popup.");
            const modal = safeGetElementById('uploadSuccessPopup');
             if(modal) modal.style.display = 'none';
            // Refresh is handled elsewhere (after saving details or skipping)
        }

        // --- Theme Toggle ---
        function toggleTheme() {
             console.log("Toggling theme...");
             const html = document.documentElement;
             const currentTheme = html.getAttribute("data-theme");
             const newTheme = currentTheme === "dark" ? "light" : "dark";
             html.setAttribute("data-theme", newTheme);
             console.log(`Theme set to: ${newTheme}`);
             // Re-apply active filter style
             const activeButton = document.querySelector('.filter-btn.active-filter');
             if (activeButton) {
                 const filterType = activeButton.id.split('-').pop();
                 setActiveFilter(activeButton, filterType, true); // true = prevent reload
             }
        }

        // --- Upload Logic ---
        function showUploadPopup() {
            console.log("Attempting to show upload popup...");
            try {
                const modal = safeGetElementById('uploadPopup');
                const uploaderInput = safeGetElementById('uploaderNameInput');
                const passwordInput = safeGetElementById('deletePassword');
                const progressContainer = safeGetElementById('progressContainer');
                const progressBar = safeGetElementById('progressBar');
                const statusEl = safeGetElementById('uploadStatus');

                if (!modal || !uploaderInput || !passwordInput || !progressContainer || !progressBar || !statusEl) {
                    console.error("One or more elements for the upload popup are missing!");
                    alert("Error: Could not open the upload window. Please refresh the page.");
                    return;
                }

                uploaderInput.value = '';
                passwordInput.value = '';
                progressBar.style.width = '0%';
                progressContainer.style.display = 'none';
                statusEl.innerText = '';
                modal.style.display = "flex";
                console.log("Upload popup displayed.");
            } catch (error) {
                 console.error("Error in showUploadPopup:", error);
                 alert("An unexpected error occurred while trying to open the upload window.");
            }
        }

        function hideUploadPopup() {
            console.log("Hiding upload popup.");
            const modal = safeGetElementById('uploadPopup');
            if(modal) modal.style.display = "none";
        }

        function openCloudinaryUpload() {
            console.log("Opening Cloudinary Upload Widget...");
            const uploaderNameInput = safeGetElementById('uploaderNameInput');
            const delPassInput = safeGetElementById('deletePassword');
            const progressBar = safeGetElementById('progressBar');
            const progressContainer = safeGetElementById('progressContainer');
            const status = safeGetElementById('uploadStatus');

             if (!uploaderNameInput || !delPassInput || !progressBar || !progressContainer || !status) {
                  console.error("Missing elements required for Cloudinary upload.");
                  return;
             }

            const uploaderName = uploaderNameInput.value.trim() || 'Anonymous';
            const delPass = delPassInput.value.trim();

            if (!delPass) {
                status.innerText = "❌ Deletion password is required.";
                console.warn("Upload blocked: No deletion password.");
                delPassInput.focus(); // Focus the password field
                return;
            }

            status.innerText = 'Initializing...';
            progressBar.style.width = '0%';
            progressContainer.style.display = 'block'; // Show progress

            try {
                cloudinary.openUploadWidget({
                    cloudName, uploadPreset,
                    sources: ['local', 'url', 'camera'],
                    resourceType: 'video',
                    multiple: false,
                    clientAllowedFormats: ['mp4', 'webm', 'mov'],
                    maxFileSize: 300000000,
                    folder: 'gs_overlay_vault',
                    theme: document.documentElement.getAttribute("data-theme") || "dark",
                    // Add styles if needed
                }, (error, result) => {
                     if (error) {
                        console.error("Cloudinary Widget Error:", error);
                        status.innerText = `❌ Upload failed: ${error.message || 'Unknown error'}`;
                        progressBar.style.width = '0%';
                        progressContainer.style.display = 'none'; // Hide progress on error
                    } else if (result && result.event) {
                         console.log("Cloudinary Event:", result.event, result.info || '');

                         switch (result.event) {
                             case "uploadprogress":
                                 const percent = Math.round((result.info.bytes_uploaded / result.info.total_bytes) * 100);
                                 progressBar.style.width = `${percent}%`;
                                 status.innerText = `Uploading... ${percent}%`;
                                 break;
                             case "success":
                                 console.log("Widget Success - Public ID:", result.info.public_id);
                                 status.innerText = `✅ Processing...`;
                                 progressBar.style.width = '100%';

                                 postUploadData = { // Prepare for next step
                                     publicId: result.info.public_id,
                                     originalFilename: result.info.original_filename,
                                     uploaderName: uploaderName
                                 };

                                 // Store immediately
                                 localStorage.setItem(`pass_${result.info.public_id}`, delPass);
                                 uploaderNames[result.info.public_id] = uploaderName;
                                 localStorage.setItem('uploaderNames', JSON.stringify(uploaderNames));
                                 console.log(`Stored password/uploader for ${result.info.public_id}`);
                                 break;
                             case "close":
                                  console.log("Widget Closed event.");
                                 // Only proceed if success happened before close
                                 if (postUploadData) {
                                     hideUploadPopup(); // Hide upload popup
                                     showPostUploadDetailsModal(postUploadData); // Show details modal
                                     postUploadData = null; // Clear temp data
                                 } else {
                                     console.log("Widget closed without successful upload completion.");
                                     // Optionally update status if needed
                                     if (!status.innerText.includes('failed')) {
                                        status.innerText = 'Upload cancelled or closed.';
                                        progressContainer.style.display = 'none';
                                     }
                                 }
                                 break;
                            // No need for queue-finished if multiple: false
                         }
                    }
                });
            } catch (widgetError) {
                 console.error("Error initializing Cloudinary Widget:", widgetError);
                 status.innerText = "❌ Error initializing upload widget.";
                 progressContainer.style.display = 'none';
            }
        }

        // --- Post-Upload Details Modal Logic ---
        function showPostUploadDetailsModal(data) {
            console.log("Showing post-upload modal:", data);
            postUploadData = data; // Store for saving
            const modal = safeGetElementById('postUploadDetailsModal');
            const titleInput = safeGetElementById('postUploadTitleInput');
            const uploaderNameSpan = safeGetElementById('postUploadUploaderName');
            const errorMsg = safeGetElementById('postUploadError');
            const saveBtn = safeGetElementById('postUploadSaveBtn');

            if (!modal || !titleInput || !uploaderNameSpan || !errorMsg || !saveBtn) return;

            titleInput.value = formatTitle(data.publicId); // Default title
            uploaderNameSpan.textContent = data.uploaderName || 'Anonymous';
            errorMsg.textContent = '';
            saveBtn.disabled = false; // Re-enable button

            modal.style.display = 'flex';
            titleInput.focus();
        }

        function savePostUploadDetails() {
            console.log("Saving post-upload details...");
            if (!postUploadData) {
                console.error("Save failed: postUploadData is null.");
                // Optionally show error in the modal itself
                const errorMsg = safeGetElementById('postUploadError');
                if (errorMsg) errorMsg.textContent = "Error: Upload data missing. Please try again.";
                return;
            }

            const titleInput = safeGetElementById('postUploadTitleInput');
            const errorMsg = safeGetElementById('postUploadError');
            const saveBtn = safeGetElementById('postUploadSaveBtn');
            if (!titleInput || !errorMsg || !saveBtn) return; // Elements missing

            const newTitle = titleInput.value.trim();

            if (!newTitle) {
                errorMsg.textContent = "Video title cannot be empty.";
                console.warn("Save failed: Title empty.");
                return;
            }

            console.log(`Saving title "${newTitle}" for ${postUploadData.publicId}`);
            saveBtn.disabled = true; // Prevent double save
            errorMsg.textContent = '';

            // Save title
            renamedTitles[postUploadData.publicId] = newTitle;
            localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));
            console.log("Title saved.");

            closePostUploadModal(false); // Close this modal (false = not skipped)
            showUploadSuccessPopup(postUploadData.publicId, newTitle, postUploadData.uploaderName); // Show final success
            loadVideos(true); // Refresh gallery
        }

        function closePostUploadModal(skipped = false) {
            console.log(`Closing post-upload modal. Skipped: ${skipped}`);
            const modal = safeGetElementById('postUploadDetailsModal');
            if(modal) modal.style.display = 'none';

            if (skipped && postUploadData) {
                 console.log("Title skipped, showing success with default title.");
                // Still show success popup, but use default title
                showUploadSuccessPopup(postUploadData.publicId, formatTitle(postUploadData.publicId), postUploadData.uploaderName);
                loadVideos(true); // Refresh gallery
            }
            postUploadData = null; // Always clear temp data
        }


        // --- Filtering Logic ---
        function setActiveFilter(buttonElement, filterType, preventLoad = false) {
            if (!buttonElement) {
                console.warn(`setActiveFilter called with null buttonElement for type ${filterType}`);
                return;
            }
            console.log(`Setting active filter: ${filterType}, Prevent load: ${preventLoad}`);
            document.querySelectorAll('.filter-btn.active-filter').forEach(btn => {
                 btn.classList.remove('active-filter');
                 // Remove specific theme styles added previously
                 btn.classList.remove('bg-indigo-600', 'text-white', 'bg-green-400', 'text-black');
            });

            buttonElement.classList.add('active-filter');
            // Add theme-aware active styles more reliably
            const theme = document.documentElement.getAttribute("data-theme") || "dark";
            const activeClasses = theme === 'light'
                ? ['bg-indigo-600', 'text-white'] // Example light theme active
                : ['bg-green-400', 'text-black']; // Dark theme active
            buttonElement.classList.add(...activeClasses);

            currentFilter = filterType;

            if (!preventLoad) {
                 loadVideos(true); // Reset and load based on new filter
            }
        }

        // --- Video Loading & Rendering ---
        async function loadVideos(reset = false) {
            const gallery = safeGetElementById("gallery");
            const loadMoreBtn = safeGetElementById('loadMoreBtn');
            if (!gallery || !loadMoreBtn) return; // Essential elements missing

            if (reset) {
                console.log("Loading videos (resetting).");
                allVideos = [];
                displayedVideos = [];
                currentVideoIndex = 0;
                gallery.innerHTML = '<p class="text-center w-full col-span-full text-lg p-8">🔄 Loading videos...</p>';
                loadMoreBtn.style.display = 'none';
                loadMoreBtn.disabled = true;
            } else {
                 console.log("Loading more videos.");
            }

            try {
                 if (reset || allVideos.length === 0) {
                    console.log("Fetching video list...");
                    // ADD A TIMEOUT OR LOADING INDICATOR HERE FOR BETTER UX ON SLOW FETCH
                    const res = await fetch(`/videos`); // Ensure backend endpoint is correct
                    if (!res.ok) {
                        throw new Error(`Failed to fetch: ${res.status} ${res.statusText}`);
                    }
                    const data = await res.json();
                    if (!Array.isArray(data)) {
                        throw new Error("Invalid data format from server.");
                    }
                    allVideos = data;
                    console.log(`Fetched ${allVideos.length} videos.`);
                 }

                sortVideos();
                const filteredVideos = applySearchFilter(allVideos);
                console.log(`${filteredVideos.length} videos after filtering.`);

                if (reset) {
                     gallery.innerHTML = ''; // Clear loading message
                     displayedVideos = [];
                     currentVideoIndex = 0;
                }

                renderVideoBatch(filteredVideos); // Render the appropriate batch

            } catch (error) {
                console.error("Error in loadVideos:", error);
                gallery.innerHTML = `<p class="text-center w-full col-span-full text-red-500 p-8">❌ Error loading videos: ${error.message}. Please try refreshing.</p>`;
                 loadMoreBtn.style.display = 'none';
            }
        }

        function sortVideos() {
            console.log(`Sorting by: ${currentFilter}`);
            // Sorting logic (keep as before)
            switch (currentFilter) { /* ... */ }
        }

        function applySearchFilter(videos) {
             if (!currentSearchQuery) return videos;
             console.log(`Applying search filter: "${currentSearchQuery}"`);
             // Filtering logic (keep as before)
            const query = currentSearchQuery.toLowerCase();
            return videos.filter(video => { /* ... */ });
        }

        function renderVideoBatch(sourceVideoList) {
            const gallery = safeGetElementById("gallery");
            const loadMoreBtn = safeGetElementById('loadMoreBtn');
            if (!gallery || !loadMoreBtn) return;

            const fragment = document.createDocumentFragment();
            const nextBatchEndIndex = Math.min(currentVideoIndex + videosPerLoad, sourceVideoList.length);
            const batch = sourceVideoList.slice(currentVideoIndex, nextBatchEndIndex);

            console.log(`Rendering batch ${currentVideoIndex} to ${nextBatchEndIndex - 1}`);

            if (currentVideoIndex === 0 && batch.length === 0) {
                const message = currentSearchQuery ? `📪 No results for "${currentSearchQuery}".` : '📪 No videos found.';
                gallery.innerHTML = `<p class="text-center w-full col-span-full text-lg p-8">${message}</p>`;
                loadMoreBtn.style.display = 'none';
                return;
            }

            batch.forEach(file => {
                const publicId = file.public_id;
                const safeId = publicId.replace(/[^a-zA-Z0-9_]/g, '_'); // Simplified safe ID
                const title = renamedTitles[publicId] || formatTitle(publicId);
                const uploader = uploaderNames[publicId] || 'Anonymous';
                const videoUrl = `https://res.cloudinary.com/${cloudName}/video/upload/q_auto:eco/v1/${publicId}.mp4`;
                const thumbnailUrl = `https://res.cloudinary.com/${cloudName}/video/upload/w_300,h_180,c_fill,q_auto,so_1/v1/${publicId}.jpg`;

                const card = document.createElement('div');
                card.className = 'card';
                // Assign public_id to card dataset for easier targeting if needed
                card.dataset.publicId = publicId;
                card.innerHTML = `
                    <div class="video-container" onclick="togglePlay(this.querySelector('video'))">
                        <video muted playsinline loop preload="metadata" poster="${thumbnailUrl}">
                            <source src="${videoUrl}" type="video/mp4">
                            Video not supported.
                        </video>
                    </div>
                    <div class="card-content">
                         <!-- Link data-id to the title element -->
                        <div class="card-title" title="${title}" data-id="${publicId}">${title}</div>
                        <div class="uploader-name" title="Uploaded by ${uploader}">by ${uploader}</div>
                    </div>
                    <div class="card-footer">
                        <a href="${videoUrl}" download="${title.replace(/[^a-z0-9_\-\.]/gi, '_')}.mp4" class="download-btn" title="Download ${title}">
                             <i class="fas fa-download text-xs"></i><span class="ml-1">Download</span>
                        </a>
                         <!-- Ensure onclick event calls toggleActionMenu correctly -->
                        <button type="button" class="menu-btn" title="Video Options" onclick="toggleActionMenu(event, '${publicId}')">
                            <i class="fas fa-ellipsis-h"></i>
                        </button>
                    </div>
                    <!-- Action Popup Menu - Ensure ID is correct and unique -->
                    <div class="action-popup" id="actionPopup_${safeId}">
                        <button type="button" onclick="triggerRename('${publicId}')"><i class="fas fa-pencil-alt fa-fw w-4"></i>Rename</button>
                        <button type="button" class="delete-action" onclick="triggerDelete('${publicId}')"><i class="fas fa-trash-alt fa-fw w-4"></i>Delete</button>
                    </div>
                `;
                fragment.appendChild(card);
            });

            gallery.appendChild(fragment);
            currentVideoIndex = nextBatchEndIndex;

            // Update Load More button
            if (currentVideoIndex < sourceVideoList.length) {
                loadMoreBtn.style.display = 'block';
                loadMoreBtn.disabled = false;
                loadMoreBtn.innerHTML = 'Load More Videos'; // Reset text
            } else {
                loadMoreBtn.style.display = 'none';
                loadMoreBtn.disabled = true;
                 console.log("All filtered videos rendered.");
            }
        }

        function loadMoreVideos() {
            const loadMoreBtn = safeGetElementById('loadMoreBtn');
             if(!loadMoreBtn || loadMoreBtn.disabled) return;

            loadMoreBtn.disabled = true;
            loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            console.log("Load More clicked.");

            const filteredVideos = applySearchFilter(allVideos);

            // Optional delay for UX
            setTimeout(() => {
                renderVideoBatch(filteredVideos);
            }, 200);
        }

        function formatTitle(publicId) {
            // Keep previous formatTitle logic
            try { /* ... */ } catch(e) { /* ... */ }
        }

        // --- Video Card Actions ---
        function togglePlay(videoElement) {
             if (!videoElement) { console.warn("togglePlay called with null videoElement."); return; }
             const container = videoElement.closest('.video-container');
             try {
                 if (videoElement.paused) {
                     videoElement.play().then(() => {
                         console.log("Video playing:", videoElement.src);
                         videoElement.classList.add('playing');
                         if (container) container.classList.add('playing');
                     }).catch(e => console.error("Video play error:", e));
                 } else {
                     videoElement.pause();
                     console.log("Video paused:", videoElement.src);
                     videoElement.classList.remove('playing');
                     if (container) container.classList.remove('playing');
                 }
             } catch (e) {
                 console.error("Error in togglePlay:", e);
             }
         }

        function toggleActionMenu(event, publicId) {
            try {
                event.stopPropagation(); // Prevent event bubbling
                const safeId = publicId.replace(/[^a-zA-Z0-9_]/g, '_');
                const popup = safeGetElementById(`actionPopup_${safeId}`); // Use safe getter
                if (!popup) {
                    console.error(`Action popup actionPopup_${safeId} not found for ${publicId}.`);
                    return; // Exit if popup doesn't exist
                }

                console.log(`Toggling action menu: ${popup.id}`);

                // Close other popups
                document.querySelectorAll('.action-popup').forEach(p => {
                    if (p.id !== popup.id && p.style.display === 'block') {
                        p.style.display = 'none';
                         console.log(`Closed other popup: ${p.id}`);
                    }
                });

                // Toggle target popup
                const isVisible = popup.style.display === 'block';
                popup.style.display = isVisible ? 'none' : 'block';
                console.log(`Popup ${popup.id} display: ${popup.style.display}`);

            } catch (error) {
                 console.error("Error in toggleActionMenu:", error);
            }
        }

        // Close action menus listener (Keep as before, seems robust)
        document.addEventListener('click', function(event) {
            // ... (keep existing logic) ...
             const openPopup = document.querySelector('.action-popup[style*="display: block"]');
             if (openPopup && !openPopup.contains(event.target) && !event.target.closest('.menu-btn')) {
                 console.log("Clicked outside, closing action menu:", openPopup.id);
                 openPopup.style.display = 'none';
             }
        });

        // --- Password Protected Actions ---
        // (Keep getPasswordAndExecute, triggerRename, proceedWithRename, triggerDelete, proceedWithDelete)
        // Ensure they use safeGetElementById where appropriate and add logging if needed.
        function getPasswordAndExecute(publicId, actionCallback) { /* ... keep logic, add logs ... */ }
        function triggerRename(publicId) { /* ... keep logic, add logs ... */ }
        function proceedWithRename(publicId) { /* ... keep logic, add logs ... */ }
        function triggerDelete(publicId) { /* ... keep logic, add logs ... */ }
        function proceedWithDelete(publicId) { /* ... keep logic, use safeGetElementById, add logs ... */ }

    </script>

</body>
</html>
