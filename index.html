--- START OF FILE index.html ---

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Green Screen Overlay Vault</title>
  <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Google Fonts (Example: Orbitron for Intro, Roboto for body) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Add Font Awesome for Icons (Optional, for minimal details) -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    /* Base & Theme Styles */
    body { font-family: 'Roboto', sans-serif; transition: background 0.3s, color 0.3s; }
    html[data-theme="dark"] body { background: #0a0a0a; color: white; } /* Slightly darker bg */
    html[data-theme="light"] body { background: #f8f9fa; color: #212529; } /* Light mode theme */

    /* Header */
    .header {
        background: linear-gradient(90deg, #00ff88, #00ccff); /* Gradient background */
        color: black; padding: 1.5rem 1rem; /* Adjusted padding */
        text-align: center; font-size: 2rem; /* Adjusted font size */
        font-weight: bold; position: relative;
        box-shadow: 0 4px 10px rgba(0, 255, 136, 0.3);
    }
     /* Responsive Header Font Size */
    @media (min-width: 640px) {
        .header { font-size: 2.5rem; padding: 2rem; }
    }
    .header h1 { animation: fadeInDown 1s ease-in-out; font-family: 'Orbitron', sans-serif; letter-spacing: 1px;}
    .header-buttons { position: absolute; top: 50%; transform: translateY(-50%); display: flex; gap: 0.5rem; }
    .header-buttons.left { left: 1rem; }
    .header-buttons.right { right: 1rem; }
    .header-btn {
        background: rgba(0, 0, 0, 0.5); color: white;
        border: 1px solid rgba(255, 255, 255, 0.5);
        padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.9rem;
        cursor: pointer; transition: background-color 0.2s, transform 0.2s;
        display: flex; align-items: center; gap: 0.3rem; /* For icon + text */
    }
    .header-btn:hover { background: rgba(0, 0, 0, 0.7); transform: scale(1.05); }
    html[data-theme="light"] .header-btn { background: rgba(255, 255, 255, 0.7); color: black; border-color: rgba(0, 0, 0, 0.2); }
    html[data-theme="light"] .header-btn:hover { background: rgba(255, 255, 255, 0.9); }
    /* Hide text on small screens for buttons */
    @media (max-width: 640px) {
        .header-btn span { display: none; }
        .header-btn { padding: 0.5rem; } /* Adjust padding for icon only */
         .header h1 { font-size: 1.5rem; }
         .header { padding: 1rem; }
    }


    /* Gallery & Cards */
    .gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; padding: 1.5rem; } /* Slightly smaller minmax, more gap */
    .card {
        background: #1f1f1f; border-radius: 1rem; overflow: hidden;
        border: 1px solid #333; /* Subtle border */
        box-shadow: 0 4px 15px rgba(0, 255, 136, 0.1);
        transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
        animation: fadeInUp 0.5s ease-in-out; position: relative;
        display: flex; flex-direction: column; /* Ensure footer stays at bottom */
    }
    html[data-theme="light"] .card { background: #ffffff; color: black; border-color: #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .card:hover {
        transform: translateY(-5px) scale(1.03); /* Adjusted hover effect */
        box-shadow: 0 8px 25px rgba(0, 255, 136, 0.25);
        border-color: #00ff88;
    }
    html[data-theme="light"] .card:hover {
        box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        border-color: #10b981;
     }

    .video-container { cursor: pointer; position: relative; } /* Added position relative */
    .video-container video { width: 100%; height: 180px; /* Fixed height */ object-fit: cover; border-radius: 1rem 1rem 0 0; background-color: #050505; display: block; }
     /* Play icon overlay */
    .video-container::after {
        content: '\f04b'; /* Font Awesome play icon */
        font-family: 'Font Awesome 6 Free'; font-weight: 900;
        position: absolute; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2.5rem; color: rgba(255, 255, 255, 0.7);
        opacity: 0; transition: opacity 0.3s; pointer-events: none;
    }
    .video-container:hover::after { opacity: 1; }
    .video-container video.playing::after { opacity: 0; } /* Hide icon when playing */

    .card-content { padding: 0.75rem; flex-grow: 1; } /* Allow content to grow */
    .card-title { font-weight: bold; margin-bottom: 0.25rem; line-height: 1.3; height: 2.6em; overflow: hidden; /* Limit title lines */ }
    .uploader-name { font-size: 0.75rem; opacity: 0.7; text-align: right; margin-bottom: 0.5rem; }
    html[data-theme="light"] .uploader-name { opacity: 0.8; }

    .card-footer {
        padding: 0 0.75rem 0.75rem; display: flex; justify-content: space-between; align-items: center; gap: 0.5rem; /* Added gap */
        border-top: 1px solid #333; margin-top: auto; /* Push footer down */
    }
    html[data-theme="light"] .card-footer { border-top-color: #e2e8f0; }

    .download-btn {
        background: #00ff88; color: black; padding: 0.4rem 0.8rem; text-align: center;
        font-weight: bold; display: inline-flex; align-items: center; gap: 0.3rem; /* Icon + text */
        border-radius: 0.5rem; font-size: 0.8rem; line-height: 1;
        transition: background-color 0.2s, transform 0.2s;
    }
    .download-btn:hover { background-color: #00e67a; transform: scale(1.05); }
    html[data-theme="light"] .download-btn { background: #10b981; color: white; }
    html[data-theme="light"] .download-btn:hover { background: #0f9e73; }

    .menu-btn {
        background: rgba(255, 255, 255, 0.1); border: 1px solid #555;
        border-radius: 50%; width: 28px; height: 28px;
        font-weight: bold; cursor: pointer; line-height: 1; color: #aaa;
        display: flex; align-items: center; justify-content: center;
        transition: background-color 0.2s, color 0.2s, border-color 0.2s;
    }
    html[data-theme="light"] .menu-btn { background: rgba(0, 0, 0, 0.05); border-color: #ccc; color: #555; }
    .menu-btn:hover { background: rgba(0, 255, 136, 0.3); color: white; border-color: #00ff88;}
    html[data-theme="light"] .menu-btn:hover { background: rgba(16, 185, 129, 0.2); color: #10b981; border-color: #10b981; }

    /* Action Popup Styles */
    .action-popup {
        display: none; position: absolute; bottom: 45px; /* Adjust if needed */
        right: 10px; background-color: #2a2a2a; border: 1px solid #444;
        border-radius: 8px; padding: 0.5rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        z-index: 10; animation: popUpFadeIn 0.2s ease-out; min-width: 110px;
    }
    html[data-theme="light"] .action-popup { background-color: #ffffff; border-color: #ccc; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); }
    .action-popup button {
        display: flex; align-items: center; gap: 0.5rem; /* Icon + text */
        width: 100%; background: none; border: none; color: #00ccff;
        padding: 0.5rem 0.7rem; text-align: left; cursor: pointer;
        border-radius: 4px; font-size: 0.9rem; transition: background-color 0.15s;
    }
    html[data-theme="light"] .action-popup button { color: #0c4a6e; }
    .action-popup button:hover { background-color: #3a3a3a; }
    html[data-theme="light"] .action-popup button:hover { background-color: #e5e7eb; }
    .action-popup button.delete-action { color: #ff5555; } /* Brighter red */
    html[data-theme="light"] .action-popup button.delete-action { color: #dc2626; }
    .action-popup button.delete-action:hover { background-color: rgba(255, 85, 85, 0.1); }
    html[data-theme="light"] .action-popup button.delete-action:hover { background-color: #fee2e2; }

    /* --- Modal Styles (Improved Responsiveness) --- */
    .modal-backdrop { /* ... keep existing styles ... */ backdrop-filter: blur(3px); } /* Optional blur */
    .modal-box {
        background-color: #1f1f1f; color: white; padding: 1.5rem; /* Adjusted padding */
        border-radius: 1rem; border: 1px solid #333; /* Subtle border */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        width: 90%; max-width: 500px; animation: scaleUp 0.3s ease-out; position: relative;
        max-height: 85vh; overflow-y: auto;
    }
    html[data-theme="light"] .modal-box { background-color: #ffffff; color: black; border-color: #ccc; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15); }
     /* Responsive modal padding */
     @media (min-width: 640px) { .modal-box { padding: 2rem; } }

    .modal-box h2 { font-size: 1.4rem; font-weight: bold; margin-bottom: 1rem; color: #00ff88;}
    html[data-theme="light"] .modal-box h2 { color: #10b981; }
    .modal-box label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: bold; }
    .modal-box input[type="text"], .modal-box input[type="password"], .modal-box textarea { /* Added textarea */
        width: 100%; padding: 0.75rem; border-radius: 0.5rem; background-color: #333;
        border: 1px solid #555; color: white; margin-bottom: 1rem; transition: border-color 0.2s, box-shadow 0.2s;
    }
    .modal-box input:focus, .modal-box textarea:focus { outline: none; border-color: #00ff88; box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.3); }
    html[data-theme="light"] .modal-box input[type="text"], html[data-theme="light"] .modal-box input[type="password"], html[data-theme="light"] .modal-box textarea { background-color: #e5e7eb; border-color: #ccc; color: black; }
    html[data-theme="light"] .modal-box input:focus, html[data-theme="light"] .modal-box textarea:focus { border-color: #10b981; box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); }
    .modal-buttons { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; }
    .modal-buttons button { /* ... keep base styles ... */ font-size: 0.9rem; padding: 0.6rem 1rem; }
    .modal-error { color: #ff5555; font-size: 0.85rem; margin-top: 0.5rem; min-height: 1.2em; }

    /* --- Terms Modal Specific Styles --- */
    #termsModal .modal-box { max-width: 700px; } /* Wider for terms */
    .terms-content { /* ... keep styles ... */ background-color: rgba(0,0,0,0.1); }
    html[data-theme="light"] .terms-content { background-color: rgba(0,0,0,0.03); }
    /* ... keep other terms styles ... */

    /* --- Filters & Search --- */
    .filter-search-area { padding: 1rem 1.5rem; background-color: rgba(0,0,0,0.1); border-bottom: 1px solid #333; }
    html[data-theme="light"] .filter-search-area { background-color: rgba(0,0,0,0.02); border-bottom-color: #e2e8f0; }
    .filter-options { display: flex; justify-content: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .filter-btn { /* ... keep base styles ... */ font-size: 0.85rem; padding: 0.5rem 1rem; }
    .search-container { display: flex; justify-content: center; align-items: center; max-width: 400px; margin: 0 auto; }
    .search-container label { display: none; } /* Hide label visually, use placeholder */
    .search-container input {
        flex-grow: 1; padding: 0.6rem 1rem; border-radius: 1rem;
        background-color: #333; border: 1px solid #555; color: white;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .search-container input:focus { outline: none; border-color: #00ccff; box-shadow: 0 0 0 2px rgba(0, 204, 255, 0.3); }
    html[data-theme="light"] .search-container input { background-color: #e5e7eb; border-color: #ccc; color: black; }
    html[data-theme="light"] .search-container input:focus { border-color: #38bdf8; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.3); }

    /* --- Intro Screen --- */
    #introScreen {
      position: fixed; inset: 0; background-color: #000;
      display: flex; align-items: center; justify-content: center;
      z-index: 100; color: white; font-family: 'Orbitron', sans-serif;
      opacity: 1; transition: opacity 1s ease-out 0.5s; /* Delay fade out */
      pointer-events: auto; /* Initially interactable */
    }
    #introScreen.fade-out { opacity: 0; pointer-events: none; }
    #introText {
      font-size: 2.5rem; font-weight: bold; letter-spacing: 2px;
      opacity: 0;
      animation: textPopInGlow 2s ease-out forwards;
      text-shadow: 0 0 5px #00ff88, 0 0 10px #00ff88, 0 0 15px #00ccff, 0 0 20px #00ccff;
    }
     /* Responsive Intro Text */
    @media (min-width: 640px) { #introText { font-size: 3.5rem; } }
    @media (max-width: 480px) { #introText { font-size: 1.8rem; } }


    /* --- Load More Button --- */
    #loadMoreBtn { /* ... keep base styles ... */ font-size: 0.9rem; }

    /* --- How-to Section & Info --- */
    .info-section { padding: 2rem 1.5rem; text-align: center; }
    .info-section h2 { font-size: 1.8rem; font-weight: bold; margin-bottom: 1rem; color: #00ff88; }
    html[data-theme="light"] .info-section h2 { color: #10b981; }
    .info-section h3 { font-size: 1.3rem; font-weight: bold; margin-top: 2rem; margin-bottom: 0.75rem; color: #00ccff; }
    html[data-theme="light"] .info-section h3 { color: #0ea5e9; }
    .info-section p, .info-section ol { max-w-3xl mx-auto mb-4 text-base leading-relaxed; }
    html[data-theme="dark"] .info-section p, html[data-theme="dark"] .info-section ol { color: #ccc; }
    html[data-theme="light"] .info-section p, html[data-theme="light"] .info-section ol { color: #4b5563; }
    .info-section ol { text-align: left; padding-left: 1.5rem; }
    .info-section code { background-color: rgba(255,255,255,0.1); padding: 0.1em 0.4em; border-radius: 4px; font-size: 0.9em; }
    html[data-theme="light"] .info-section code { background-color: rgba(0,0,0,0.05); }
    .video-wrapper { /* ... keep styles ... */ max-width: 700px; margin: 1.5rem auto; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    html[data-theme="light"] .video-wrapper { box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

    /* --- Tooltip Styles (Simple Example) --- */
    .tooltip { position: relative; display: inline-block; cursor: help; border-bottom: 1px dotted; }
    .tooltip .tooltiptext {
        visibility: hidden; width: 200px; background-color: #2a2a2a; color: #fff;
        text-align: center; border-radius: 6px; padding: 8px; position: absolute;
        z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; /* Center */
        opacity: 0; transition: opacity 0.3s; font-size: 0.8rem; line-height: 1.4;
        border: 1px solid #444; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    html[data-theme="light"] .tooltip .tooltiptext { background-color: #f0f0f0; color: #333; border-color: #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
    .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }

    /* --- Footer --- */
    .site-footer { /* ... keep base styles ... */ background-color: rgba(0,0,0,0.1); }
    html[data-theme="light"] .site-footer { background-color: rgba(0,0,0,0.02); }
    .footer-link { /* ... keep base styles ... */ }


    /* Animations */
    @keyframes glow { from { filter: drop-shadow(0 0 5px #00ff88); } to { filter: drop-shadow(0 0 15px #00ccff); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    @keyframes popUpFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes textPopInGlow { /* Updated intro animation */
        0% { opacity: 0; transform: scale(0.8) translateY(20px); text-shadow: 0 0 2px #00ff88, 0 0 4px #00ccff;}
        60% { opacity: 1; transform: scale(1.05) translateY(0); text-shadow: 0 0 8px #00ff88, 0 0 15px #00ff88, 0 0 20px #00ccff, 0 0 25px #00ccff, 0 0 30px #00ccff; }
        100% { opacity: 1; transform: scale(1) translateY(0); text-shadow: 0 0 5px #00ff88, 0 0 10px #00ff88, 0 0 15px #00ccff, 0 0 20px #00ccff; }
    }

    /* Utility for screen readers */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

  </style>
</head>
<body>

  <!-- Intro Screen -->
  <div id="introScreen">
    <span id="introText">Green Screen Vault</span> <!-- Shortened -->
  </div>

  <!-- Header -->
  <header class="header">
    <h1>🎬 Green Screen Vault</h1>
    <div class="header-buttons left">
        <button onclick="toggleTheme()" class="header-btn" title="Toggle Theme">
            <i class="fas fa-adjust"></i> <span class="sr-only sm:not-sr-only">Theme</span>
        </button>
    </div>
    <div class="header-buttons right">
        <button onclick="showUploadPopup()" class="header-btn" title="Upload Video">
             <i class="fas fa-upload"></i> <span class="sr-only sm:not-sr-only">Upload</span>
        </button>
    </div>
  </header>

  <!-- Filter and Search Area -->
  <div class="filter-search-area">
    <div class="filter-options">
      <button class="filter-btn" id="filter-recent" onclick="setActiveFilter(this, 'recent')">Most Recent</button>
      <button class="filter-btn" id="filter-popular" onclick="setActiveFilter(this, 'popular')">Popular</button>
      <!-- <button class="filter-btn" id="filter-relevant" onclick="setActiveFilter(this, 'relevant')">Relevant</button> --> <!-- Relevance is tricky without context -->
    </div>
    <div class="search-container">
      <label for="search" class="sr-only">Search Videos:</label>
      <input type="search" id="search" oninput="debounceSearch()" class="" placeholder="Search by title or uploader...">
    </div>
  </div>


  <main>
      <div class="gallery" id="gallery">
          <!-- Loading message added dynamically -->
      </div>

      <!-- Load More Button -->
      <button id="loadMoreBtn" onclick="loadMoreVideos()" style="display: none;">Load More Videos</button>

       <!-- Info / How-to Section -->
      <section class="info-section landing-page">
          <h2>Unlock Your Creativity</h2>
          <p>
              Welcome to the Green Screen Vault! A community-driven library of free <span class="tooltip">chroma key<span class="tooltiptext">Chroma key compositing, or chroma keying, is a visual effects technique for compositing two images or video streams together based on color hues (chroma range).</span></span> footage. Find dynamic effects, transitions, and elements to elevate your video projects.
          </p>

          <!-- Responsive YouTube Embed -->
          <div class="video-wrapper">
            <iframe
                src="https://www.youtube.com/embed/-UFG_jU3bXA"
                title="YouTube video player - Green Screen Tutorial (Adobe Premiere Pro Ultra Key)"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen>
            </iframe>
          </div>

          <h3>Quick Guide: Using Overlays (Premiere Pro)</h3>
          <ol>
              <li><strong>Import:</strong> Add your footage and the downloaded overlay (.mp4, .mov) to your project.</li>
              <li><strong>Layer:</strong> Place the overlay clip on the timeline track <strong>above</strong> your main footage.</li>
              <li><strong>Effect:</strong> Search for <code>Ultra Key</code> in the Effects panel and drag it onto the overlay clip.</li>
              <li><strong>Key Color:</strong> In Effect Controls > Ultra Key, use the eyedropper <i class="fas fa-eye-dropper"></i> to select the green screen color.</li>
              <li><strong>Refine:</strong> Adjust Matte Generation/Cleanup/Spill Suppression settings for a clean result. Look for settings like <span class="tooltip">Choke<span class="tooltiptext">Reduces the size of the matte slightly to hide faint edges.</span></span> and <span class="tooltip">Soften<span class="tooltiptext">Blurs the edges of the matte for smoother blending.</span></span>.</li>
              <li><strong>Composite:</strong> Position, scale, or animate the overlay layer as needed!</li>
          </ol>

           <h3><i class="fas fa-lightbulb"></i> Pro Tips & Benefits</h3>
           <p>
               Using overlays saves significant time compared to creating effects from scratch. They add professional polish to YouTube videos, streams, social media content, and films. This vault thrives on community contributions – consider uploading your own creations!
           </p>
           <p>
               <strong>Shooting Tip:</strong> Ensure your green screen is evenly lit and wrinkle-free for the best keying results. Avoid green clothing or reflective objects on your subject.
           </p>
           <div class="mt-6"> <!-- Info card example -->
                <div class="inline-block bg-teal-100 text-teal-800 p-3 rounded-lg text-sm shadow">
                    <i class="fas fa-info-circle mr-1"></i> This site uses <span class="tooltip">Cloudinary<span class="tooltiptext">A cloud-based service for managing and delivering images and videos.</span></span> for video hosting and optimized delivery.
                </div>
           </div>
      </section>
  </main>


  <!-- Initial Upload Popup (Minimal) -->
  <div class="fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4" id="uploadPopup">
    <div class="modal-box w-full max-w-md"> <!-- Re-use modal-box style -->
        <button class="modal-close-btn" onclick="hideUploadPopup()">×</button>
        <h2 class="text-xl font-bold mb-4">Upload Overlay</h2>
        <p class="text-sm text-gray-400 mb-4">Help the community grow by sharing your green screen creations!</p>
        <div>
            <label for="uploaderNameInput">Your Name/Alias (Optional):</label>
            <input type="text" id="uploaderNameInput" placeholder="Shown publicly with your video" class="mb-4">
        </div>
        <div>
            <label for="deletePassword">Deletion Password (Required):</label>
            <input type="password" id="deletePassword" placeholder="Save this password securely!" class="mb-4">
        </div>
      <button onclick="openCloudinaryUpload()" class="modal-button-confirm w-full justify-center text-base py-3"> <!-- Use modal button style -->
          <i class="fas fa-cloud-upload-alt mr-2"></i> Select & Upload Video
      </button>
      <div class="progress-container mt-4" style="display: none;"><div class="progress-bar" id="progressBar"></div></div>
      <p id="uploadStatus" class="mt-2 text-sm h-5 text-center"></p>
      <button onclick="hideUploadPopup()" class="modal-button-cancel w-full justify-center mt-2">Cancel</button>
    </div>
  </div>

  <!-- Post-Upload Details Modal -->
  <div class="modal-backdrop" id="postUploadDetailsModal">
    <div class="modal-box">
      <button class="modal-close-btn" onclick="closePostUploadModal(true)">×</button> <!-- true = skip -->
      <h2>Finalize Upload Details</h2>
      <p class="text-sm mb-4">Your video is uploaded! Please provide a title.</p>
      <div>
        <label for="postUploadTitleInput">Video Title (Required):</label>
        <input type="text" id="postUploadTitleInput" name="postUploadTitleInput"> <!-- Removed specific classes, inherited from modal styles -->
        <p class="text-xs mt-1 text-gray-400">Uploader: <span id="postUploadUploaderName"></span></p>
        <p class="modal-error" id="postUploadError"></p>
      </div>
      <div class="modal-buttons">
        <button class="modal-button-cancel" onclick="closePostUploadModal(true)">Skip Title</button>
        <button class="modal-button-confirm" id="postUploadSaveBtn" onclick="savePostUploadDetails()">Save Details</button>
      </div>
    </div>
  </div>


  <!-- Generic Prompt/Confirmation Modal -->
  <div class="modal-backdrop" id="promptModal">
    <div class="modal-box">
      <button class="modal-close-btn" onclick="hidePromptModal()">×</button>
      <h2 id="promptTitle">Prompt</h2>
      <div id="promptContent">
        <!-- Content here will be dynamically set -->
        <p class="modal-error" id="promptError"></p> <!-- Error moved inside content div -->
      </div>
      <div class="modal-buttons">
        <button class="modal-button-cancel" id="promptCancelBtn" onclick="hidePromptModal()">Cancel</button>
        <button class="modal-button-confirm" id="promptConfirmBtn">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Upload Success Modal -->
  <div class="modal-backdrop" id="uploadSuccessPopup">
      <div class="modal-box text-center"> <!-- Centered text -->
          <button class="modal-close-btn" onclick="closeSuccessPopupAndRefresh()">×</button>
          <h2 class="text-2xl"><i class="fas fa-rocket text-blue-400 mr-2"></i>Upload Complete!</h2>
          <div id="uploadSuccessContent" class="my-4">
              <p>Thank you, <strong id="successUploaderName" class="text-green-400"></strong>!</p>
              <p>Your overlay "<strong id="successVideoTitle" class="text-yellow-400"></strong>" is now live.</p>
              <p class="mt-2 text-sm text-gray-400">Sharing helps the creative community grow!</p>
          </div>
          <div class="modal-buttons justify-center"> <!-- Centered button -->
              <button class="modal-button-confirm" onclick="closeSuccessPopupAndRefresh()">Awesome!</button>
          </div>
      </div>
  </div>

  <!-- Terms and Conditions Modal -->
  <div class="modal-backdrop" id="termsModal">
      <div class="modal-box">
          <!-- Keep existing terms content -->
           <button class="modal-close-btn" onclick="closeTermsModal()">×</button>
            <h2>Terms & Privacy</h2>
            <div class="terms-content" style="max-height: 60vh;"> <!-- Adjusted height -->
                 <!-- Your full T&C and Privacy Policy text goes here -->
                <h3>Terms and Conditions</h3>
                <p><em>Last updated: April 26, 2024</em></p>
                <p>Welcome to Green Screen Overlay Vault! By accessing or using our website, you agree to be bound by these Terms and Conditions ("Terms"). Please read them carefully...</p>
                <!-- ... (rest of T&C) ... -->
                <hr class="my-4 border-gray-600">
                <h3>Privacy Policy</h3>
                <p><em>Effective Date: April 26, 2024</em></p>
                 <p>We value your privacy. This Privacy Policy explains how we handle information on Green Screen Overlay Vault...</p>
                 <!-- ... (rest of Privacy Policy) ... -->
            </div>
            <label class="terms-accept-label mt-4" id="termsAcceptWrapper" style="display: none;"> <!-- Initially hidden -->
                <input type="checkbox" id="termsAcceptCheckbox" class="mr-2">
                <span>I have read and agree to the Terms and Conditions and Privacy Policy.</span>
            </label>
            <p class="modal-error" id="termsError"></p>
            <div class="modal-buttons">
                <button class="modal-button-confirm" id="termsAcceptBtn" onclick="acceptTerms()" style="display: none;">Agree & Continue</button> <!-- Initially hidden -->
                <button class="modal-button-cancel" id="termsCloseBtn" onclick="closeTermsModal()">Close</button> <!-- Default button -->
            </div>
      </div>
  </div>

   <!-- Footer -->
   <footer class="site-footer">
       <p>© <span id="currentYear"></span> Green Screen Vault. Community driven.</p>
       <p><span class="footer-link" onclick="showTermsModal(true)">View Terms & Privacy Policy</span></p>
   </footer>


  <script>
    const cloudName = 'dogxcu1sj';
    const uploadPreset = 'gs_overlay'; // MAKE SURE THIS PRESET EXISTS AND IS CONFIGURED FOR UNSIGNED UPLOADS
    let allVideos = [];
    let displayedVideos = [];
    const videosPerLoad = 12;
    let currentVideoIndex = 0;
    let renamedTitles = JSON.parse(localStorage.getItem('renamedTitles') || '{}');
    let uploaderNames = JSON.parse(localStorage.getItem('uploaderNames') || '{}');
    let currentFilter = 'recent';
    let currentSearchQuery = '';
    let postUploadData = null; // Holds data between upload success and modal save
    let searchTimeout; // For debouncing search input

    // --- Debounce Function ---
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // --- Intro Screen Logic ---
    function handleIntro() {
        console.log("Handling Intro");
        const introScreen = document.getElementById('introScreen');
        if (!introScreen) {
             console.log("Intro screen not found, checking terms directly.");
             checkTerms(); // Proceed if intro is already gone (e.g., error)
             return;
        }

        // Wait slightly longer than animation + text animation duration
        setTimeout(() => {
            introScreen.classList.add('fade-out');
            introScreen.addEventListener('transitionend', () => {
                if (introScreen.parentNode) {
                   introScreen.parentNode.removeChild(introScreen);
                }
                console.log("Intro fade out complete, checking terms.");
                checkTerms(); // Check terms AFTER intro fades out
            }, { once: true });
        }, 2500); // Adjusted timing (2s animation + 0.5s buffer)
    }

    // --- Terms and Conditions Logic ---
    function checkTerms() {
        const accepted = localStorage.getItem('termsAccepted');
        if (accepted !== 'true') {
            console.log("Terms not accepted, showing modal for acceptance.");
            showTermsModal(false); // Show for acceptance
        } else {
            console.log("Terms accepted, initializing page.");
            initializePage();
        }
    }

    function showTermsModal(isViewingOnly = false) {
        const modal = document.getElementById('termsModal');
        const acceptWrapper = document.getElementById('termsAcceptWrapper');
        const acceptBtn = document.getElementById('termsAcceptBtn');
        const closeBtn = document.getElementById('termsCloseBtn');
        const errorMsg = document.getElementById('termsError');

        if (!modal || !acceptWrapper || !acceptBtn || !closeBtn || !errorMsg) {
            console.error("Terms modal elements not found!");
            return;
        }

        errorMsg.textContent = ''; // Clear error

        if (isViewingOnly) {
            console.log("Showing terms modal (View Only)");
            acceptWrapper.style.display = 'none';
            acceptBtn.style.display = 'none';
            closeBtn.style.display = 'inline-flex'; // Use inline-flex if buttons use flex
        } else {
             console.log("Showing terms modal (Acceptance Required)");
            acceptWrapper.style.display = 'flex'; // Use display type from CSS
            acceptBtn.style.display = 'inline-flex';
            closeBtn.style.display = 'none';
            const checkbox = document.getElementById('termsAcceptCheckbox');
            if (checkbox) checkbox.checked = false;
        }
        modal.style.display = 'flex';
    }

    function acceptTerms() {
        const checkbox = document.getElementById('termsAcceptCheckbox');
        const errorMsg = document.getElementById('termsError');
        if (!checkbox || !errorMsg) return;

        if (checkbox.checked) {
            console.log("Terms accepted by user.");
            localStorage.setItem('termsAccepted', 'true');
            closeTermsModal();
            initializePage(); // Load content after accepting
        } else {
            errorMsg.textContent = 'You must accept the terms to continue.';
        }
    }

    function closeTermsModal() {
        const modal = document.getElementById('termsModal');
        const errorMsg = document.getElementById('termsError');
        if (modal) modal.style.display = 'none';
        if (errorMsg) errorMsg.textContent = '';
        console.log("Terms modal closed.");
    }

    // --- Page Initialization ---
    function initializePage() {
        console.log("Initializing page content...");
        const initialFilterButton = document.getElementById('filter-recent');
        if (initialFilterButton && !initialFilterButton.classList.contains('active-filter')) {
             setActiveFilter(initialFilterButton, 'recent', true); // Prevent double load
        }
        loadVideos(true); // Initial load
        updateFooterYear();
        setupSearchDebounce(); // Setup debounced search listener
    }

    function updateFooterYear() {
        const yearSpan = document.getElementById('currentYear');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();
    }

     function setupSearchDebounce() {
        const searchInput = document.getElementById('search');
        if (searchInput) {
            // Use 'input' event for real-time feedback
            searchInput.addEventListener('input', debounceSearch);
        }
     }

     // Debounced search function
     const debounceSearch = debounce(() => {
         const query = document.getElementById("search").value.toLowerCase().trim();
         console.log(`Debounced search triggered with query: "${query}"`);
         if (query !== currentSearchQuery) {
             currentSearchQuery = query;
             loadVideos(true); // Reset and load with the new search query applied
         } else {
             console.log("Search query hasn't changed significantly, skipping reload.");
         }
     }, 400); // 400ms delay after user stops typing


    // --- Modal Helper Functions ---
    let currentPromptCallback = null;
    let currentCancelCallback = null;

    function showPromptModal({ title, label, inputType = 'text', placeholder = '', confirmText = 'Confirm', cancelText = 'Cancel', callback, initialValue = '', isConfirmation = false, confirmationContent = '', confirmClass = '' }) {
        const modal = document.getElementById('promptModal');
        const titleEl = document.getElementById('promptTitle');
        const contentDiv = document.getElementById('promptContent');
        const confirmBtn = document.getElementById('promptConfirmBtn');
        const cancelBtn = document.getElementById('promptCancelBtn');
        const errorEl = document.getElementById('promptError'); // Get error element reference

         if (!modal || !titleEl || !contentDiv || !confirmBtn || !cancelBtn || !errorEl) {
             console.error("Prompt Modal elements missing!");
             return;
         }

        // Reset state
        titleEl.innerText = title;
        contentDiv.innerHTML = ''; // Clear dynamic content first
        errorEl.innerText = ''; // Clear error message specifically
        contentDiv.appendChild(errorEl); // Re-append error placeholder inside content div
        confirmBtn.className = 'modal-button-confirm'; // Reset class
        if (confirmClass) confirmBtn.classList.add(confirmClass);

        if (isConfirmation) {
            const confirmTextElement = document.createElement('p');
            confirmTextElement.innerHTML = confirmationContent;
            contentDiv.insertBefore(confirmTextElement, errorEl); // Insert text before error placeholder
        } else {
            const newLabel = document.createElement('label');
            newLabel.htmlFor = 'promptInput';
            newLabel.id = 'promptLabel';
            newLabel.innerText = label;

            const newInput = document.createElement('input');
            newInput.type = inputType;
            newInput.id = 'promptInput';
            newInput.name = 'promptInput';
            newInput.placeholder = placeholder;
            newInput.value = initialValue;
            // Apply base input classes dynamically based on theme for robustness
             const theme = document.documentElement.getAttribute('data-theme') || 'dark';
             const baseInputClasses = "w-full p-3 rounded-lg border transition-colors duration-200 focus:outline-none focus:ring-2";
             const themeInputClasses = theme === 'light'
                ? "bg-gray-100 border-gray-300 text-gray-900 focus:border-blue-400 focus:ring-blue-200"
                : "bg-gray-700 border-gray-600 text-white focus:border-blue-500 focus:ring-blue-400 focus:ring-opacity-50";
             newInput.className = `${baseInputClasses} ${themeInputClasses}`;

            contentDiv.insertBefore(newLabel, errorEl);
            contentDiv.insertBefore(newInput, errorEl);
        }

        confirmBtn.innerText = confirmText;
        cancelBtn.innerText = cancelText;

        currentPromptCallback = callback;
        currentCancelCallback = null; // Reset cancel callback initially

        confirmBtn.onclick = () => {
            if (currentPromptCallback) {
                const value = isConfirmation ? true : document.getElementById('promptInput')?.value;
                currentPromptCallback(value);
            }
        };
        cancelBtn.onclick = () => {
            hidePromptModal();
            if (currentCancelCallback) {
                currentCancelCallback();
            }
        };

        modal.style.display = 'flex';
        if (!isConfirmation) {
            document.getElementById('promptInput')?.focus();
        }
        console.log(`Prompt modal shown: ${title}`);
    }

    function hidePromptModal() {
        const modal = document.getElementById('promptModal');
        if (modal) modal.style.display = 'none';
        currentPromptCallback = null;
        currentCancelCallback = null;
        console.log("Prompt modal hidden.");
    }

    function showPromptError(message) {
        const errorElement = document.getElementById('promptError');
        if(errorElement) errorElement.innerText = message;
        else console.error("Prompt error element not found to display:", message);
    }

    // --- Upload Success Popup ---
    function showUploadSuccessPopup(publicId, title, uploader) {
         console.log(`Showing success popup for ${publicId}, Title: ${title}, Uploader: ${uploader}`);
         const finalTitle = title || formatTitle(publicId);
         const finalUploader = uploader || 'Anonymous';
         const titleSpan = document.getElementById('successVideoTitle');
         const uploaderSpan = document.getElementById('successUploaderName');
         const popup = document.getElementById('uploadSuccessPopup');

         if (titleSpan) titleSpan.innerText = finalTitle;
         if (uploaderSpan) uploaderSpan.innerText = finalUploader;
         if (popup) popup.style.display = 'flex';
    }

     function closeSuccessPopupAndRefresh() {
        console.log("Closing success popup.");
        const popup = document.getElementById('uploadSuccessPopup');
        if (popup) popup.style.display = 'none';
        // Refresh is now handled after post-upload modal save/skip
    }

    // --- Theme Toggle ---
    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute("data-theme");
      const newTheme = currentTheme === "dark" ? "light" : "dark";
      html.setAttribute("data-theme", newTheme);
      console.log(`Theme toggled to: ${newTheme}`);
      // Re-apply active filter style
      const activeButton = document.querySelector('.filter-btn.active-filter');
      if (activeButton) {
            const filterType = activeButton.id.split('-').pop(); // e.g., 'recent'
            setActiveFilter(activeButton, filterType, true); // Re-apply class without loading data
      }
       // Update input styles in modals IF they are currently open
       document.querySelectorAll('.modal-box input[type="text"], .modal-box input[type="password"], .modal-box textarea').forEach(input => {
           if (input.closest('.modal-backdrop').style.display === 'flex') {
                const baseInputClasses = "w-full p-3 rounded-lg border transition-colors duration-200 focus:outline-none focus:ring-2";
                const themeInputClasses = newTheme === 'light'
                    ? "bg-gray-100 border-gray-300 text-gray-900 focus:border-blue-400 focus:ring-blue-200"
                    : "bg-gray-700 border-gray-600 text-white focus:border-blue-500 focus:ring-blue-400 focus:ring-opacity-50";
                input.className = `${baseInputClasses} ${themeInputClasses}`;
           }
       });
    }

    // --- Upload Logic ---
    function showUploadPopup() {
        console.log("Showing upload popup.");
        document.getElementById("uploaderNameInput").value = '';
        document.getElementById("deletePassword").value = '';
        document.getElementById("progressBar").style.width = '0%';
        document.getElementById("progressContainer").style.display = 'none'; // Hide progress initially
        document.getElementById("uploadStatus").innerText = '';
        document.getElementById("uploadPopup").style.display = "flex";
    }

    function hideUploadPopup() {
        console.log("Hiding upload popup.");
        document.getElementById("uploadPopup").style.display = "none";
    }

    function openCloudinaryUpload() {
        const uploaderName = document.getElementById("uploaderNameInput").value.trim() || 'Anonymous';
        const delPass = document.getElementById("deletePassword").value.trim();
        const progressBar = document.getElementById("progressBar");
        const progressContainer = document.getElementById("progressContainer"); // Get container
        const status = document.getElementById("uploadStatus");

        if (!delPass) {
            status.innerText = "❌ Deletion password is required.";
            console.warn("Upload attempt failed: No deletion password.");
            return;
        }

        status.innerText = 'Initializing...';
        progressBar.style.width = '0%';
        progressContainer.style.display = 'block'; // Show progress bar container

        console.log(`Starting Cloudinary upload. Uploader: ${uploaderName}`);

        cloudinary.openUploadWidget({
            cloudName, uploadPreset,
            sources: ['local', 'url', 'camera'], // Added more sources
            resourceType: 'video',
            multiple: false, // Keep false for simplicity until stable
            clientAllowedFormats: ['mp4', 'webm', 'mov'],
            maxFileSize: 300000000, // 300MB limit
            folder: 'gs_overlay_vault',
            theme: document.documentElement.getAttribute("data-theme") || "dark", // Match theme
            styles: { // Customize widget appearance slightly
                palette: {
                    window: document.documentElement.getAttribute("data-theme") === "light" ? "#FFFFFF" : "#1F1F1F",
                    windowBorder: document.documentElement.getAttribute("data-theme") === "light" ? "#CCCCCC" : "#333333",
                    tabIcon: "#00FF88",
                    menuIcons: "#00CCFF",
                    textDark: document.documentElement.getAttribute("data-theme") === "light" ? "#000000" : "#FFFFFF",
                    textLight: document.documentElement.getAttribute("data-theme") === "light" ? "#333333" : "#CCCCCC",
                    link: "#00FF88",
                    action: "#00CCFF",
                    inactiveTabIcon: "#888888",
                    error: "#FF5555",
                    inProgress: "#00CCFF",
                    complete: "#00FF88",
                    sourceBg: document.documentElement.getAttribute("data-theme") === "light" ? "#F8F9FA" : "#0A0A0A"
                },
                fonts: { default: "'Roboto', sans-serif" }
            }
        }, (error, result) => {
             if (error) {
                console.error("Cloudinary Widget Error:", error);
                status.innerText = `❌ Upload failed: ${error.message || 'Unknown error'}`;
                progressBar.style.width = '0%';
                progressContainer.style.display = 'none';
                // Don't hide popup immediately on error, let user see message
            } else if (result && result.event) {
                 console.log("Cloudinary Widget Event:", result.event, result.info || ''); // Log all events

                 switch (result.event) {
                     case "uploadprogress":
                         const percent = Math.round((result.info.bytes_uploaded / result.info.total_bytes) * 100);
                         progressBar.style.width = `${percent}%`;
                         status.innerText = `Uploading... ${percent}%`;
                         break;
                     case "success":
                         console.log("Upload Success! Public ID:", result.info.public_id);
                         status.innerText = `✅ Processing...`; // Indicate post-upload step
                         progressBar.style.width = '100%';

                         // Prepare data for the next step (post-upload modal)
                         postUploadData = {
                             publicId: result.info.public_id,
                             originalFilename: result.info.original_filename,
                             uploaderName: uploaderName // Use name entered before upload
                         };

                         // Store essential info immediately
                         localStorage.setItem(`pass_${result.info.public_id}`, delPass);
                          uploaderNames[result.info.public_id] = uploaderName;
                          localStorage.setItem('uploaderNames', JSON.stringify(uploaderNames));
                          console.log(`Stored password and uploader name for ${result.info.public_id}`);

                         // IMPORTANT: Don't hide the upload popup yet. The widget might close itself.
                         // The 'close' or 'queue-finished' event will trigger the next modal.
                         break;
                     case "close":
                         console.log("Widget Closed.");
                          // Only proceed if an upload was successful before closing
                         if (postUploadData) {
                             hideUploadPopup();
                             showPostUploadDetailsModal(postUploadData);
                             postUploadData = null; // Clear temp data after use
                         } else {
                              // Widget closed without a successful upload (or error occurred)
                              // Optionally hide popup if status indicates no success
                              if (status.innerText.includes('failed') || status.innerText.includes('Initializing')) {
                                  status.innerText = 'Upload cancelled or failed.';
                                  progressContainer.style.display = 'none';
                              }
                         }
                         break;
                     case "queue-finished":
                         // This often fires along with 'close' when uploads are done.
                         console.log("Upload queue finished.");
                         // Handle potential race conditions: only show modal if not already shown by 'close'
                         if (postUploadData) {
                             hideUploadPopup();
                             showPostUploadDetailsModal(postUploadData);
                              postUploadData = null; // Clear temp data
                         }
                         break;
                 }
            }
        });
    }


    // --- Post-Upload Details Modal Logic ---
    function showPostUploadDetailsModal(data) {
        console.log("Showing post-upload details modal for:", data);
        postUploadData = data; // Store data for saving later
        const modal = document.getElementById('postUploadDetailsModal');
        const titleInput = document.getElementById('postUploadTitleInput');
        const uploaderNameSpan = document.getElementById('postUploadUploaderName');
        const errorMsg = document.getElementById('postUploadError');
        const saveBtn = document.getElementById('postUploadSaveBtn'); // Get save button

        if (!modal || !titleInput || !uploaderNameSpan || !errorMsg || !saveBtn) {
            console.error("Post Upload Modal elements not found!");
            return;
        }

        // Pre-fill title suggestion based on formatted public ID
        titleInput.value = formatTitle(data.publicId);
        uploaderNameSpan.textContent = data.uploaderName || 'Anonymous';
        errorMsg.textContent = '';
        saveBtn.disabled = false; // Ensure save button is enabled

        modal.style.display = 'flex';
        titleInput.focus();
    }

    function savePostUploadDetails() {
        console.log("Attempting to save post-upload details.");
        if (!postUploadData) {
            console.error("Cannot save details: postUploadData is missing.");
            showPromptError("An error occurred. Please try uploading again."); // Show error in the modal
            return;
        }

        const titleInput = document.getElementById('postUploadTitleInput');
        const errorMsg = document.getElementById('postUploadError');
        const saveBtn = document.getElementById('postUploadSaveBtn'); // Get save button
        const newTitle = titleInput.value.trim();

        if (!newTitle) {
            errorMsg.textContent = "Video title cannot be empty.";
            console.warn("Save failed: Title is empty.");
            return;
        }

        console.log(`Saving title "${newTitle}" for ${postUploadData.publicId}`);
        saveBtn.disabled = true; // Prevent double clicks
        errorMsg.textContent = ''; // Clear previous errors

        // Save the title
        renamedTitles[postUploadData.publicId] = newTitle;
        localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));
        console.log("Title saved to localStorage.");

        // Uploader name was already saved during upload success event
        closePostUploadModal(false); // false = not skipped
        showUploadSuccessPopup(postUploadData.publicId, newTitle, postUploadData.uploaderName); // Show final success
        loadVideos(true); // Refresh the gallery
    }

    function closePostUploadModal(skipped = false) {
        console.log(`Closing post-upload modal. Skipped: ${skipped}`);
        const modal = document.getElementById('postUploadDetailsModal');
        if(modal) modal.style.display = 'none';

        if (skipped && postUploadData) {
            console.log("Title skipped. Showing success popup with default title.");
            // Title was not saved, show success popup with default title/name
             showUploadSuccessPopup(postUploadData.publicId, formatTitle(postUploadData.publicId), postUploadData.uploaderName);
             loadVideos(true); // Refresh gallery even if skipped
        }
        // Always clear the temporary data when the modal closes
        postUploadData = null;
    }


    // --- Filtering Logic ---
    function setActiveFilter(buttonElement, filterType, preventLoad = false) {
        console.log(`Setting active filter to: ${filterType}, Prevent load: ${preventLoad}`);
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter', 'bg-green-500', 'text-black', 'dark:bg-green-400', 'dark:text-black', 'border-gray-800', 'dark:border-white')); // Remove specific active styles too
        buttonElement.classList.add('active-filter');
         // Add theme-aware active styles
        const theme = document.documentElement.getAttribute('data-theme') || 'dark';
        if (theme === 'light') {
             buttonElement.classList.add('bg-indigo-600', 'text-white'); // Example light theme active
        } else {
             buttonElement.classList.add('bg-green-400', 'text-black'); // Dark theme active
        }


        currentFilter = filterType;
        // Don't reset search when changing filter, let search persist
        // document.getElementById('search').value = '';
        // currentSearchQuery = '';

        if (!preventLoad) {
             loadVideos(true); // Reset and load based on new filter
        }
    }

    // --- Video Loading & Rendering ---
     async function loadVideos(reset = false) {
        const gallery = document.getElementById("gallery");
        const loadMoreBtn = document.getElementById('loadMoreBtn');

         if (!gallery || !loadMoreBtn) {
             console.error("Gallery or Load More button not found.");
             return;
         }

        if (reset) {
            console.log("Resetting video list and gallery.");
            allVideos = [];
            displayedVideos = [];
            currentVideoIndex = 0;
            gallery.innerHTML = '<p class="text-center w-full col-span-full text-lg p-8">🔄 Loading videos...</p>';
            loadMoreBtn.style.display = 'none';
            loadMoreBtn.disabled = true;
        } else {
             console.log("Loading more videos (not resetting).");
        }

        try {
             if (reset || allVideos.length === 0) {
                 console.log("Fetching video list from server...");
                 const res = await fetch(`/videos`);
                 if (!res.ok) {
                     const errorText = await res.text();
                     console.error("Server Error Response:", errorText);
                     throw new Error(`Failed to fetch videos: ${res.status} ${res.statusText}`);
                 }
                 const data = await res.json();
                  if (!Array.isArray(data)) {
                    console.error("Invalid video data received:", data);
                    throw new Error("Invalid data format received from server.");
                }
                allVideos = data;
                console.log(`Fetched ${allVideos.length} total videos.`);
             }

            sortVideos(); // Apply current sort order to allVideos

            const filteredVideos = applySearchFilter(allVideos);
            console.log(`Filtered down to ${filteredVideos.length} videos based on search "${currentSearchQuery}".`);

            if (reset) {
                 gallery.innerHTML = ''; // Clear loading message
                 displayedVideos = [];
                 currentVideoIndex = 0;
            }

            renderVideoBatch(filteredVideos); // Render the appropriate batch


        } catch (error) {
            console.error("Error loading videos:", error);
            gallery.innerHTML = `<p class="text-center w-full col-span-full text-red-500 p-8">❌ Error loading videos: ${error.message}</p>`;
             loadMoreBtn.style.display = 'none';
        }
    }

    function sortVideos() {
        console.log(`Sorting all ${allVideos.length} videos by: ${currentFilter}`);
        switch (currentFilter) {
            case 'popular':
                 console.warn("Popularity sorting not implemented, using random.");
                 allVideos.sort(() => Math.random() - 0.5);
                break;
            // case 'relevant': // Removed relevance filter for now
            //     console.warn("Relevance sorting defaults to recent.");
            //     allVideos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            //    break;
            case 'recent':
            default:
                allVideos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                break;
        }
    }

    function applySearchFilter(videos) {
        if (!currentSearchQuery) return videos;
        const query = currentSearchQuery.toLowerCase();
        return videos.filter(video => {
            const publicId = video.public_id;
            const title = (renamedTitles[publicId] || formatTitle(publicId)).toLowerCase();
            const uploader = (uploaderNames[publicId] || '').toLowerCase();
            return title.includes(query) || uploader.includes(query);
        });
    }


    function renderVideoBatch(sourceVideoList) {
        const gallery = document.getElementById("gallery");
        const loadMoreBtn = document.getElementById('loadMoreBtn');
         if (!gallery || !loadMoreBtn) return;

        const fragment = document.createDocumentFragment();
        const nextBatchEndIndex = Math.min(currentVideoIndex + videosPerLoad, sourceVideoList.length);
        const batch = sourceVideoList.slice(currentVideoIndex, nextBatchEndIndex);

        console.log(`Rendering batch: index ${currentVideoIndex} to ${nextBatchEndIndex-1} (out of ${sourceVideoList.length})`);

         if (currentVideoIndex === 0 && batch.length === 0) {
            const message = currentSearchQuery
                 ? `📪 No videos found matching "${currentSearchQuery}". Try a different search?`
                 : '📪 No videos found in the vault yet. Be the first to upload!';
             gallery.innerHTML = `<p class="text-center w-full col-span-full text-lg p-8">${message}</p>`;
             loadMoreBtn.style.display = 'none';
             return;
         }

        batch.forEach(file => {
            const publicId = file.public_id;
            // Ensure safeId handles potential special characters in folder names if any
            const safeId = publicId.replace(/[^a-zA-Z0-9_]/g, '_');
            const title = renamedTitles[publicId] || formatTitle(publicId);
            const uploader = uploaderNames[publicId] || 'Anonymous';
            const videoUrl = `https://res.cloudinary.com/${cloudName}/video/upload/q_auto:eco/v1/${publicId}.mp4`;
            const thumbnailUrl = `https://res.cloudinary.com/${cloudName}/video/upload/w_300,h_180,c_fill,q_auto,so_1/v1/${publicId}.jpg`; // Adjusted height

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="video-container" onclick="togglePlay(this.querySelector('video'))">
                    <video muted playsinline loop preload="metadata" poster="${thumbnailUrl}">
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                <div class="card-content">
                    <div class="card-title" title="${title}">${title}</div>
                    <div class="uploader-name" title="Uploaded by ${uploader}">by ${uploader}</div>
                </div>
                <div class="card-footer">
                    <a href="${videoUrl}" download="${title.replace(/[^a-z0-9_\-\.]/gi, '_')}.mp4" class="download-btn" title="Download ${title}">
                         <i class="fas fa-download text-xs"></i><span class="ml-1">Download</span>
                    </a>
                    <button class="menu-btn" title="Video Options" onclick="toggleActionMenu(event, '${publicId}')">
                        <i class="fas fa-ellipsis-h"></i>
                    </button>
                </div>
                <!-- Action Popup Menu (Ensure ID is correct) -->
                <div class="action-popup" id="actionPopup_${safeId}">
                    <button onclick="triggerRename('${publicId}')"><i class="fas fa-pencil-alt fa-fw w-4"></i>Rename</button>
                    <button class="delete-action" onclick="triggerDelete('${publicId}')"><i class="fas fa-trash-alt fa-fw w-4"></i>Delete</button>
                </div>
            `;
            fragment.appendChild(card);
            // displayedVideos.push(file); // Not strictly needed if rendering from filtered list
        });

        gallery.appendChild(fragment);
        currentVideoIndex = nextBatchEndIndex;

        // Update Load More button state
        if (currentVideoIndex < sourceVideoList.length) {
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.disabled = false;
            loadMoreBtn.textContent = 'Load More Videos';
        } else {
            loadMoreBtn.style.display = 'none';
            loadMoreBtn.disabled = true;
             console.log("All videos rendered.");
        }
    }

     function loadMoreVideos() {
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if(loadMoreBtn.disabled) return; // Prevent multiple clicks

        loadMoreBtn.disabled = true;
        loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...'; // Loading state
        console.log("Load More button clicked.");

        // Apply search filter to the full sorted list before getting the next batch
        const filteredVideos = applySearchFilter(allVideos);

        // Simulate network delay for smoother UX (optional)
        setTimeout(() => {
            renderVideoBatch(filteredVideos);
            // Button state is updated inside renderVideoBatch
        }, 300);
    }


    function formatTitle(publicId) {
        try {
            let name = publicId.includes('/') ? publicId.split('/').pop() : publicId;
            name = name.replace(/\.[^/.]+$/, ""); // Remove extension
            name = name.replace(/[_-]/g, ' ');
            // Basic capitalization (handle potential empty strings from split)
            return name.split(' ')
                       .map(word => word ? word.charAt(0).toUpperCase() + word.slice(1).toLowerCase() : '')
                       .join(' ')
                       .trim(); // Remove leading/trailing spaces
        } catch (e) {
            console.error("Error formatting title for:", publicId, e);
            return publicId; // Fallback
        }
    }

    // --- Video Card Actions ---

    function togglePlay(videoElement) {
         if (!videoElement) return;
         const container = videoElement.closest('.video-container');
         if (videoElement.paused) {
             videoElement.play().catch(e => console.error("Video play error:", e));
             videoElement.classList.add('playing'); // Add class to hide overlay
             if (container) container.classList.add('playing');
         } else {
             videoElement.pause();
             videoElement.classList.remove('playing');
             if (container) container.classList.remove('playing');
         }
     }


    function toggleActionMenu(event, publicId) {
        event.stopPropagation(); // Prevent card click/video play
        const safeId = publicId.replace(/[^a-zA-Z0-9_]/g, '_');
        const popup = document.getElementById(`actionPopup_${safeId}`);
        if (!popup) {
            console.error(`Action popup not found for safeId: actionPopup_${safeId}`);
            return;
        }
        console.log(`Toggling action menu for ${publicId} (safeId: ${safeId})`);

        // Close all other popups first
        document.querySelectorAll('.action-popup').forEach(p => {
            if (p.id !== popup.id) {
                p.style.display = 'none';
            }
        });

        // Toggle the target popup
        const isCurrentlyVisible = popup.style.display === 'block';
        popup.style.display = isCurrentlyVisible ? 'none' : 'block';
         console.log(`Popup ${popup.id} display set to: ${popup.style.display}`);
    }

    // Close action menus if clicking outside
    document.addEventListener('click', function(event) {
        const openPopup = document.querySelector('.action-popup[style*="display: block"]');
        // Ensure the click target is not inside an open popup AND not the menu button itself
        if (openPopup && !openPopup.contains(event.target) && !event.target.closest('.menu-btn')) {
            console.log("Clicked outside open action menu, closing it.");
            openPopup.style.display = 'none';
        }
    });

    // --- Password Protected Actions ---
    function getPasswordAndExecute(publicId, actionCallback) {
        const storedPass = localStorage.getItem(`pass_${publicId}`);
        if (!storedPass) {
            console.error(`No password found in localStorage for ${publicId}.`);
            alert("Error: No deletion password found locally for this video. Cannot perform action. (Password might be lost if browser data was cleared).");
            return;
        }
        console.log(`Password found for ${publicId}, showing prompt.`);

        showPromptModal({
            title: "Password Required",
            label: "Enter the password set during upload:",
            inputType: 'password',
            confirmText: 'Verify',
            callback: (enteredPassword) => {
                if (enteredPassword === storedPass) {
                    console.log(`Password verified for ${publicId}.`);
                    hidePromptModal();
                    actionCallback(); // Execute the action
                } else {
                    console.warn(`Incorrect password entered for ${publicId}.`);
                    showPromptError('Incorrect password. Please try again.');
                    // Keep the modal open
                }
            }
        });
    }

    function triggerRename(publicId) {
        console.log(`Triggering rename for ${publicId}`);
        const safeId = publicId.replace(/[^a-zA-Z0-9_]/g, '_');
        const popup = document.getElementById(`actionPopup_${safeId}`);
        if (popup) popup.style.display = 'none';

        getPasswordAndExecute(publicId, () => {
            proceedWithRename(publicId);
        });
    }

    function proceedWithRename(publicId) {
        console.log(`Proceeding with rename modal for ${publicId}`);
        const currentTitle = renamedTitles[publicId] || formatTitle(publicId);
        showPromptModal({
            title: "Rename Video",
            label: `Enter new title:`,
            inputType: 'text',
            placeholder: "New video title",
            initialValue: currentTitle, // Pre-fill
            confirmText: 'Save Name',
            callback: (newTitleInput) => {
                 const newTitle = newTitleInput?.trim(); // Optional chaining and trim
                if (newTitle && newTitle !== currentTitle) {
                     console.log(`Saving new title "${newTitle}" for ${publicId}`);
                    renamedTitles[publicId] = newTitle;
                    localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));

                    // Update DOM
                    const titleElement = document.querySelector(`.card-title[data-id="${publicId}"]`); // Target title div more specifically if needed
                    if (titleElement) {
                        titleElement.textContent = newTitle;
                        titleElement.setAttribute('title', newTitle);
                    }
                     const downloadLink = document.querySelector(`a[href*="${publicId}"].download-btn`);
                     if(downloadLink) {
                         downloadLink.download = `${newTitle.replace(/[^a-z0-9_\-\.]/gi, '_')}.mp4`;
                         downloadLink.title = `Download ${newTitle}`;
                     }
                    hidePromptModal();
                } else if (!newTitle) {
                    showPromptError("Title cannot be empty.");
                     console.warn("Rename failed: Title empty.");
                } else {
                     showPromptError("New title is the same as the current title.");
                     console.warn("Rename skipped: Title unchanged.");
                     // Optionally just close: hidePromptModal();
                }
            }
        });
    }


    function triggerDelete(publicId) {
         console.log(`Triggering delete for ${publicId}`);
        const safeId = publicId.replace(/[^a-zA-Z0-9_]/g, '_');
        const popup = document.getElementById(`actionPopup_${safeId}`);
        if (popup) popup.style.display = 'none'; // Close menu

        getPasswordAndExecute(publicId, () => {
            proceedWithDelete(publicId);
        });
    }

    function proceedWithDelete(publicId) {
         console.log(`Proceeding with delete confirmation for ${publicId}`);
        const title = renamedTitles[publicId] || formatTitle(publicId);
        // Find card using a more specific selector if needed
        const cardToDelete = document.querySelector(`.card:has(.card-title[data-id="${publicId}"])`); // Example using :has (check browser support) or traverse from title

        showPromptModal({
            isConfirmation: true,
            title: "Confirm Deletion",
            confirmationContent: `Are you sure you want to permanently delete "<strong>${title}</strong>"?<br>This action cannot be undone.`,
            confirmText: "Delete Forever",
            cancelText: "Cancel",
            confirmClass: 'modal-button-delete bg-red-600 hover:bg-red-700', // More specific class
            callback: (confirmed) => {
                if (confirmed) {
                    console.log(`Deletion confirmed for ${publicId}`);
                    hidePromptModal();
                    if (cardToDelete) {
                         cardToDelete.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                         cardToDelete.style.opacity = '0';
                         cardToDelete.style.transform = 'scale(0.9)';
                         // Remove after animation
                         setTimeout(() => cardToDelete.remove(), 500);
                    } else {
                         console.warn("Card element not found for deletion animation/removal.");
                    }

                    fetch(`/delete/${encodeURIComponent(publicId)}`, { method: "DELETE" })
                        .then(async response => { // Use async for await inside
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({ message: `Server error: ${response.status} ${response.statusText}` }));
                                throw new Error(errorData.message);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Delete API response:", data);
                            if (data.status === "success") {
                                console.log(`Successfully deleted ${publicId} from server.`);
                                // Clean up local storage
                                localStorage.removeItem(`pass_${publicId}`);
                                delete renamedTitles[publicId];
                                delete uploaderNames[publicId];
                                localStorage.setItem('renamedTitles', JSON.stringify(renamedTitles));
                                localStorage.setItem('uploaderNames', JSON.stringify(uploaderNames));

                                // Remove from local data arrays
                                allVideos = allVideos.filter(v => v.public_id !== publicId);
                                displayedVideos = displayedVideos.filter(v => v.public_id !== publicId);

                                // Maybe show a subtle toast notification instead of alert
                                // alert(data.message || "Video deleted successfully.");
                            } else {
                                throw new Error(data.message || "Deletion failed according to server response.");
                            }
                        })
                        .catch(err => {
                             console.error("Deletion failed:", err);
                             alert(`Failed to delete video: ${err.message}`);
                             // Restore card if deletion failed and it wasn't removed yet
                             if (cardToDelete && cardToDelete.style.opacity === '0') {
                                 cardToDelete.style.opacity = '1';
                                 cardToDelete.style.transform = 'scale(1)';
                             } else {
                                 // If card was removed optimistically, we might need to refresh
                                 loadVideos(true);
                             }
                        });
                } else {
                     console.log(`Deletion cancelled for ${publicId}`);
                     hidePromptModal();
                }
            }
        });
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
       console.log("DOM Content Loaded.");
       handleIntro(); // Start intro animation first
       // Terms check and page init will happen after intro fades out
    });

  </script>

</body>
</html>
